<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>营营无忧门店智能体 - 统一工作台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: #0f1419;
      --bg-card: #1a2332;
      --bg-elevated: #243044;
      --accent: #00c896;
      --accent-dim: rgba(0, 200, 150, 0.15);
      --accent-soft: #00e6a8;
      --text-primary: #f0f4f8;
      --text-secondary: #8b9cb3;
      --text-muted: #5c6b7e;
      --border: rgba(139, 156, 179, 0.12);
      --danger: #ff6b6b;
      --warning: #ffb347;
      --success: #00c896;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      overflow: hidden;
    }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(0, 200, 150, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 200, 150, 0.03) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events: none;
    }

    .app {
      display: flex;
      height: 100vh;
      min-height: 0;
      overflow: hidden;
      position: relative;
    }

    /* 侧栏 */
    .sidebar {
      width: 240px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 20px 0;
      flex-shrink: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .sidebar-logo {
      flex-shrink: 0;
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .sidebar-nav {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 16px 0;
    }
    .sidebar-user { flex-shrink: 0; }
    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent) 0%, #00a67e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
    }
    .logo-text h1 { font-size: 16px; font-weight: 600; }
    .logo-text span { font-size: 11px; color: var(--text-muted); }
    .nav-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 10px 20px 8px;
      letter-spacing: 0.02em;
    }
    .nav-sublabel {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 8px 20px 6px 28px;
      letter-spacing: 0.02em;
    }
    .nav-sublabel[data-toggle] {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .nav-sublabel[data-toggle]:hover { color: var(--text-secondary); }
    .nav-sublabel .chevron { font-size: 10px; transition: transform 0.2s; opacity: 0.7; }
    .nav-sublabel.collapsed .chevron { transform: rotate(-90deg); }
    .nav-subsection-content {
      overflow: hidden;
      transition: max-height 0.25s ease;
      max-height: 140px;
    }
    .nav-subsection-content.collapsed {
      max-height: 0 !important;
      overflow: hidden;
    }
    .nav-item-sub { padding-left: 28px; }
    .nav-label[data-toggle] {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .nav-label[data-toggle]:hover { color: var(--text-secondary); }
    .nav-label .chevron {
      font-size: 10px;
      transition: transform 0.2s;
      opacity: 0.7;
    }
    .nav-label.collapsed .chevron {
      transform: rotate(-90deg);
    }
    .nav-section-content {
      overflow: hidden;
      transition: max-height 0.25s ease;
      max-height: 80px;
    }
    #auto-section { max-height: 300px; }
    #tool-section { max-height: 200px; }
    .nav-section-content.collapsed {
      max-height: 0 !important;
      overflow: hidden;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      font-size: 14px;
    }
    .nav-item:hover {
      background: rgba(255,255,255,0.04);
    }
    .nav-item.active {
      background: var(--accent-dim);
      border-left-color: var(--accent);
      color: var(--accent);
    }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
    .sidebar-history {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    .sidebar-history .nav-label { padding-left: 0; }
    .create-chat-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      background: var(--accent-dim);
      border: 1px dashed rgba(0, 200, 150, 0.4);
      border-radius: 10px;
      color: var(--accent);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .create-chat-btn:hover {
      background: rgba(0, 200, 150, 0.2);
      border-color: var(--accent);
    }
    .history-item {
      padding: 10px 12px;
      background: var(--bg-elevated);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .history-item { position: relative; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .history-item:hover { border-color: var(--border); }
    .history-item-text { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .history-item-delete { flex-shrink: 0; width: 20px; height: 20px; padding: 0; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 4px; font-size: 16px; line-height: 1; opacity: 0; transition: opacity 0.2s, color 0.2s; display: flex; align-items: center; justify-content: center; }
    .history-item:hover .history-item-delete { opacity: 1; }
    .history-item-delete:hover { color: var(--danger); background: rgba(255, 107, 107, 0.1); }
    .history-item[data-scene].active {
      background: var(--accent-dim);
      border-color: rgba(0, 200, 150, 0.3);
      color: var(--accent);
    }
    .sidebar-user {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .user-info { font-size: 13px; }
    .user-info .name { font-weight: 500; }
    .user-info .role { font-size: 11px; color: var(--text-muted); }

    /* 主区 */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }
    .main-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      min-height: 56px;
      box-sizing: border-box;
    }
    .main-header > div:first-child {
      min-height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .main-header h2 { font-size: 18px; font-weight: 600; line-height: 1.3; }
    .main-header .subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; line-height: 1.3; }
    .search-bar {
      display: flex;
      gap: 10px;
    }
    .search-input {
      width: 280px;
      padding: 10px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
    }
    .search-input::placeholder { color: var(--text-muted); }
    .btn-ask {
      padding: 10px 20px;
      background: var(--accent);
      color: var(--bg-main);
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-ask:hover { background: var(--accent-soft); }

    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    /* 对话场景激活时：固定布局，问答区内部滚动 */
    .main-content.chat-mode {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 0;
    }
    .main-content.chat-mode .content-left {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .main-content.chat-mode .content-left .scene-panel.chat-layout.active {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    .content-left {
      flex: 1;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    /* 场景面板 */
    .scene-panel {
      display: none;
      animation: fadeIn 0.3s ease;
      width: 100%;
    }
    .scene-panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .quick-asks {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .quick-ask {
      padding: 10px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quick-ask:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .user-bubble {
      display: inline-block;
      padding: 12px 24px;
      background: var(--accent);
      color: var(--bg-main);
      border-radius: 24px;
      font-size: 14px;
      margin-bottom: 16px;
      max-width: 90%;
    }
    .ai-reply {
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--accent);
    }
    .ai-reply .summary {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .ai-reply .detail {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .kpi-card {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .kpi-card.blue { background: rgba(0, 200, 150, 0.1); border: 1px solid rgba(0, 200, 150, 0.3); }
    .kpi-card.green { background: rgba(0, 200, 150, 0.08); border: 1px solid rgba(0, 200, 150, 0.25); }
    .kpi-card.orange { background: rgba(255, 179, 71, 0.1); border: 1px solid rgba(255, 179, 71, 0.3); }
    .kpi-card.red { background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); }
    .kpi-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .kpi-value { font-size: 20px; font-weight: 700; }
    .kpi-change { font-size: 12px; margin-top: 4px; }
    .kpi-card.blue .kpi-value, .kpi-card.blue .kpi-change { color: var(--accent); }
    .kpi-card.green .kpi-value, .kpi-card.green .kpi-change { color: var(--success); }
    .kpi-card.orange .kpi-value { color: var(--warning); }
    .kpi-card.red .kpi-value { color: var(--danger); }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .data-table th, .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .data-table th { color: var(--text-muted); font-weight: 500; }
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--accent);
      color: var(--bg-main);
      font-weight: 500;
    }
    .btn-primary:hover { background: var(--accent-soft); }
    .btn-ghost {
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.1); }
    /* ops-btn 通用样式（用于配置弹窗等非 docflow-ops-item 场景） */
    .ops-btn {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .ops-btn:hover { border-color: var(--accent); color: var(--accent); }
    .ops-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-main);
    }
    .ops-btn.primary:hover { background: var(--accent-soft); border-color: var(--accent-soft); }
    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .input-area input {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 13px;
    }
    .input-area input::placeholder { color: var(--text-muted); }
    .input-area .btn { padding: 12px 24px; }
    /* 对话场景：统一交互风格，问答区内部滚动 */
    .scene-panel.chat-layout.active {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    .scene-panel.chat-layout .chat-body {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 32px 40px 24px;
    }
    .scene-panel.chat-layout .chat-messages {
      display: flex;
      flex-direction: column;
      gap: 24px;
      max-width: 900px;
      margin: 0 auto;
    }
    .scene-panel.chat-layout .chat-msg-user {
      display: flex;
      justify-content: flex-end;
    }
    .scene-panel.chat-layout .user-bubble {
      max-width: 75%;
      margin: 0;
    }
    .scene-panel.chat-layout .chat-msg-ai {
      display: flex;
      justify-content: flex-start;
    }
    .scene-panel.chat-layout .ai-reply-box {
      width: 100%;
      max-width: 100%;
      background: var(--bg-elevated);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .scene-panel.chat-layout .ai-reply-header {
      padding: 16px 24px;
      background: linear-gradient(90deg, var(--accent-dim) 0%, transparent 100%);
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
    }
    .scene-panel.chat-layout .ai-reply-content {
      padding: 24px 28px 28px;
      font-size: 14px;
      line-height: 1.65;
    }
    .scene-panel.chat-layout .ai-reply-content .summary,
    .scene-panel.chat-layout .ai-reply-content .detail {
      margin-bottom: 12px;
    }
    .scene-panel.chat-layout .ai-reply-content .detail:last-child {
      margin-bottom: 0;
    }
    .scene-panel.chat-layout .ai-reply-content .finance-item {
      margin-bottom: 12px;
    }
    .scene-panel.chat-layout .ai-reply-content .finance-item:last-child {
      margin-bottom: 0;
    }
    .scene-panel.chat-layout .chat-input-bar {
      flex-shrink: 0;
      padding: 20px 40px 32px;
      background: var(--bg-main);
      border-top: 1px solid var(--border);
    }
    .scene-panel.chat-layout .chat-input-bar .input-area {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
    }
    .scene-panel.chat-layout .chat-input-bar .input-area input {
      flex: 1;
      padding: 16px 24px;
      font-size: 15px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .scene-panel.chat-layout .chat-input-bar .input-area .btn {
      padding: 16px 32px;
      font-size: 15px;
      border-radius: 12px;
    }

    /* 仪表盘布局：左右两栏，比例优化 */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 28px;
      align-items: start;
      min-height: 0;
    }
    .dashboard-left {
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-width: 0;
    }
    .dashboard-left .timeline-section,
    .dashboard-left .tomorrow-preview {
      width: 100%;
    }
    .dashboard-right {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .dashboard-right .ai-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .dashboard-right .ai-body {
      flex: 1;
      min-height: 280px;
      max-height: none;
    }
    /* ========== 首页样式：欢迎栏 + 操作指引（仅当 main-content.home-view 时生效，不影响其他模块） ========== */
    .main-content.home-view #scene-home {
      padding-bottom: 24px;
      overflow-y: auto;
      max-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .main-content.home-view #scene-home .home-welcome-bar {
      width: 100%;
      max-width: 480px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 0 24px;
      flex-wrap: wrap;
    }
    .main-content.home-view #scene-home .home-welcome-greeting {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .main-content.home-view #scene-home .home-greeting-line1,
    .main-content.home-view #scene-home .home-greeting-line2 {
      display: flex;
      align-items: baseline;
    }
    .main-content.home-view #scene-home .home-greeting-spacer {
      visibility: hidden;
    }
    .main-content.home-view #scene-home .greeting-yi {
      display: inline-block;
      background: linear-gradient(90deg, #00c896, #00e6a8, #7dd3fc, #a78bfa, #f472b6, #00c896);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: greeting-yi-flow 3s ease-in-out infinite;
    }
    @keyframes greeting-yi-flow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .main-content.home-view #scene-home .home-welcome-divider {
      font-size: 12px;
      color: rgba(139, 156, 179, 0.4);
    }
    .main-content.home-view #scene-home .home-welcome-date {
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
    }
    .main-content.home-view #scene-home .home-welcome-hint {
      margin-left: auto;
      font-size: 13px;
      color: rgba(0, 200, 150, 0.7);
    }
    .main-content.home-view #scene-home .home-guide-layout {
      flex: 1;
      width: 100%;
      max-width: 400px;
      display: flex;
      justify-content: center;
    }
    .main-content.home-view #scene-home .home-guide-panel {
      width: 100%;
    }
    .main-content.home-view #scene-home .home-guide-title {
      font-size: 17px;
      font-weight: 600;
      color: rgba(139, 156, 179, 0.6);
      margin-bottom: 16px;
      letter-spacing: 0.04em;
    }
    .main-content.home-view #scene-home .home-guide-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .main-content.home-view #scene-home .home-guide-item {
      display: flex;
      gap: 12px;
    }
    .main-content.home-view #scene-home .home-guide-num {
      flex-shrink: 0;
      font-size: 12px;
      font-weight: 500;
      font-family: 'JetBrains Mono', monospace;
      color: rgba(139, 156, 179, 0.35);
      letter-spacing: 0.04em;
    }
    .main-content.home-view #scene-home .home-guide-content h4 {
      font-size: 14px;
      font-weight: 500;
      color: rgba(139, 156, 179, 0.55);
      margin-bottom: 4px;
    }
    .main-content.home-view #scene-home .home-guide-content p {
      font-size: 13px;
      color: rgba(139, 156, 179, 0.4);
      line-height: 1.6;
    }
    .home-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .home-section-header h3 { margin-bottom: 0; }
    .home-section-actions { display: flex; gap: 8px; }
    .home-btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .home-btn-sm:hover { border-color: var(--accent); color: var(--accent); }
    .home-calendar-wrap {
      margin-top: 16px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .home-calendar-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .home-calendar-arrow {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .home-calendar-arrow:hover { border-color: var(--accent); color: var(--accent); }
    .home-calendar-month {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
    }
    .home-calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 10px;
      padding: 0 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
      letter-spacing: 0.08em;
    }
    .home-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      min-height: 260px;
    }
    .home-calendar-day {
      min-height: 72px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      gap: 6px;
      padding: 10px 8px;
      background: var(--bg-main);
      border: 1px solid rgba(139, 156, 179, 0.08);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .home-calendar-day.other-month .day-num { color: var(--text-muted); opacity: 0.7; }
    .home-calendar-day:hover:not(.past):not(.home-calendar-empty) {
      border-color: rgba(0, 200, 150, 0.4);
      background: rgba(0, 200, 150, 0.06);
      box-shadow: 0 2px 8px rgba(0, 200, 150, 0.12);
    }
    .home-calendar-day.today {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(0, 200, 150, 0.12) 0%, rgba(0, 200, 150, 0.06) 100%);
      box-shadow: 0 0 0 2px rgba(0, 200, 150, 0.2);
    }
    .home-calendar-day.today .day-num { color: var(--accent); }
    .home-calendar-day.past {
      cursor: default;
      opacity: 0.85;
    }
    .home-calendar-day.past:hover { border-color: rgba(139, 156, 179, 0.08); background: var(--bg-main); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
    .home-calendar-day.home-calendar-empty {
      background: transparent;
      border-color: transparent;
      box-shadow: none;
      cursor: default;
      min-height: 72px;
    }
    .home-calendar-day .day-num {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }
    .home-calendar-day .day-modules {
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 100%;
      flex: 1;
      min-height: 0;
    }
    .home-calendar-day .day-mod {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
      width: 100%;
    }
    .home-calendar-day .day-mod-item {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .home-calendar-day .day-mod-dot {
      display: inline-block;
      flex-shrink: 0;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--text-muted);
      opacity: 0.8;
    }
    .home-calendar-day .day-mod-dot.on {
      background: var(--accent);
      opacity: 1;
      box-shadow: 0 0 0 1px var(--accent-dim);
      animation: homeCalendarPulse 3s ease-in-out infinite;
    }
    @keyframes homeCalendarPulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 1px var(--accent-dim); }
      50% { opacity: 0.75; box-shadow: 0 0 0 3px rgba(0, 200, 150, 0.12); }
    }
    .home-calendar-legend {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
    }
    .home-legend-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    .home-legend-dot.on { background: var(--accent); }
    .home-legend-dot.off { background: var(--text-muted); opacity: 0.7; }
    .home-legend-hint { margin-left: auto; color: var(--text-muted); font-size: 11px; opacity: 0.8; }
    .home-sales-quick {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .home-sales-kpi {
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .home-sales-kpi .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .home-sales-kpi .value { font-size: 18px; font-weight: 700; }
    .home-sales-kpi .change { font-size: 12px; margin-top: 4px; }
    .home-sales-kpi .change.up { color: var(--accent); }
    .home-sales-kpi .change.down { color: var(--danger); }
    .home-quick-entries {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .home-quick-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .home-quick-entry:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .home-quick-entry .icon { font-size: 18px; }
    .home-bottom-row {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }
    .home-activity-list { display: flex; flex-direction: column; gap: 8px; }
    .home-activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    .home-activity-item .time { color: var(--text-muted); font-family: 'JetBrains Mono', monospace; min-width: 40px; }
    .home-activity-item .text { flex: 1; }
    .home-activity-item .action {
      color: var(--accent);
      cursor: pointer;
      font-weight: 500;
    }
    .home-activity-item .action:hover { text-decoration: underline; }
    .home-quick-ask .home-ask-input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-primary);
    }
    .home-quick-ask .home-ask-input::placeholder { color: var(--text-muted); }
    .home-ask-btns { display: flex; flex-wrap: wrap; gap: 8px; }
    .home-ask-btn {
      padding: 8px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .home-ask-btn:hover { border-color: var(--accent); color: var(--accent); }
    /* 首页日历弹窗 */
    .home-calendar-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .home-calendar-modal {
      width: 360px;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .home-calendar-modal h4 { font-size: 16px; margin-bottom: 20px; }
    .home-calendar-modal-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .home-calendar-modal-row:last-child { border-bottom: none; }
    .home-calendar-toggle {
      width: 44px;
      height: 24px;
      background: var(--text-muted);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .home-calendar-toggle.on { background: var(--accent); }
    .home-calendar-toggle::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
    }
    .home-calendar-toggle.on::after { transform: translateX(20px); }
    .home-calendar-modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    .trustee-calendar-layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 24px;
      min-height: 0;
      align-items: start;
    }
    .trustee-calendar-left { min-width: 0; }
    .trustee-calendar-right {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .trustee-calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .trustee-calendar-header h3 { font-size: 16px; font-weight: 600; }
    .trustee-calendar-actions { display: flex; gap: 8px; }
    .trustee-stats-panel {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .trustee-stats-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .trustee-stats-main {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .trustee-stats-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .trustee-stats-item.trustee-stats-highlight .trustee-stats-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    .trustee-stats-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .trustee-stats-value {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .trustee-stats-modules {
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .trustee-stats-modules-title {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .trustee-stats-module-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .trustee-stats-module {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .trustee-stats-module .trustee-module-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .trustee-stats-module .trustee-module-dot.on {
      background: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
      animation: homeCalendarPulse 3s ease-in-out infinite;
    }
    .trustee-stats-module .trustee-module-dot.off {
      background: var(--text-muted);
      box-shadow: none;
      animation: none;
    }
    .trustee-stats-footer {
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .trustee-stats-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--accent-dim);
      border: 1px solid rgba(0, 200, 150, 0.35);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--accent);
    }
    .trustee-stats-badge .ai-pulse {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: aiPulse 1.5s ease-in-out infinite;
    }
    .trustee-stats-badge.off {
      background: rgba(139, 156, 179, 0.15);
      border-color: rgba(139, 156, 179, 0.3);
      color: var(--text-muted);
    }
    .trustee-stats-badge.off .ai-pulse {
      background: var(--text-muted);
      animation: none;
    }
    @media (max-width: 1100px) {
      .trustee-calendar-layout { grid-template-columns: 1fr; }
    }
    .trustee-calendar-modal { width: 420px; }
    .trustee-modal-rows { display: flex; flex-direction: column; gap: 0; }
    .trustee-modal-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .trustee-modal-row:last-child { border-bottom: none; }
    .trustee-modal-row-shared { background: rgba(0, 200, 150, 0.06); border-radius: 8px; margin: 4px 0; padding: 12px 14px !important; }
    .trustee-modal-row-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .trustee-modal-row-extra {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-left: 8px;
    }
    .trustee-modal-label { font-size: 12px; color: var(--text-muted); min-width: 40px; }
    .trustee-modal-select {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
    }
    .trustee-modal-select:focus { outline: none; border-color: var(--accent); }
    .home-calendar-modal-actions button {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-family: inherit;
    }
    .home-calendar-modal-actions .btn-confirm { background: var(--accent); color: var(--bg-main); }
    .home-calendar-modal-actions .btn-ghost { background: var(--bg-elevated); color: var(--text-secondary); }
    @media (max-width: 900px) {
      .main-content.home-view #scene-home .home-welcome-bar { flex-direction: column; align-items: flex-start; gap: 6px; }
      .main-content.home-view #scene-home .home-welcome-hint { margin-left: 0; }
      .main-content.home-view #scene-home .home-guide-layout { max-width: 100%; }
      .main-content.home-view #scene-home .home-guide-list { gap: 12px; }
    }

    /* 概览行：执行状态 + 城市门店信息（同一行，门店信息靠右） */
    .dashboard-overview-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 16px 24px;
      margin-bottom: 24px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .dashboard-overview {
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .dashboard-ai-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: var(--accent-dim);
      border: 1px solid rgba(0, 200, 150, 0.35);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--accent);
    }
    .dashboard-ai-badge .ai-pulse,
    .inspection-badge .ai-pulse,
    .docflow-badge .ai-pulse {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: aiPulse 1.5s ease-in-out infinite;
    }
    .module-trustee-badge.off {
      background: rgba(139, 156, 179, 0.15);
      border-color: rgba(139, 156, 179, 0.3);
      color: var(--text-muted);
    }
    .module-trustee-badge.off .ai-pulse {
      background: var(--text-muted);
      animation: none;
    }
    @keyframes aiPulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 200, 150, 0.5); }
      50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(0, 200, 150, 0); }
    }
    .dashboard-store-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      margin-left: auto;
    }
    .dashboard-store-info .store-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dashboard-store-info .store-info-label {
      color: var(--text-muted);
      font-size: 12px;
    }
    .dashboard-store-info .store-info-divider {
      color: var(--border);
      font-size: 12px;
    }
    .dashboard-overview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .dashboard-overview-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .dashboard-overview-item .dot.done { background: var(--accent); }
    .dashboard-overview-item .dot.running { background: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
    .dashboard-overview-item .dot.pending { background: var(--text-muted); }
    .dashboard-overview-item strong { color: var(--accent); }
    /* 今日销售快览 */
    .dashboard-sales-quick-header {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dashboard-sales-quick-header::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
    }
    .dashboard-sales-quick {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .dashboard-sales-quick .sales-kpi {
      padding: 16px 20px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .dashboard-sales-quick .sales-kpi .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .dashboard-sales-quick .sales-kpi .value { font-size: 18px; font-weight: 700; }
    .dashboard-sales-quick .sales-kpi .change { font-size: 12px; margin-top: 4px; }
    .dashboard-sales-quick .sales-kpi .change.up { color: var(--accent); }
    .dashboard-sales-quick .sales-kpi .change.down { color: var(--danger); }
    /* 待办提醒 */
    .dashboard-pending {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      margin-bottom: 24px;
      background: rgba(255, 179, 71, 0.1);
      border: 1px solid rgba(255, 179, 71, 0.3);
      border-radius: 12px;
      font-size: 13px;
    }
    .dashboard-pending .pending-badge {
      padding: 4px 10px;
      background: var(--warning);
      color: var(--bg-main);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .dashboard-pending .pending-text { color: var(--text-primary); }
    .dashboard-pending .pending-action {
      margin-left: auto;
      color: var(--accent);
      cursor: pointer;
      font-weight: 500;
    }
    .dashboard-pending .pending-action:hover { text-decoration: underline; }
    .dashboard-pending-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }
    .dashboard-pending-wrap .dashboard-pending { margin-bottom: 0; }
    .dashboard-pending-secondary {
      background: rgba(255, 107, 107, 0.08);
      border-color: rgba(255, 107, 107, 0.25);
    }
    /* 快捷操作 */
    .dashboard-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }
    .dashboard-quick-actions .quick-action-btn {
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .dashboard-quick-actions .quick-action-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .dashboard-quick-actions .quick-action-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-main);
    }
    .dashboard-quick-actions .quick-action-btn.primary:hover { background: var(--accent-soft); }
    /* 时间线可点击 */
    .timeline-item { cursor: pointer; }
    .timeline-item:hover { background: rgba(255,255,255,0.04); }
    /* 时间线 */
    .timeline-section {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    .timeline-section .timeline {
      flex: 1;
      position: relative;
      padding-left: 0;
    }
    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .section-header h2 { font-size: 16px; font-weight: 600; }
    .timeline { padding: 20px 0; }
    .timeline-item {
      display: flex;
      gap: 20px;
      padding: 16px 24px;
      transition: background 0.2s;
      position: relative;
      z-index: 1;
    }
    .timeline-item:hover { background: rgba(255,255,255,0.02); }
    .timeline-item.completed { opacity: 0.7; }
    .timeline-item.running {
      background: var(--accent-dim);
      border-left: 3px solid var(--accent);
      margin-left: -3px;
    }
    .timeline-time {
      flex-shrink: 0;
      width: 56px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }
    .timeline-content { flex: 1; }
    .timeline-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
    .timeline-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
    .timeline-status { flex-shrink: 0; width: 24px; display: flex; align-items: center; justify-content: center; }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--text-muted);
      flex-shrink: 0;
      box-sizing: border-box;
    }
    .timeline-item.completed .status-dot { background: var(--accent); }
    .timeline-item.running .status-dot {
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-dim);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* AI 悬浮窗 */
    .ai-panel {
      position: sticky;
      top: 24px;
      height: fit-content;
    }
    .ai-window {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
    }
    .ai-window-header {
      padding: 20px 24px;
      background: transparent;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .ai-window-header .ai-header-title { font-size: 15px; font-weight: 600; }
    .ai-window-header .ai-header-status { font-size: 12px; color: var(--accent); }
    .ai-avatar {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent) 0%, #00a67e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    .ai-body {
      padding: 20px 24px;
      height: 320px;
      min-height: 320px;
      overflow-y: auto;
    }
    .ai-message {
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      border-left: 3px solid var(--accent);
    }
    .ai-message:last-child { margin-bottom: 0; }
    .ai-message.ai-message-user {
      background: rgba(0, 200, 150, 0.08);
      border-left-color: transparent;
      border-right: 3px solid var(--accent);
      margin-left: 48px;
      margin-right: 0;
    }
    .ai-message.ai-message-user .ai-message-text { color: var(--text-primary); }
    .ai-message.ai-message-user .ai-message-meta { justify-content: flex-end; }
    .ai-message-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .ai-message-type {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .ai-message-type.push {
      background: rgba(0, 200, 150, 0.2);
      color: var(--accent);
    }
    .ai-message-type.reply {
      background: rgba(99, 179, 237, 0.2);
      color: #63b3ed;
    }
    .ai-message-type.ask {
      background: rgba(139, 156, 179, 0.2);
      color: var(--text-secondary);
    }
    .ai-message-time { font-size: 11px; color: var(--text-muted); }
    .ai-message-text { font-size: 13px; line-height: 1.6; }
    .ai-message-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-sm.btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-main);
    }
    .btn-sm.btn-primary:hover { background: var(--accent-soft); border-color: var(--accent-soft); }
    .btn-sm.btn-ghost {
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
    }
    .btn-sm.btn-ghost:hover { background: rgba(255,255,255,0.1); }
    .ai-input-area {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    .ai-input {
      flex: 1;
      background: var(--bg-main);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
    }
    .ai-input::placeholder { color: var(--text-muted); }
    .ai-send {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: var(--accent);
      border: none;
      color: var(--bg-main);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .ai-send:hover { background: var(--accent-soft); }

    .tomorrow-preview {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
    }
    .dashboard-left .tomorrow-preview {
      margin-top: 0;
    }
    .tomorrow-preview h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tomorrow-preview h3::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
    }
    .plan-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .plan-card {
      background: var(--bg-elevated);
      border-radius: 10px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .plan-card:hover {
      border-color: rgba(0, 200, 150, 0.4);
      background: rgba(0, 200, 150, 0.06);
    }
    .plan-card-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .plan-card-value { font-size: 14px; font-weight: 600; }
    .tomorrow-preview .plan-footer {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .tomorrow-preview .plan-footer .btn-plan-detail {
      padding: 8px 16px;
      font-size: 13px;
      color: var(--accent);
      background: transparent;
      border: 1px solid rgba(0, 200, 150, 0.4);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tomorrow-preview .plan-footer .btn-plan-detail:hover {
      background: var(--accent-dim);
    }
    /* AI门店巡检 */
    .inspection-overview-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 16px 24px;
      margin-bottom: 24px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .inspection-overview { display: flex; align-items: center; gap: 24px; }
    .inspection-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: var(--accent-dim);
      border: 1px solid rgba(0, 200, 150, 0.35);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--accent);
    }
    .inspection-overview-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .inspection-stat-ok { color: var(--success); }
    .inspection-stat-warn { color: var(--warning); }
    .inspection-stat-alert { color: var(--danger); }
    .inspection-layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 28px;
      align-items: start;
      min-height: 0;
    }
    .inspection-left { display: flex; flex-direction: column; gap: 24px; min-width: 0; }
    .inspection-result-grid {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 20px 24px;
    }
    .inspection-result-grid h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .inspection-result-grid h3::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
    }
    .inspection-result-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .inspection-result-card {
      padding: 14px 16px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .inspection-result-card:hover { border-color: rgba(0, 200, 150, 0.4); background: rgba(0, 200, 150, 0.06); }
    .inspection-result-card.normal .result-card-value { color: var(--accent); }
    .inspection-result-card.warn .result-card-value { color: var(--warning); }
    .inspection-result-card .result-card-label { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .inspection-result-card .result-card-value { font-size: 14px; font-weight: 600; }
    .inspection-result-card .result-card-action { font-size: 11px; color: var(--accent); margin-top: 6px; }
    .inspection-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 0;
      overflow-y: auto;
    }
    /* AI物流调度 */
    .logistics-dispatch-panel { display: none; min-height: 0; }
    .logistics-dispatch-panel.active { display: block; }
    .logistics-dispatch-warehouse-list { display: flex; flex-direction: column; gap: 12px; flex: 1; min-height: 0; overflow-y: auto; }
    .logistics-dispatch-warehouse-card {
      padding: 14px 18px;
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .logistics-dispatch-warehouse-card:hover { border-color: rgba(0, 200, 150, 0.4); }
    .logistics-dispatch-warehouse-expandable { cursor: pointer; }
    .logistics-dispatch-warehouse-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .logistics-dispatch-warehouse-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .logistics-dispatch-warehouse-badges { display: flex; align-items: center; gap: 8px; }
    .logistics-dispatch-round-badge { font-size: 11px; padding: 2px 8px; border-radius: 4px; background: var(--bg-elevated); color: var(--text-secondary); }
    .logistics-dispatch-warehouse-chevron { font-size: 10px; color: var(--text-muted); transition: transform 0.2s; }
    .logistics-dispatch-warehouse-card.expanded .logistics-dispatch-warehouse-chevron { transform: rotate(180deg); }
    .logistics-dispatch-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
    .logistics-dispatch-status-ok { background: rgba(0, 200, 150, 0.2); color: var(--success); }
    .logistics-dispatch-status-warn { background: rgba(255, 179, 71, 0.2); color: var(--warning); }
    .logistics-dispatch-warehouse-summary { display: flex; flex-wrap: wrap; gap: 16px 24px; align-items: center; }
    .logistics-dispatch-metric { display: flex; gap: 6px; font-size: 13px; }
    .logistics-dispatch-metric .label { color: var(--text-muted); }
    .logistics-dispatch-metric .value { color: var(--text-primary); font-weight: 500; }
    .logistics-dispatch-gap { font-size: 12px; color: var(--warning); margin-top: 8px; width: 100%; }
    .logistics-dispatch-warehouse-rounds {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .logistics-dispatch-warehouse-card.expanded .logistics-dispatch-warehouse-rounds { display: block; }
    .logistics-dispatch-round-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .logistics-dispatch-round-row:last-child { margin-bottom: 0; }
    .logistics-dispatch-round-row .round-time { min-width: 48px; font-weight: 500; color: var(--accent); }
    .logistics-dispatch-round-row .round-range { min-width: 90px; color: var(--text-primary); }
    .logistics-dispatch-round-row .round-cargo { min-width: 60px; color: var(--text-secondary); }
    .logistics-dispatch-round-row .round-docs { flex: 1; color: var(--text-muted); }
    .logistics-dispatch-alloc-actions { display: flex; gap: 8px; margin-left: auto; }
    .logistics-dispatch-route-list { display: flex; flex-direction: column; gap: 12px; max-height: 420px; overflow-y: auto; }
    .logistics-dispatch-route-card {
      padding: 14px 18px;
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .logistics-dispatch-route-card:hover { border-color: rgba(0, 200, 150, 0.4); }
    .logistics-dispatch-route-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .logistics-dispatch-route-id { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .logistics-dispatch-route-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; background: rgba(0, 200, 150, 0.2); color: var(--success); }
    .logistics-dispatch-route-status-pending { background: rgba(255, 179, 71, 0.2); color: var(--warning); }
    .logistics-dispatch-route-body { display: flex; flex-direction: column; gap: 6px; }
    .logistics-dispatch-route-row { display: flex; gap: 8px; font-size: 13px; }
    .logistics-dispatch-route-row .label { color: var(--text-muted); min-width: 60px; }
    .logistics-dispatch-vehicle-info span:last-child { color: var(--text-secondary); font-size: 12px; }
    .logistics-dispatch-route-path { margin-top: 12px; }
    .logistics-dispatch-route-path .label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .route-path-full {
      padding: 10px 14px;
      background: var(--bg-elevated);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.6;
      font-family: 'JetBrains Mono', monospace;
    }
    .logistics-dispatch-loading-detail { margin-top: 12px; }
    .logistics-dispatch-loading-detail .label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .loading-detail-table {
      width: 100%;
      font-size: 12px;
      border-collapse: collapse;
    }
    .loading-detail-table th, .loading-detail-table td { padding: 6px 10px; text-align: left; border-bottom: 1px solid var(--border); }
    .loading-detail-table th { color: var(--text-muted); font-weight: 500; }
    .loading-detail-table td { color: var(--text-primary); }
    .logistics-dispatch-cost-detail { margin-top: 12px; }
    .logistics-dispatch-cost-detail .label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .cost-breakdown {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .cost-breakdown strong { color: var(--accent); }
    .docflow-item-checkbox-wrap { width: 24px; flex-shrink: 0; display: flex; align-items: flex-start; justify-content: center; padding-top: 2px; }
    .docflow-item-inner { display: flex; align-items: flex-start; gap: 12px; width: 100%; }
    .docflow-item-checkbox { flex-shrink: 0; margin: 0; cursor: pointer; }
    .inspection-ops-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .inspection-ops-section h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .inspection-ops-section .ops-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 16px;
    }
    .ops-item {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .ops-item:last-child { border-bottom: none; padding-bottom: 0; }
    .ops-item:first-child { padding-top: 0; }
    .ops-item .ops-label { font-size: 13px; font-weight: 500; flex: 1; min-width: 120px; }
    .ops-item .ops-meta { font-size: 12px; color: var(--text-muted); }
    .ops-item .ops-btn {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .ops-item .ops-btn:hover { border-color: var(--accent); color: var(--accent); }
    .ops-item .ops-btn.primary { background: var(--accent); border-color: var(--accent); color: var(--bg-main); }
    .ops-item .ops-btn.primary:hover { background: var(--accent-soft); }
    .ops-item-alert { background: rgba(255, 107, 107, 0.06); border-radius: 8px; padding: 12px !important; margin: 0 -4px 8px -4px; }
    .ops-card-actions { display: flex; flex-direction: column; gap: 12px; }
    .ops-action-btn {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      padding: 14px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .ops-action-btn:hover { border-color: var(--accent); background: rgba(0, 200, 150, 0.06); }
    .ops-action-btn span:first-of-type { font-size: 14px; font-weight: 600; }
    .ops-action-desc { font-size: 12px; color: var(--text-muted); }
    .ops-export-row { display: flex; gap: 8px; margin-top: 4px; }
    .ops-export-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .ops-export-btn:hover { border-color: var(--accent); color: var(--accent); }
    .ops-quick-row { display: flex; flex-wrap: nowrap; gap: 12px; }
    .ops-quick-row .inspection-config-btn { flex-shrink: 0; white-space: nowrap; }
    .inspection-config-btn {
      padding: 12px 24px;
      background: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 10px;
      color: var(--bg-main);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .inspection-config-btn:hover {
      background: var(--accent-soft);
      border-color: var(--accent-soft);
    }
    .ops-quick-row .inspection-config-btn:not(:first-child) {
      background: var(--bg-elevated);
      border-color: var(--border);
      color: var(--text-primary);
    }
    .ops-quick-row .inspection-config-btn:not(:first-child):hover {
      background: rgba(0, 200, 150, 0.1);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* 市调选品 */
    .data-source-card {
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .upload-zone {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .upload-btn, .select-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: var(--bg-main);
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .category-bar {
      height: 24px;
      border-radius: 4px;
      display: flex;
      overflow: hidden;
      margin: 12px 0;
    }
    .category-bar span {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #fff;
    }
    .category-bar .veg { background: var(--accent); width: 42%; }
    .category-bar .meat { background: #73d13d; width: 28%; }
    .category-bar .fruit { background: #95de64; width: 18%; }
    .category-bar .other { background: #b7eb8f; width: 12%; color: var(--bg-main); }

    /* 商品引入进度弹窗 */
    .product-introduce-modal { max-width: 480px; }
    .product-introduce-info {
      padding: 12px 16px;
      background: var(--accent-dim);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .product-introduce-steps { display: flex; flex-direction: column; gap: 0; }
    .introduce-step {
      display: grid;
      grid-template-columns: 28px 1fr auto;
      align-items: start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    .introduce-step-body { display: flex; flex-direction: column; gap: 2px; }
    .introduce-step:last-child { border-bottom: none; }
    .introduce-step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }
    .introduce-step.running .introduce-step-icon {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
      animation: introducePulse 1s ease-in-out infinite;
    }
    .introduce-step.done .introduce-step-icon {
      background: rgba(0, 200, 150, 0.2);
      border-color: var(--success);
      color: var(--success);
    }
    .introduce-step.done .introduce-step-icon { font-size: 14px; }
    .introduce-step.fail .introduce-step-icon {
      background: rgba(255, 107, 107, 0.2);
      border-color: var(--danger);
      color: var(--danger);
    }
    .introduce-step-label { font-weight: 500; color: var(--text-primary); }
    .introduce-step-detail { font-size: 12px; color: var(--text-muted); }
    .introduce-step-status { font-size: 12px; color: var(--text-muted); }
    .introduce-step.done .introduce-step-status { color: var(--success); }
    .introduce-step.fail .introduce-step-status { color: var(--danger); }
    .introduce-step-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .introduce-step-input input {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-main);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
    }
    @keyframes introducePulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 200, 150, 0.4); }
      50% { opacity: 0.9; box-shadow: 0 0 0 6px rgba(0, 200, 150, 0); }
    }

    /* 合同智检 */
    .contract-risk-summary {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
    }
    .contract-risk-stat {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .contract-risk-stat-val { font-size: 24px; font-weight: 700; }
    .contract-risk-stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .risk-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    .risk-badge.risk-high { background: rgba(255, 107, 107, 0.2); color: var(--danger); }
    .risk-badge.risk-mid { background: rgba(255, 179, 71, 0.2); color: var(--warning); }
    .risk-badge.risk-low { background: rgba(139, 156, 179, 0.2); color: var(--text-muted); }
    .report-type-tag {
      display: inline-block;
      padding: 4px 10px;
      background: var(--accent-dim);
      border: 1px solid rgba(0, 200, 150, 0.3);
      border-radius: 6px;
      font-size: 12px;
      color: var(--accent);
    }
    .report-quality-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
    }
    .report-drilldown-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .report-drilldown-section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .report-drilldown-head {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-left: 8px;
      border-left: 3px solid var(--accent);
    }
    .report-quality-tag.pass { background: rgba(0, 200, 150, 0.15); color: var(--success); }
    .report-quality-tag.warn { background: rgba(255, 179, 71, 0.15); color: var(--warning); }
    .contract-risk-select-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .contract-risk-select-label { font-size: 13px; color: var(--text-muted); }
    .contract-risk-select {
      padding: 8px 14px;
      font-size: 13px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      min-width: 160px;
      font-family: inherit;
    }
    .contract-risk-select:hover { border-color: var(--accent); }
    .contract-risk-select:focus { outline: none; border-color: var(--accent); }
    .contract-risk-all { display: flex; flex-direction: column; gap: 24px; }
    .contract-risk-group {
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .contract-risk-group-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .contract-risk-group-header .btn-sm { margin-left: auto; }
    .contract-risk-group-title { font-size: 14px; font-weight: 600; color: var(--accent); }
    .contract-risk-group-count { font-size: 12px; color: var(--text-muted); }
    .contract-risk-single-header { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 16px; }
    .contract-risk-empty { font-size: 13px; color: var(--text-muted); padding: 16px 0; }
    .contract-risk-summary-inline { font-size: 12px; }
    .contract-revision-mini-list .contract-clause { margin-bottom: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; }

    /* 门店流程智管 */
    .storeflow-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .storeflow-tab {
      padding: 10px 20px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .storeflow-tab:hover { border-color: var(--accent); color: var(--accent); }
    .storeflow-tab.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }
    .storeflow-panel { display: none; }
    .storeflow-panel.active { display: block; }
    .storeflow-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .storeflow-form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }
    .storeflow-form-block {
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .storeflow-block-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--accent);
    }
    .storeflow-hint { font-size: 11px; color: var(--text-muted); font-weight: 400; margin-left: 8px; }
    .storeflow-form-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .storeflow-form-row:last-child { margin-bottom: 0; }
    .storeflow-label { min-width: 100px; color: var(--text-muted); flex-shrink: 0; }
    .storeflow-input, .storeflow-select {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-main);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
    }
    .storeflow-inline { display: flex; gap: 8px; flex: 1; flex-wrap: wrap; }
    .storeflow-upload {
      padding: 12px 20px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .storeflow-upload:hover { border-color: var(--accent); color: var(--accent); }
    .storeflow-check-group { display: flex; gap: 16px; flex-wrap: wrap; }
    .storeflow-check-group label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .storeflow-actions { display: flex; gap: 12px; margin-top: 20px; }
    .storeflow-closing-checklist { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .storeflow-check-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .storeflow-check-item.auto .storeflow-check-icon { color: var(--success); }
    .storeflow-check-item.manual .storeflow-check-icon { color: var(--warning); }
    .storeflow-check-icon { font-size: 18px; font-weight: 700; width: 24px; text-align: center; }
    .storeflow-check-body { flex: 1; min-width: 0; }
    .storeflow-check-title { font-weight: 500; margin-bottom: 4px; }
    .storeflow-check-desc { font-size: 12px; color: var(--text-muted); }
    .storeflow-check-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }
    .storeflow-check-badge.auto { background: rgba(0, 200, 150, 0.15); color: var(--success); }
    .storeflow-check-badge.manual { background: rgba(255, 179, 71, 0.15); color: var(--warning); }
    .storeflow-confirm-check { display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; }
    .storeflow-closing-summary {
      padding: 16px 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .storeflow-summary-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; }
    .storeflow-summary-row:last-child { margin-bottom: 0; }

    /* 门店开业 · 左右分栏：填写信息 + 提交后 AI 自动执行 */
    .storeflow-opening-layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 24px;
      align-items: start;
    }
    .storeflow-opening-main { min-width: 0; }
    .storeflow-opening-sidebar {
      position: sticky;
      top: 24px;
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
    }
    .storeflow-sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .storeflow-sidebar-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .storeflow-sidebar-steps { display: flex; flex-direction: column; gap: 8px; }
    .storeflow-sidebar-step {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .storeflow-sidebar-num {
      width: 22px;
      height: 22px;
      min-width: 22px;
      border-radius: 6px;
      background: var(--accent-dim);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .storeflow-sidebar-group { margin-bottom: 4px; }
    .storeflow-sidebar-group:last-of-type { margin-bottom: 8px; }
    .storeflow-sidebar-substeps {
      padding-left: 32px;
      margin-top: 6px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .storeflow-sidebar-substep {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .storeflow-sidebar-substep-manual { color: var(--warning); }

    /* 门店自营转加盟 · 左右分栏 */
    .storeflow-convert-layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
      align-items: start;
      margin-bottom: 24px;
    }
    .storeflow-convert-main { min-width: 0; }
    .storeflow-convert-sidebar {
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
    }
    .storeflow-closing-manual {
      padding: 16px;
      background: rgba(255, 179, 71, 0.08);
      border-radius: 10px;
      border: 1px solid rgba(255, 179, 71, 0.25);
    }
    .storeflow-manual-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--warning);
      margin-bottom: 10px;
    }
    .storeflow-sidebar-step-manual .storeflow-sidebar-num { background: rgba(255, 179, 71, 0.2); color: var(--warning); }
    .storeflow-sidebar-tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255, 179, 71, 0.2);
      color: var(--warning);
      margin-left: 6px;
    }
    .storeflow-convert-phases { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; }
    .storeflow-convert-phase {
      padding: 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .storeflow-convert-phase-external {
      border-color: rgba(255, 179, 71, 0.4);
      background: linear-gradient(135deg, rgba(255, 179, 71, 0.06) 0%, var(--bg-elevated) 100%);
    }
    .storeflow-convert-phase-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .storeflow-convert-phase-num {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--accent-dim);
      color: var(--accent);
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .storeflow-convert-phase-title { font-size: 15px; font-weight: 600; }
    .storeflow-convert-phase-hint { font-size: 12px; color: var(--text-muted); margin-left: auto; }
    .storeflow-convert-phase-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(255, 179, 71, 0.2);
      color: var(--warning);
      margin-left: auto;
    }
    .storeflow-convert-phase-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .storeflow-convert-phase-items { display: flex; flex-direction: column; gap: 8px; }
    .storeflow-convert-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .storeflow-convert-item-icon { font-size: 14px; color: var(--accent); }
    .storeflow-convert-phase-actions { margin-top: 12px; }
    .storeflow-convert-summary {
      padding: 16px 20px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .storeflow-convert-summary-row {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
    }
    .storeflow-convert-summary-row:last-child { margin-bottom: 0; }
    .storeflow-convert-summary-row span:first-child { color: var(--text-muted); flex-shrink: 0; }

    /* 开业/闭店 · AI 进度弹窗 */
    .storeflow-progress-modal { padding: 0; }
    .storeflow-progress-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .storeflow-progress-badge {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
    }
    .storeflow-progress-hint { font-size: 12px; color: var(--text-muted); }
    .storeflow-progress-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .storeflow-progress-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    .storeflow-progress-item.done .storeflow-progress-icon { color: var(--success); }
    .storeflow-progress-item.running .storeflow-progress-icon { color: var(--accent); animation: aiPulse 1.5s ease-in-out infinite; }
    .storeflow-progress-item.manual .storeflow-progress-icon { color: var(--warning); }
    .storeflow-progress-icon { font-size: 14px; font-weight: 700; width: 20px; text-align: center; flex-shrink: 0; }
    .storeflow-progress-name { flex: 1; }
    .storeflow-progress-status {
      font-size: 12px;
      color: var(--text-muted);
    }
    .storeflow-progress-item.done .storeflow-progress-status { color: var(--success); }
    .storeflow-progress-item.running .storeflow-progress-status { color: var(--accent); }
    .storeflow-progress-item.manual .storeflow-progress-status { color: var(--warning); }
    .storeflow-progress-group { margin-bottom: 4px; }
    .storeflow-progress-group:last-of-type { margin-bottom: 0; }
    .storeflow-progress-substeps {
      padding-left: 36px;
      margin-top: 6px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .storeflow-progress-subitem {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--bg-main);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .storeflow-progress-subitem.done .storeflow-progress-subicon { color: var(--success); }
    .storeflow-progress-subitem.running .storeflow-progress-subicon { color: var(--accent); }
    .storeflow-progress-subitem.manual .storeflow-progress-subicon { color: var(--warning); }
    .storeflow-progress-subicon { font-size: 12px; font-weight: 700; width: 16px; text-align: center; flex-shrink: 0; }
    .storeflow-progress-footer {
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .storeflow-progress-footer p { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
    .storeflow-progress-footer .btn { min-width: 100px; }

    /* 合同优化稿弹窗 */
    .contract-optimize-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .contract-optimize-modal.active { display: flex; }
    .contract-optimize-dialog {
      width: 95%;
      max-width: 1100px;
      max-height: 90vh;
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .contract-optimize-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .contract-optimize-header h3 { font-size: 16px; font-weight: 600; }
    .contract-optimize-body {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      min-height: 0;
      overflow: hidden;
    }
    .contract-optimize-content {
      padding: 24px;
      overflow-y: auto;
      border-right: 1px solid var(--border);
    }
    .contract-doc {
      font-size: 14px;
      line-height: 1.8;
      color: var(--text-primary);
    }
    .contract-doc h4 { font-size: 15px; margin: 20px 0 12px; color: var(--accent); }
    .contract-doc p { margin-bottom: 12px; }
    .contract-doc .contract-clause { margin-bottom: 16px; }
    .contract-annot {
      background: rgba(255, 179, 71, 0.2);
      border-bottom: 2px solid var(--warning);
      padding: 0 2px;
      cursor: pointer;
      border-radius: 2px;
      position: relative;
    }
    .contract-annot.risk-high { background: rgba(255, 107, 107, 0.2); border-bottom-color: var(--danger); }
    .contract-annot:hover { opacity: 0.9; }
    .contract-annot-num {
      font-size: 11px;
      color: var(--warning);
      font-weight: 600;
      margin-left: 2px;
    }
    .contract-annot.risk-high .contract-annot-num { color: var(--danger); }
    .contract-optimize-sidebar {
      padding: 20px;
      overflow-y: auto;
      background: var(--bg-elevated);
    }
    .contract-revision-title { font-size: 13px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); }
    .contract-revision-item {
      padding: 12px 14px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 3px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .contract-revision-item:hover { border-left-color: var(--accent); background: var(--accent-dim); }
    .contract-revision-item.highlight { border-left-color: var(--accent); background: var(--accent-dim); }
    .contract-revision-item.risk-high { border-left-color: var(--danger); }
    .contract-revision-num { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .contract-revision-orig { font-size: 12px; color: var(--text-secondary); text-decoration: line-through; margin-bottom: 6px; }
    .contract-revision-sugg { font-size: 12px; color: var(--accent); }
    .contract-optimize-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-shrink: 0;
    }
    @keyframes contract-annot-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0, 200, 150, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(0, 200, 150, 0); }
    }

    /* 财务 */
    .finance-item {
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .finance-item.info { background: var(--accent-dim); border: 1px solid rgba(0, 200, 150, 0.3); }
    .finance-item.warn { background: rgba(255, 179, 71, 0.1); border: 1px solid rgba(255, 179, 71, 0.3); }
    .finance-item.danger { background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); }
    .finance-item.success { background: rgba(0, 200, 150, 0.08); border: 1px solid rgba(0, 200, 150, 0.25); }

    /* 报告 */
    .report-section { margin-bottom: 24px; }
    .report-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
    .report-box {
      padding: 16px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
    }
    .report-box.warn { background: rgba(255, 179, 71, 0.1); border: 1px solid rgba(255, 179, 71, 0.3); }
    .report-box.success { background: rgba(0, 200, 150, 0.08); border: 1px solid rgba(0, 200, 150, 0.25); }
    .report-box.reject { background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); }
    .report-prose { font-size: 13px; line-height: 1.7; color: var(--text-secondary); }
    .report-prose p { margin-bottom: 12px; }
    .report-prose p:last-child { margin-bottom: 0; }
    /* 日报/周报增强样式 */
    .report-daily-header { margin-bottom: 20px; padding: 16px 20px; background: var(--accent-dim); border: 1px solid rgba(0,200,150,0.3); border-radius: 12px; }
    .report-daily-title { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .report-daily-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    .report-daily-badges { display: flex; flex-wrap: wrap; gap: 8px; }
    .report-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; }
    .report-badge.ok { background: rgba(0,200,150,0.2); color: var(--success); }
    .report-badge.warn { background: rgba(255,179,71,0.2); color: var(--warning); }
    .report-badge.alert { background: rgba(255,107,107,0.2); color: var(--danger); }
    .report-daily-section { margin-bottom: 20px; padding: 16px; background: var(--bg-elevated); border-radius: 10px; border: 1px solid var(--border); }
    .report-daily-section.report-daily-alert { border-color: rgba(255,107,107,0.3); background: rgba(255,107,107,0.06); }
    .report-daily-section.report-daily-focus { border-color: rgba(0,200,150,0.25); background: rgba(0,200,150,0.06); }
    .report-section-title { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .report-mini-kpi { display: flex; gap: 16px; margin-bottom: 12px; }
    .mini-kpi-item { display: flex; flex-direction: column; align-items: flex-start; }
    .mini-kpi-val { font-size: 18px; font-weight: 700; }
    .mini-kpi-label { font-size: 11px; color: var(--text-muted); }
    .report-list { margin: 0; padding-left: 18px; font-size: 13px; color: var(--text-secondary); line-height: 1.7; }
    .report-list li { margin-bottom: 6px; }
    .report-tag { display: inline-block; padding: 4px 10px; background: var(--accent-dim); border-radius: 6px; font-size: 12px; color: var(--accent); margin-top: 8px; }
    .report-status-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .status-chip { padding: 4px 10px; border-radius: 6px; font-size: 12px; }
    .status-chip.ok { background: rgba(0,200,150,0.15); color: var(--success); }
    .status-chip.warn { background: rgba(255,179,71,0.15); color: var(--warning); }
    .status-chip.alert { background: rgba(255,107,107,0.15); color: var(--danger); }
    .report-alert-card { padding: 12px 16px; background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; color: var(--danger); font-size: 13px; }
    .report-focus-list { display: flex; flex-direction: column; gap: 8px; }
    .focus-item { padding: 10px 14px; background: var(--bg-card); border-radius: 8px; font-size: 13px; color: var(--text-primary); border-left: 3px solid var(--accent); }
    .report-trend-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
    .trend-item { padding: 12px; background: var(--bg-card); border-radius: 8px; display: flex; flex-direction: column; gap: 4px; }
    .trend-label { font-size: 11px; color: var(--text-muted); }
    .trend-val { font-size: 16px; font-weight: 600; }
    .trend-change { font-size: 11px; }
    .trend-change.down { color: var(--success); }
    .report-daily-note { font-size: 12px; color: var(--text-muted); margin: 0; line-height: 1.6; }
    .report-suggest-grid { display: flex; flex-direction: column; gap: 10px; }
    .suggest-card { display: flex; gap: 12px; padding: 12px 14px; background: var(--bg-card); border-radius: 8px; align-items: flex-start; }
    .suggest-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent); color: var(--bg-main); font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .suggest-text { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

    /* 报告弹窗 */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      width: 960px;
      max-width: 95vw;
      min-height: 480px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 24px 48px rgba(0,0,0,0.4);
    }
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h3 { font-size: 18px; font-weight: 600; }
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
    }
    .modal-close:hover { background: rgba(255,255,255,0.1); }
    .modal-body { padding: 24px; }
    .report-header { padding: 16px; background: var(--accent-dim); border-radius: 8px; margin-bottom: 24px; display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
    .report-header-text { flex: 1; min-width: 0; }
    .report-header h4 { font-size: 15px; font-weight: 700; color: var(--accent); margin-bottom: 8px; }
    .report-header p { font-size: 12px; color: var(--text-secondary); }
    .report-export-dropdown { position: relative; }
    .report-export-trigger { padding: 8px 16px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 13px; cursor: pointer; }
    .report-export-trigger:hover { border-color: var(--accent); color: var(--accent); }
    .report-export-menu { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; min-width: 140px; z-index: 10; }
    .report-export-dropdown.open .report-export-menu { display: block; }
    .report-export-menu button { display: block; width: 100%; padding: 10px 16px; text-align: left; background: none; border: none; color: var(--text-primary); font-size: 13px; cursor: pointer; }
    .report-export-menu button:hover { background: var(--accent-dim); }
    .report-note { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
    .report-section { margin-bottom: 24px; }
    .report-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
    .report-summary { padding: 16px; background: rgba(139,156,179,0.06); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 24px; }
    .report-summary h5 { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 10px; }
    .report-summary p { font-size: 12px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 8px; }
    .report-summary p:last-child { margin-bottom: 0; }
    .report-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 16px; }
    .report-kpi .kpi-card { padding: 14px; border-radius: 8px; text-align: center; }
    .report-kpi .kpi-change-yoy { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .report-diagnosis {
      padding: 16px;
      background: rgba(255, 179, 71, 0.1);
      border: 1px solid rgba(255, 179, 71, 0.3);
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .report-diagnosis h5 { color: var(--warning); margin-bottom: 8px; }
    .report-suggestions {
      padding: 16px;
      background: rgba(0, 200, 150, 0.08);
      border: 1px solid rgba(0, 200, 150, 0.25);
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
    }
    .report-suggestions h5 { color: var(--success); margin-bottom: 8px; }
    .report-suggestions ul { padding-left: 20px; margin: 8px 0; }
    .report-suggestions li { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px; }
    .priority-badge { flex-shrink: 0; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .priority-badge.p0 { background: rgba(255,107,107,0.2); color: var(--danger); }
    .priority-badge.p1 { background: rgba(255,179,71,0.2); color: var(--warning); }
    .priority-badge.p2 { background: rgba(139,156,179,0.3); color: var(--text-muted); }
    .btn-link { background: none; border: none; color: var(--accent); font-size: 12px; cursor: pointer; padding: 0; text-decoration: underline; }
    .btn-link:hover { color: var(--accent-soft, #00e6a8); }
    .report-actions { margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; }
    .report-top-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 640px) { .report-top-grid { grid-template-columns: 1fr; } }

    /* Toast 提示 */
    .toast-container {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      padding: 14px 24px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      color: var(--text-primary);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      animation: toastIn 0.3s ease;
    }
    .toast.success { border-color: var(--accent); background: var(--accent-dim); }
    .toast.loading { border-color: var(--warning); }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* 数据弹窗 */
    .data-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1500;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .data-modal-overlay.active { display: flex; }
    .data-modal {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      width: 960px;
      max-width: 95vw;
      min-height: 480px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 48px rgba(0,0,0,0.4);
    }
    .data-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .data-modal-header h3 { font-size: 16px; font-weight: 600; }
    .data-modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
    }
    .data-modal-close:hover { background: rgba(255,255,255,0.1); }
    .data-modal-body {
      padding: 24px;
      overflow-y: auto;
      font-size: 13px;
    }
    .data-modal-body .data-table { margin: 0; }
    .data-modal-body .kpi-grid { margin-bottom: 20px; }
    .data-modal-body .report-box { margin-bottom: 16px; }

    /* 配置巡检规则弹窗 */
    .config-modal-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6; }
    .config-modal-section { margin-bottom: 24px; padding: 18px 20px; background: var(--bg-elevated); border-radius: 12px; border: 1px solid var(--border); }
    .config-modal-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    .config-modal-checkboxes { display: flex; flex-wrap: wrap; gap: 12px 24px; }
    .config-check-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-primary); cursor: pointer; }
    .config-check-item input { accent-color: var(--accent); }
    .config-modal-rows { display: flex; flex-direction: column; gap: 14px; }
    .config-row { display: flex; align-items: center; gap: 16px; }
    .config-label { min-width: 120px; font-size: 13px; color: var(--text-secondary); }
    .config-input { padding: 10px 14px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 8px; font-size: 13px; color: var(--text-primary); }
    .config-input::placeholder { color: var(--text-muted); }
    .config-input:focus { outline: none; border-color: var(--accent); }
    .config-select { cursor: pointer; min-width: 140px; }
    .config-select option { background: var(--bg-card); color: var(--text-primary); }
    .config-input-sm { width: 70px; text-align: center; }
    .config-unit { font-size: 13px; color: var(--text-muted); margin-left: 4px; }
    .config-input-full { flex: 1; min-width: 0; }
    .config-modal-note { font-size: 12px; color: var(--text-muted); margin-bottom: 14px; line-height: 1.5; }
    .config-modal-actions { display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }
    .config-modal-actions .ops-btn,
    .config-modal-actions .btn {
      padding: 10px 20px;
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      border: 1px solid var(--border);
    }
    .config-modal-actions .ops-btn {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }
    .config-modal-actions .ops-btn:hover { border-color: var(--accent); color: var(--accent); }
    .config-modal-actions .ops-btn.primary,
    .config-modal-actions .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-main);
    }
    .config-modal-actions .ops-btn.primary:hover,
    .config-modal-actions .btn-primary:hover { background: var(--accent-soft); border-color: var(--accent-soft); }
    .config-modal-actions .btn-ghost {
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
    }
    .config-modal-actions .btn-ghost:hover { background: rgba(255,255,255,0.1); }
    .data-modal-body .config-modal-actions button {
      padding: 10px 20px;
      font-size: 13px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-primary);
    }
    .data-modal-body .config-modal-actions button:hover { border-color: var(--accent); color: var(--accent); }
    .data-modal-body .config-modal-actions button.primary,
    .data-modal-body .config-modal-actions button.btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-main);
    }
    .data-modal-body .config-modal-actions button.primary:hover,
    .data-modal-body .config-modal-actions button.btn-primary:hover { background: var(--accent-soft); border-color: var(--accent-soft); }
    .data-modal-body .config-modal-actions button.btn-ghost {
      background: rgba(255,255,255,0.06);
      color: var(--text-secondary);
    }
    .data-modal-body .config-modal-actions button.btn-ghost:hover { background: rgba(255,255,255,0.1); }
    .config-modal-input {
      padding: 10px 14px;
      background: var(--bg-main);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-primary);
      font-family: inherit;
    }
    .config-modal-input:focus { outline: none; border-color: var(--accent); }
    .config-modal-input[type="number"] { min-width: 80px; }
    select.config-modal-input { min-width: 140px; cursor: pointer; }

    /* 市调选择弹窗：行可点击 */
    .market-select-row { cursor: pointer; transition: background 0.2s; }
    .market-select-row:hover { background: rgba(255,255,255,0.04); }

    /* 导出下拉 */
    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .card-header-row .card-title { margin-bottom: 0; }
    .export-dropdown {
      position: relative;
    }
    .export-dropdown .export-trigger {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--accent);
      color: var(--bg-main);
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }
    .export-dropdown .export-trigger:hover { background: var(--accent-soft); }
    .export-dropdown .export-trigger::after {
      content: '▼';
      font-size: 10px;
      opacity: 0.8;
      display: inline-block;
      transition: transform 0.2s;
    }
    .export-dropdown.open .export-trigger::after { transform: rotate(180deg); }
    .export-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      min-width: 140px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      z-index: 100;
      overflow: hidden;
    }
    .export-dropdown.open .export-dropdown-menu { display: block; }
    .export-dropdown-menu button {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      text-align: left;
      transition: background 0.2s;
    }
    .export-dropdown-menu button:hover { background: rgba(255,255,255,0.06); }

    @media (max-width: 1200px) {
      .main-content { flex-direction: column; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .report-kpi { grid-template-columns: repeat(2, 1fr); }
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
      .inspection-layout,
      .docflow-layout {
        grid-template-columns: 1fr;
      }
      .contract-optimize-body {
        grid-template-columns: 1fr;
      }
      .contract-optimize-content { border-right: none; border-bottom: 1px solid var(--border); }
      .inspection-result-cards {
        grid-template-columns: repeat(2, 1fr);
      }
      .inspection-config-btn {
        width: 100%;
      }
      .dashboard-right {
        position: relative;
      }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="app">
    <!-- 侧栏 -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="logo-icon">营</div>
        <div class="logo-text">
          <h1>营营无忧</h1>
          <span>精准运作让经营变得更加容易</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-item active" data-scene="home">
          <span class="icon">🏠</span>
          <span>首页</span>
        </div>
        <div class="nav-label" data-toggle="auto-section" title="点击展开/收起">
          <span>自动化</span>
          <span class="chevron">▼</span>
        </div>
        <div class="nav-section-content" id="auto-section">
          <div class="nav-item nav-item-sub" data-scene="trustee-calendar">
            <span class="icon">📅</span>
            <span>托管日历</span>
          </div>
          <div class="nav-sublabel" data-toggle="store-auto-section" title="点击展开/收起">
            <span>门店自动化</span>
            <span class="chevron">▼</span>
          </div>
          <div class="nav-subsection-content" id="store-auto-section">
            <div class="nav-item nav-item-sub" data-scene="dashboard">
              <span class="icon">⚙️</span>
              <span>AI门店经营</span>
            </div>
            <div class="nav-item nav-item-sub" data-scene="inspection">
              <span class="icon">🔍</span>
              <span>AI门店巡检</span>
            </div>
          </div>
          <div class="nav-sublabel" data-toggle="ops-auto-section" title="点击展开/收起">
            <span>运营自动化</span>
            <span class="chevron">▼</span>
          </div>
          <div class="nav-subsection-content" id="ops-auto-section">
            <div class="nav-item nav-item-sub" data-scene="logistics-dispatch">
              <span class="icon">🚚</span>
              <span>AI物流调度</span>
            </div>
          </div>
        </div>
        <div class="nav-label" data-toggle="tool-section" title="点击展开/收起">
          <span>工具栏</span>
          <span class="chevron">▼</span>
        </div>
        <div class="nav-section-content" id="tool-section">
          <div class="nav-item" data-scene="market">
            <span class="icon">🛒</span>
            <span>市调选品分析</span>
          </div>
          <div class="nav-item" data-scene="contract">
            <span class="icon">📋</span>
            <span>合同智检</span>
          </div>
        </div>
        <div class="nav-label">对话历史</div>
        <div class="history-item" data-scene="finance"><span class="history-item-text">本月销售凭证与金蝶差异</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('finance')" title="删除">×</button></div>
        <div class="history-item" data-scene="assistant"><span class="history-item-text">下午客流少的原因分析</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('assistant')" title="删除">×</button></div>
        <div class="history-item" data-scene="logistics"><span class="history-item-text">华东仓明日运力与人力需求</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('logistics')" title="删除">×</button></div>
        <div class="history-item" data-scene="report"><span class="history-item-text">全国各仓入库出库分析建议</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('report')" title="删除">×</button></div>
        <div class="history-item" data-scene="store"><span class="history-item-text">本周经营指标环比</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('store')" title="删除">×</button></div>
        <div class="history-item" data-scene="product"><span class="history-item-text">菜湖区品类占比与汰换建议</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('product')" title="删除">×</button></div>
        <div class="history-item" data-scene="pricing"><span class="history-item-text">小白菜定价参考</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('pricing')" title="删除">×</button></div>
        <div class="history-item" data-scene="replenish"><span class="history-item-text">下周小白菜排骨补货建议</span><button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem('replenish')" title="删除">×</button></div>
      </nav>
      <div class="sidebar-user">
        <div class="user-avatar">张</div>
        <div class="user-info">
          <div class="name">张三</div>
          <div class="role">运营部 · 已登录</div>
        </div>
      </div>
    </aside>

    <!-- 主区 -->
    <main class="main-area">
      <header class="main-header">
        <div>
          <h2 id="scene-title">首页</h2>
          <div class="subtitle" id="scene-subtitle">操作指引</div>
        </div>
        <button class="create-chat-btn" onclick="createNewChat()">+ 创建对话</button>
      </header>

      <div class="main-content home-view" id="mainContent">
        <div class="content-left">
          <!-- 首页：欢迎栏 + 操作指引 -->
          <div id="scene-home" class="scene-panel active">
            <div class="home-welcome-bar">
              <span class="home-welcome-greeting">
                <span class="home-greeting-line1"><span class="home-greeting-prefix" id="homeGreetingPrefix">早上好，</span><span class="home-greeting-name">张三</span></span>
                <span class="home-greeting-line2"><span class="home-greeting-spacer" id="homeGreetingSpacer">早上好，</span><span class="home-greeting-tagline">让我帮你把生意越做越<span class="greeting-yi">易</span>~</span></span>
              </span>
              <span class="home-welcome-divider">·</span>
              <span class="home-welcome-date" id="homeDate">2025-01-31 周五</span>
            </div>
            <div class="home-guide-layout">
              <div class="home-guide-panel">
                <h2 class="home-guide-title">操作指引</h2>
                <div class="home-guide-list">
                  <div class="home-guide-item">
                    <span class="home-guide-num">01</span>
                    <div class="home-guide-content">
                      <h4>左侧导航</h4>
                      <p>展开自动化、工具栏，进入门店经营、巡检、单据流、物流调度；对话历史可继续过往会话</p>
                    </div>
                  </div>
                  <div class="home-guide-item">
                    <span class="home-guide-num">02</span>
                    <div class="home-guide-content">
                      <h4>托管日历</h4>
                      <p>按日开启/关闭各模块 AI 托管，选择门店或仓库</p>
                    </div>
                  </div>
                  <div class="home-guide-item">
                    <span class="home-guide-num">03</span>
                    <div class="home-guide-content">
                      <h4>创建对话</h4>
                      <p>发起新会话，咨询财务、销售、补货、定价等业务问题</p>
                    </div>
                  </div>
                  <div class="home-guide-item">
                    <span class="home-guide-num">04</span>
                    <div class="home-guide-content">
                      <h4>模块内操作</h4>
                      <p>查看任务、执行确认、查看报告；托管开启则自动执行</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 托管日历 -->
          <div id="scene-trustee-calendar" class="scene-panel">
            <div class="trustee-calendar-layout">
              <div class="trustee-calendar-left">
                <div class="trustee-calendar-header">
                  <h3>托管日历</h3>
                  <div class="trustee-calendar-actions">
                    <button class="home-btn-sm" onclick="trusteeCalendarCopyWeek()">复制到本周</button>
                    <button class="home-btn-sm" onclick="trusteeCalendarToday()">今日</button>
                  </div>
                </div>
                <div class="home-calendar-wrap">
                  <div class="home-calendar-nav">
                    <button class="home-calendar-arrow" onclick="trusteeCalendarPrevMonth()">◀</button>
                    <span class="home-calendar-month" id="trusteeCalendarMonth">2025年1月</span>
                    <button class="home-calendar-arrow" onclick="trusteeCalendarNextMonth()">▶</button>
                  </div>
                  <div class="home-calendar-weekdays">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                  </div>
                  <div class="home-calendar-grid" id="trusteeCalendarGrid"></div>
                </div>
              </div>
              <div class="trustee-calendar-right">
                <div class="trustee-stats-panel">
                  <h4 class="trustee-stats-title">AI 托管运行概览</h4>
                  <div class="trustee-stats-main">
                    <div class="trustee-stats-item trustee-stats-highlight">
                      <span class="trustee-stats-label">今日已运行</span>
                      <span class="trustee-stats-value" id="trusteeStatsTodayHours">6 小时 32 分</span>
                    </div>
                    <div class="trustee-stats-item">
                      <span class="trustee-stats-label">本月累计</span>
                      <span class="trustee-stats-value">142 小时</span>
                    </div>
                    <div class="trustee-stats-item">
                      <span class="trustee-stats-label">今日任务</span>
                      <span class="trustee-stats-value">已完成 4 项 · 进行中 1 项</span>
                    </div>
                    <div class="trustee-stats-item">
                      <span class="trustee-stats-label">托管范围</span>
                      <span class="trustee-stats-value">3 家门店 · 华东仓</span>
                    </div>
                    <div class="trustee-stats-item">
                      <span class="trustee-stats-label">最近执行</span>
                      <span class="trustee-stats-value">21:02 经营复盘</span>
                    </div>
                  </div>
                  <div class="trustee-stats-modules">
                    <div class="trustee-stats-modules-title">托管模块</div>
                    <div class="trustee-stats-module-list" id="trusteeStatsModuleList">
                      <div class="trustee-stats-module" data-mod="dashboard"><span class="trustee-module-dot on"></span><span>门店经营</span></div>
                      <div class="trustee-stats-module" data-mod="inspection"><span class="trustee-module-dot on"></span><span>门店巡检</span></div>
                      <div class="trustee-stats-module" data-mod="docflow"><span class="trustee-module-dot on"></span><span>单据流</span></div>
                      <div class="trustee-stats-module" data-mod="logistics-dispatch"><span class="trustee-module-dot on"></span><span>物流调度</span></div>
                    </div>
                  </div>
                  <div class="trustee-stats-footer">
                    <span class="trustee-stats-badge" id="trusteeStatsBadge"><span class="ai-pulse"></span> AI 托管中</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 仪表盘：AI门店经营 -->
          <div id="scene-dashboard" class="scene-panel">
            <div class="dashboard-overview-row">
              <div class="dashboard-overview">
                <span class="dashboard-ai-badge module-trustee-badge" data-mod="dashboard">
                  <span class="ai-pulse"></span>
                  <span class="module-trustee-text">AI托管中</span>
                </span>
                <div class="dashboard-overview-item module-trustee-when-managed">
                  <span class="dot done"></span>
                  <span><strong>4</strong> 已完成</span>
                </div>
                <div class="dashboard-overview-item module-trustee-when-managed">
                  <span class="dot running"></span>
                  <span><strong>1</strong> 进行中</span>
                </div>
                <div class="dashboard-overview-item module-trustee-when-managed">
                  <span class="dot pending"></span>
                  <span><strong>1</strong> 待执行</span>
                </div>
              </div>
              <div class="dashboard-store-info module-trustee-when-managed">
                <span class="store-info-item"><span class="store-info-label">城市</span>重庆</span>
                <span class="store-info-divider">|</span>
                <span class="store-info-item"><span class="store-info-label">门店</span>菜湖店</span>
                <span class="store-info-divider">|</span>
                <span class="store-info-item"><span class="store-info-label">门店编码</span>A01032</span>
              </div>
            </div>
            <div class="module-trustee-content" data-mod="dashboard">
            <div class="dashboard-sales-quick-header">今日销售快览</div>
            <div class="dashboard-sales-quick">
              <div class="sales-kpi">
                <div class="label">今日销售额</div>
                <div class="value">¥12,580</div>
                <div class="change up">较昨日 +8.2%</div>
              </div>
              <div class="sales-kpi">
                <div class="label">客流量</div>
                <div class="value">342</div>
                <div class="change up">较昨日 +5.1%</div>
              </div>
              <div class="sales-kpi">
                <div class="label">客单价</div>
                <div class="value">¥36.8</div>
                <div class="change down">较昨日 -2.1%</div>
              </div>
              <div class="sales-kpi">
                <div class="label">损耗率</div>
                <div class="value">2.1%</div>
                <div class="change up">在合理范围</div>
              </div>
            </div>
            <div class="dashboard-pending-wrap">
              <div class="dashboard-pending">
                <span class="pending-badge">待办</span>
                <span class="pending-text">采购订单待确认 <strong id="pendingOrderCount">23</strong> 单</span>
                <span class="pending-action" onclick="showTaskDetail('purchase')">去确认 →</span>
              </div>
              <div class="dashboard-pending dashboard-pending-secondary">
                <span class="pending-badge" style="background: rgba(255,107,107,0.9);">待审</span>
                <span class="pending-text">调价待审核 <strong>3</strong> 项</span>
                <span class="pending-action" onclick="showTaskDetail('pricing')">去审核 →</span>
              </div>
            </div>
            <div class="dashboard-quick-actions">
              <button class="quick-action-btn primary" onclick="quickConfirmOrders()">一键确认订单</button>
              <button class="quick-action-btn" onclick="showReport()">查看经营报告</button>
              <button class="quick-action-btn" onclick="showTaskDetail('replenish')">查看补货建议</button>
              <button class="quick-action-btn" onclick="showTaskDetail('marketing')">查看营销活动</button>
            </div>
            <div class="dashboard-layout">
              <div class="dashboard-left">
                <section class="timeline-section">
                  <div class="section-header">
                    <h2>今日自动执行任务</h2>
                    <span class="date" style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted);">2025-01-30</span>
                  </div>
                  <div class="timeline">
                    <div class="timeline-item completed" data-task="replenish" onclick="showTaskDetail('replenish')">
                      <span class="timeline-time">07:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">补货提醒</div>
                        <div class="timeline-desc">检测到 12 款商品库存低于安全线，已推送补货建议</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" data-task="purchase" onclick="showTaskDetail('purchase')">
                      <span class="timeline-time">08:30</span>
                      <div class="timeline-content">
                        <div class="timeline-title">自动下采购订单</div>
                        <div class="timeline-desc">根据销量预测，已生成 23 单采购订单，待您确认</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" data-task="marketing" onclick="showTaskDetail('marketing')">
                      <span class="timeline-time">10:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">自动创建营销活动</div>
                        <div class="timeline-desc">针对滞销品「小白菜、莴苣」创建限时促销，预计提升周转 15%</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" data-task="pricing" onclick="showTaskDetail('pricing')">
                      <span class="timeline-time">14:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">自动调价</div>
                        <div class="timeline-desc">根据竞品价格与库存，已调整 8 款生鲜价格，保持竞争力</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item running" data-task="review" onclick="showTaskDetail('review')">
                      <span class="timeline-time">21:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">今日经营复盘</div>
                        <div class="timeline-desc">正在分析今日销售、损耗、客流量，生成复盘报告…</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item" data-task="tomorrow" onclick="showTaskDetail('tomorrow')">
                      <span class="timeline-time">22:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">明日经营指引</div>
                        <div class="timeline-desc">复盘完成后，将自动生成明日补货、促销、排班建议</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                  </div>
                </section>
                <div class="tomorrow-preview">
                  <h3>明日经营指引</h3>
                  <div class="plan-grid">
                    <div class="plan-card" data-plan="replenish" onclick="showPlanDetail('replenish')">
                      <div class="plan-card-title">补货重点</div>
                      <div class="plan-card-value">鲜奶 20 件、鸡蛋 25 盒、叶菜 50 kg</div>
                    </div>
                    <div class="plan-card" data-plan="marketing" onclick="showPlanDetail('marketing')">
                      <div class="plan-card-title">促销建议</div>
                      <div class="plan-card-value">莴苣组合装 · 14:00-18:00</div>
                    </div>
                    <div class="plan-card" data-plan="traffic" onclick="showPlanDetail('traffic')">
                      <div class="plan-card-title">预计客流</div>
                      <div class="plan-card-value">约 380 人（较今日 +11%）</div>
                    </div>
                    <div class="plan-card" data-plan="shift" onclick="showPlanDetail('shift')">
                      <div class="plan-card-title">排班建议</div>
                      <div class="plan-card-value">早班 +1 人（周末高峰）</div>
                    </div>
                    <div class="plan-card" data-plan="delivery" onclick="showPlanDetail('delivery')">
                      <div class="plan-card-title">到货提醒</div>
                      <div class="plan-card-value">鲜品 6:00 / 蛋品 7:30</div>
                    </div>
                  </div>
                  <div class="plan-footer">
                    <button class="btn-plan-detail" onclick="showTaskDetail('tomorrow')">查看完整指引</button>
                  </div>
                </div>
              </div>
              <div class="dashboard-right">
                <div class="ai-window">
                  <div class="ai-window-header">
                    <h3 class="ai-header-title">经营动态</h3>
                    <span class="ai-header-status">● 实时提醒中</span>
                  </div>
                  <div class="ai-body">
                    <div class="ai-message">
                      <div class="ai-message-meta"><span class="ai-message-type push">自动推送</span><span class="ai-message-time">08:35</span></div>
                      <div class="ai-message-text">
                        采购订单已生成，共 23 单。请确认后一键提交供应商。预计明日 06:00 前到货。
                      </div>
                      <div class="ai-message-actions">
                        <button class="btn-sm btn-primary" onclick="quickConfirmOrders()">确认订单</button>
                        <button class="btn-sm btn-ghost" onclick="showTaskDetail('purchase')">修改</button>
                      </div>
                    </div>
                    <div class="ai-message ai-message-user">
                      <div class="ai-message-meta"><span class="ai-message-type ask">提问</span><span class="ai-message-time">09:15</span></div>
                      <div class="ai-message-text">今天卖得怎么样？</div>
                    </div>
                    <div class="ai-message">
                      <div class="ai-message-meta"><span class="ai-message-type reply">回答</span><span class="ai-message-time">09:15</span></div>
                      <div class="ai-message-text">
                        截至 09:15，今日销售额 ¥3,280，客流量 89 人，客单价 ¥36.9。较昨日同期 +5.2%，早高峰表现正常。
                      </div>
                      <div class="ai-message-actions">
                        <button class="btn-sm btn-primary" onclick="showReport()">查看完整报告</button>
                        <button class="btn-sm btn-ghost" onclick="show时段明细()">查看时段明细</button>
                      </div>
                    </div>
                    <div class="ai-message">
                      <div class="ai-message-meta"><span class="ai-message-type push">自动推送</span><span class="ai-message-time">10:15</span></div>
                      <div class="ai-message-text">
                        营销活动已创建：「蔬菜专区限时 8 折」，包含小白菜、莴苣、油麦菜。活动已同步到 POS 与小程序。
                      </div>
                      <div class="ai-message-actions">
                        <button class="btn-sm btn-primary" onclick="showTaskDetail('marketing')">查看活动</button>
                      </div>
                    </div>
                    <div class="ai-message">
                      <div class="ai-message-meta"><span class="ai-message-type push">自动推送</span><span class="ai-message-time">14:05</span></div>
                      <div class="ai-message-text">
                        已完成自动调价，8 款商品已更新。其中「有机西红柿」降价 0.5 元以应对周边竞品活动。
                      </div>
                      <div class="ai-message-actions">
                        <button class="btn-sm btn-primary" onclick="showTaskDetail('pricing')">查看调价明细</button>
                      </div>
                    </div>
                    <div class="ai-message">
                      <div class="ai-message-meta"><span class="ai-message-type push">自动推送</span><span class="ai-message-time">21:02</span></div>
                      <div class="ai-message-text">
                        正在为您复盘今日经营情况…今日销售额 ¥12,580，较昨日 +8.2%。客流量 342 人，客单价 ¥36.8。损耗率 2.1%，在合理范围内。
                      </div>
                      <div class="ai-message-actions">
                        <button class="btn-sm btn-primary" onclick="showReport()">查看完整报告</button>
                        <button class="btn-sm btn-ghost" onclick="showToast('已稍后提醒')">稍后</button>
                      </div>
                    </div>
                  </div>
                  <div class="ai-input-area">
                    <input type="text" class="ai-input" placeholder="输入问题或指令…" id="aiInput">
                    <button class="ai-send" onclick="sendToAI()">→</button>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- AI门店巡检 -->
          <div id="scene-inspection" class="scene-panel">
            <div class="inspection-overview-row">
              <div class="inspection-overview">
                <span class="inspection-badge module-trustee-badge" data-mod="inspection">
                  <span class="ai-pulse"></span>
                  <span class="module-trustee-text">AI托管中</span>
                </span>
                <div class="inspection-overview-item inspection-stat-ok module-trustee-when-managed">
                  <span class="dot done"></span>
                  <span><strong>6</strong> 正常</span>
                </div>
                <div class="inspection-overview-item inspection-stat-warn module-trustee-when-managed">
                  <span class="dot" style="background: var(--warning);"></span>
                  <span><strong>2</strong> 预警</span>
                </div>
                <div class="inspection-overview-item inspection-stat-alert module-trustee-when-managed">
                  <span class="dot" style="background: var(--danger);"></span>
                  <span><strong>1</strong> 异常</span>
                </div>
              </div>
              <div class="dashboard-store-info module-trustee-when-managed">
                <span class="store-info-item"><span class="store-info-label">城市</span>重庆</span>
                <span class="store-info-divider">|</span>
                <span class="store-info-item"><span class="store-info-label">门店</span>菜湖店</span>
                <span class="store-info-divider">|</span>
                <span class="store-info-item"><span class="store-info-label">巡检周期</span>日检 06:00 / 周检 周一</span>
              </div>
            </div>
            <div class="module-trustee-content" data-mod="inspection">
            <div class="inspection-layout">
              <div class="inspection-left">
                <section class="timeline-section">
                  <div class="section-header">
                    <h2>今日巡检任务</h2>
                    <span class="date" style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted);">2025-01-30</span>
                  </div>
                  <div class="timeline">
                    <div class="timeline-item completed" onclick="showInspectionDetail('expiring')">
                      <span class="timeline-time">06:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">临期/滞销扫描</div>
                        <div class="timeline-desc">发现 5 款临期商品、3 款滞销，已生成促销建议</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" onclick="showInspectionDetail('inventory')">
                      <span class="timeline-time">06:15</span>
                      <div class="timeline-content">
                        <div class="timeline-title">库存异常巡检</div>
                        <div class="timeline-desc">断货 0 款、超储 2 款，已推送补货/调拨建议</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" onclick="showInspectionDetail('loss')">
                      <span class="timeline-time">06:30</span>
                      <div class="timeline-content">
                        <div class="timeline-title">损耗预警巡检</div>
                        <div class="timeline-desc">损耗率 2.1% 正常；西兰花预计损耗偏高，建议限时促销</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" onclick="showInspectionDetail('cert')">
                      <span class="timeline-time">07:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">资质/证照巡检</div>
                        <div class="timeline-desc">1 份检测报告 7 天后到期，已推送续办提醒</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" onclick="showInspectionDetail('license')">
                      <span class="timeline-time">07:15</span>
                      <div class="timeline-content">
                        <div class="timeline-title">门店证照巡检</div>
                        <div class="timeline-desc">营业执照、食品经营许可证均在有效期内</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" onclick="showInspectionDetail('foodSafety')">
                      <span class="timeline-time">07:30</span>
                      <div class="timeline-content">
                        <div class="timeline-title">食安报告/批次检测巡检</div>
                        <div class="timeline-desc">2 款商品缺批次检测报告，已推送补传提醒</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                    <div class="timeline-item completed" onclick="showInspectionDetail('daily')">
                      <span class="timeline-time">21:00</span>
                      <div class="timeline-content">
                        <div class="timeline-title">日报生成</div>
                        <div class="timeline-desc">今日巡检日报已生成，含异常汇总与处置建议</div>
                      </div>
                      <div class="timeline-status"><span class="status-dot"></span></div>
                    </div>
                  </div>
                </section>
                <div class="inspection-result-grid">
                  <h3>巡检项结果</h3>
                  <div class="inspection-result-cards">
                    <div class="inspection-result-card normal" onclick="showInspectionDetail('expiring')">
                      <div class="result-card-label">临期/滞销</div>
                      <div class="result-card-value">5 款待处理</div>
                      <div class="result-card-action">查看促销建议</div>
                    </div>
                    <div class="inspection-result-card warn" onclick="showInspectionDetail('inventory')">
                      <div class="result-card-label">库存异常</div>
                      <div class="result-card-value">2 款超储</div>
                      <div class="result-card-action">查看调拨建议</div>
                    </div>
                    <div class="inspection-result-card normal" onclick="showInspectionDetail('loss')">
                      <div class="result-card-label">损耗预警</div>
                      <div class="result-card-value">1 款建议促销</div>
                      <div class="result-card-action">查看详情</div>
                    </div>
                    <div class="inspection-result-card warn" onclick="showInspectionDetail('cert')">
                      <div class="result-card-label">资质到期</div>
                      <div class="result-card-value">1 份 7 天后</div>
                      <div class="result-card-action">续办提醒</div>
                    </div>
                    <div class="inspection-result-card normal" onclick="showInspectionDetail('license')">
                      <div class="result-card-label">门店证照</div>
                      <div class="result-card-value">正常</div>
                      <div class="result-card-action">查看详情</div>
                    </div>
                    <div class="inspection-result-card warn" onclick="showInspectionDetail('foodSafety')">
                      <div class="result-card-label">食安/批次</div>
                      <div class="result-card-value">2 款缺报告</div>
                      <div class="result-card-action">补传提醒</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="inspection-right">
                <div class="inspection-ops-header">操作区</div>
                <div class="inspection-ops-section">
                  <h4>临期商品处理</h4>
                  <div class="ops-card">
                    <div class="ops-item">
                      <span class="ops-label">西兰花</span>
                      <span class="ops-meta">剩余 2 天 · 8 kg</span>
                      <button class="ops-btn primary" onclick="showInspectionDetail('expiring')">生成促销建议</button>
                    </div>
                    <div class="ops-item">
                      <span class="ops-label">小白菜、莴苣、油麦菜</span>
                      <span class="ops-meta">周转&lt;2 次 · 滞销</span>
                      <button class="ops-btn" onclick="showToast('已同步至促销系统')">一键促销/组合</button>
                    </div>
                    <div class="ops-item">
                      <span class="ops-label">预制红烧肉</span>
                      <span class="ops-meta">剩余 4 天 · 6 盒</span>
                      <button class="ops-btn" onclick="showToast('已生成限时折扣建议')">限时折扣</button>
                    </div>
                  </div>
                </div>
                <div class="inspection-ops-section">
                  <h4>异常事件升级</h4>
                  <div class="ops-card">
                    <div class="ops-item ops-item-alert">
                      <span class="ops-label">对账差异 CD-20260114</span>
                      <span class="ops-meta" style="color: var(--danger);">金额差 ¥320 · 待处理</span>
                      <button class="ops-btn primary" onclick="showDataModal('对账差异', '休库配送单与金蝶金额差 320 元，建议核对运费分摊。')">去处理</button>
                    </div>
                    <div class="ops-item">
                      <span class="ops-label">渝北鲜品 · 检测报告</span>
                      <span class="ops-meta">7 天后到期</span>
                      <button class="ops-btn" onclick="showToast('已推送续办提醒')">续办提醒</button>
                    </div>
                  </div>
                </div>
                <div class="inspection-ops-section">
                  <h4>日报 / 周报</h4>
                  <div class="ops-card ops-card-actions">
                    <button class="ops-action-btn" onclick="showInspectionDetail('daily')">
                      <span>今日巡检日报</span>
                      <span class="ops-action-desc">异常汇总 · 处置建议</span>
                    </button>
                    <button class="ops-action-btn" onclick="showInspectionDetail('weekly')">
                      <span>本周巡检周报</span>
                      <span class="ops-action-desc">趋势分析 · 改进建议</span>
                    </button>
                    <div class="ops-export-row">
                      <button class="ops-export-btn" onclick="showToast('已导出今日巡检日报.pdf')">导出日报</button>
                      <button class="ops-export-btn" onclick="showToast('已导出本周巡检周报.pdf')">导出周报</button>
                    </div>
                  </div>
                </div>
                <div class="inspection-ops-section">
                  <h4>快捷操作</h4>
                  <div class="ops-quick-row">
                    <button class="inspection-config-btn" onclick="showInspectionConfigModal()">配置巡检规则</button>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- AI物流调度 -->
          <div id="scene-logistics-dispatch" class="scene-panel">
            <div class="docflow-overview-row">
              <div class="docflow-overview-main">
                <span class="docflow-badge module-trustee-badge" data-mod="logistics-dispatch">
                  <span class="ai-pulse"></span>
                  <span class="module-trustee-text">AI托管中</span>
                </span>
                <div class="docflow-overview-stats module-trustee-when-managed">
                  <div class="docflow-overview-item inspection-stat-ok">
                    <span class="dot done"></span>
                    <span><strong id="logisticsDispatchStatWorkload">1,280</strong> 今日作业量</span>
                  </div>
                  <div class="docflow-overview-item inspection-stat-ok">
                    <span class="dot done"></span>
                    <span><strong id="logisticsDispatchStatVehicles">24</strong> 在途车次</span>
                  </div>
                  <div class="docflow-overview-item inspection-stat-warn">
                    <span class="dot" style="background: var(--warning);"></span>
                    <span><strong id="logisticsDispatchStatPending">3</strong> 待调配</span>
                  </div>
                  <div class="docflow-overview-item inspection-stat-ok">
                    <span class="dot done"></span>
                    <span><strong id="logisticsDispatchStatSent">18</strong> 已下发</span>
                  </div>
                </div>
              </div>
              <div class="docflow-overview-divider module-trustee-when-managed"></div>
              <div class="docflow-overview-aux module-trustee-when-managed">
                <span class="store-info-item"><span class="store-info-label">区域仓</span>全国</span>
                <span class="store-info-divider">|</span>
                <span class="store-info-item"><span class="store-info-label">更新</span>10:35</span>
              </div>
            </div>
            <div class="module-trustee-content" data-mod="logistics-dispatch">
            <div class="docflow-layout">
              <div class="docflow-left">
                <div class="docflow-type-tabs" id="logisticsDispatchTypeTabs">
                  <button class="docflow-tab logistics-dispatch-tab active" data-tab="monitor">实时监控</button>
                  <button class="docflow-tab logistics-dispatch-tab" data-tab="route">路线优化</button>
                </div>
                <div class="logistics-dispatch-panel active" id="logistics-dispatch-monitor">
                  <section class="timeline-section">
                    <div class="section-header">
                      <h2>区域仓运力监控</h2>
                      <span class="date" style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted);">今日 · 点击展开查看各批次</span>
                    </div>
                    <div class="logistics-dispatch-warehouse-list" id="logisticsDispatchWarehouseList">
                      <div class="logistics-dispatch-warehouse-card logistics-dispatch-warehouse-expandable" data-warehouse="hd" onclick="logisticsDispatchToggleWarehouse('hd')">
                        <div class="logistics-dispatch-warehouse-header">
                          <span class="logistics-dispatch-warehouse-name">华东仓</span>
                          <span class="logistics-dispatch-warehouse-badges">
                            <span class="logistics-dispatch-round-badge">3 批次</span>
                            <span class="logistics-dispatch-status logistics-dispatch-status-warn">需调配</span>
                          </span>
                          <span class="logistics-dispatch-warehouse-chevron" id="warehouse-chevron-hd">▼</span>
                        </div>
                        <div class="logistics-dispatch-warehouse-summary">
                          <div class="logistics-dispatch-metric"><span class="label">作业量</span><span class="value">+15%</span></div>
                          <div class="logistics-dispatch-metric"><span class="label">货物量</span><span class="value">2.8 吨</span></div>
                          <div class="logistics-dispatch-gap">缺口：分拣 +2 人，运力 +1 车 · 需调配时段 06:00-08:30、09:00-11:00</div>
                        </div>
                        <div class="logistics-dispatch-warehouse-rounds" id="warehouse-rounds-hd">
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次1</span>
                            <span class="round-range">06:00-08:30</span>
                            <span class="round-cargo">1.2 吨</span>
                            <span class="round-docs">分拣单 45 单、强配 12 单</span>
                          </div>
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次2</span>
                            <span class="round-range">09:00-11:00</span>
                            <span class="round-cargo">0.8 吨</span>
                            <span class="round-docs">抢菜 8 单、T+2 补货 15 单</span>
                          </div>
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次3</span>
                            <span class="round-range">14:00-16:00</span>
                            <span class="round-cargo">0.8 吨</span>
                            <span class="round-docs">调拨 5 单、退货 3 单</span>
                          </div>
                        </div>
                      </div>
                      <div class="logistics-dispatch-warehouse-card logistics-dispatch-warehouse-expandable" data-warehouse="hn" onclick="logisticsDispatchToggleWarehouse('hn')">
                        <div class="logistics-dispatch-warehouse-header">
                          <span class="logistics-dispatch-warehouse-name">华南仓</span>
                          <span class="logistics-dispatch-warehouse-badges">
                            <span class="logistics-dispatch-round-badge">2 批次</span>
                            <span class="logistics-dispatch-status logistics-dispatch-status-ok">充足</span>
                          </span>
                          <span class="logistics-dispatch-warehouse-chevron" id="warehouse-chevron-hn">▼</span>
                        </div>
                        <div class="logistics-dispatch-warehouse-summary">
                          <div class="logistics-dispatch-metric"><span class="label">作业量</span><span class="value">+3%</span></div>
                          <div class="logistics-dispatch-metric"><span class="label">货物量</span><span class="value">1.2 吨</span></div>
                          <div class="logistics-dispatch-gap" style="color: var(--success);">人力运力充足</div>
                        </div>
                        <div class="logistics-dispatch-warehouse-rounds" id="warehouse-rounds-hn">
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次1</span>
                            <span class="round-range">06:30-09:00</span>
                            <span class="round-cargo">0.9 吨</span>
                            <span class="round-docs">分拣单 32 单、强配 8 单</span>
                          </div>
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次2</span>
                            <span class="round-range">10:00-12:00</span>
                            <span class="round-cargo">0.3 吨</span>
                            <span class="round-docs">T+2 补货 6 单</span>
                          </div>
                        </div>
                      </div>
                      <div class="logistics-dispatch-warehouse-card logistics-dispatch-warehouse-expandable" data-warehouse="hb" onclick="logisticsDispatchToggleWarehouse('hb')">
                        <div class="logistics-dispatch-warehouse-header">
                          <span class="logistics-dispatch-warehouse-name">华北仓</span>
                          <span class="logistics-dispatch-warehouse-badges">
                            <span class="logistics-dispatch-round-badge">2 批次</span>
                            <span class="logistics-dispatch-status logistics-dispatch-status-warn">需调配</span>
                          </span>
                          <span class="logistics-dispatch-warehouse-chevron" id="warehouse-chevron-hb">▼</span>
                        </div>
                        <div class="logistics-dispatch-warehouse-summary">
                          <div class="logistics-dispatch-metric"><span class="label">作业量</span><span class="value">+8%</span></div>
                          <div class="logistics-dispatch-metric"><span class="label">货物量</span><span class="value">1.9 吨</span></div>
                          <div class="logistics-dispatch-gap">缺口：分拣 +1 人 · 需调配时段 05:30-08:00</div>
                        </div>
                        <div class="logistics-dispatch-warehouse-rounds" id="warehouse-rounds-hb">
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次1</span>
                            <span class="round-range">05:30-08:00</span>
                            <span class="round-cargo">1.4 吨</span>
                            <span class="round-docs">分拣单 52 单、强配 10 单</span>
                          </div>
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次2</span>
                            <span class="round-range">12:00-14:00</span>
                            <span class="round-cargo">0.5 吨</span>
                            <span class="round-docs">抢菜 6 单、调拨 4 单</span>
                          </div>
                        </div>
                      </div>
                      <div class="logistics-dispatch-warehouse-card logistics-dispatch-warehouse-expandable" data-warehouse="xn" onclick="logisticsDispatchToggleWarehouse('xn')">
                        <div class="logistics-dispatch-warehouse-header">
                          <span class="logistics-dispatch-warehouse-name">西南仓</span>
                          <span class="logistics-dispatch-warehouse-badges">
                            <span class="logistics-dispatch-round-badge">1 批次</span>
                            <span class="logistics-dispatch-status logistics-dispatch-status-ok">充足</span>
                          </span>
                          <span class="logistics-dispatch-warehouse-chevron" id="warehouse-chevron-xn">▼</span>
                        </div>
                        <div class="logistics-dispatch-warehouse-summary">
                          <div class="logistics-dispatch-metric"><span class="label">作业量</span><span class="value">+2%</span></div>
                          <div class="logistics-dispatch-metric"><span class="label">货物量</span><span class="value">0.9 吨</span></div>
                          <div class="logistics-dispatch-gap" style="color: var(--success);">人力运力充足</div>
                        </div>
                        <div class="logistics-dispatch-warehouse-rounds" id="warehouse-rounds-xn">
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次1</span>
                            <span class="round-range">06:00-08:00</span>
                            <span class="round-cargo">0.9 吨</span>
                            <span class="round-docs">分拣单 28 单、强配 6 单</span>
                          </div>
                        </div>
                      </div>
                      <div class="logistics-dispatch-warehouse-card logistics-dispatch-warehouse-expandable" data-warehouse="hz" onclick="logisticsDispatchToggleWarehouse('hz')">
                        <div class="logistics-dispatch-warehouse-header">
                          <span class="logistics-dispatch-warehouse-name">华中仓</span>
                          <span class="logistics-dispatch-warehouse-badges">
                            <span class="logistics-dispatch-round-badge">2 批次</span>
                            <span class="logistics-dispatch-status logistics-dispatch-status-warn">需调配</span>
                          </span>
                          <span class="logistics-dispatch-warehouse-chevron" id="warehouse-chevron-hz">▼</span>
                        </div>
                        <div class="logistics-dispatch-warehouse-summary">
                          <div class="logistics-dispatch-metric"><span class="label">作业量</span><span class="value">+6%</span></div>
                          <div class="logistics-dispatch-metric"><span class="label">货物量</span><span class="value">1.5 吨</span></div>
                          <div class="logistics-dispatch-gap">缺口：分拣 +1 人 · 需调配时段 06:15-08:45</div>
                        </div>
                        <div class="logistics-dispatch-warehouse-rounds" id="warehouse-rounds-hz">
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次1</span>
                            <span class="round-range">06:15-08:45</span>
                            <span class="round-cargo">1.1 吨</span>
                            <span class="round-docs">分拣单 38 单、强配 9 单</span>
                          </div>
                          <div class="logistics-dispatch-round-row">
                            <span class="round-time">批次2</span>
                            <span class="round-range">13:00-15:00</span>
                            <span class="round-cargo">0.4 吨</span>
                            <span class="round-docs">T+2 补货 8 单</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>
                </div>
                <div class="logistics-dispatch-panel" id="logistics-dispatch-route">
                  <section class="timeline-section">
                    <div class="section-header">
                      <h2>今日车次与路线</h2>
                      <span class="date" style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted);">24 车次</span>
                    </div>
                    <div class="logistics-dispatch-route-list" id="logisticsDispatchRouteList">
                      <div class="logistics-dispatch-route-card">
                        <div class="logistics-dispatch-route-header">
                          <span class="logistics-dispatch-route-id">车次 01</span>
                          <span class="logistics-dispatch-route-status">已下发</span>
                        </div>
                        <div class="logistics-dispatch-route-body">
                          <div class="logistics-dispatch-route-row"><span class="label">司机</span><span>王师傅</span></div>
                          <div class="logistics-dispatch-route-row logistics-dispatch-vehicle-info">
                            <span class="label">车辆</span>
                            <span>4.2m 厢式货车 · 容积 15m³ · 载重 2.5 吨</span>
                          </div>
                          <div class="logistics-dispatch-route-row"><span class="label">全程用时</span><span>约 4h 20min</span></div>
                          <div class="logistics-dispatch-route-path">
                            <span class="label">完整路线</span>
                            <div class="route-path-full">
                              华东仓(06:00) → 菜湖店(06:35, 15min) → 南坪店(07:15, 12min) → 江北店(07:55, 18min) → 沙坪坝店(08:40, 10min) → 杨家坪店(09:20, 15min) → 渝北店(09:55, 12min) → 北碚店(10:35, 10min) → 回仓(11:20)
                            </div>
                          </div>
                          <div class="logistics-dispatch-loading-detail">
                            <span class="label">装载明细</span>
                            <table class="loading-detail-table">
                              <tr><th>品名</th><th>规格</th><th>数量</th><th>重量</th><th>装载位</th></tr>
                              <tr><td>小白菜</td><td>散装/斤</td><td>—</td><td>45 kg</td><td>下层</td></tr>
                              <tr><td>油麦菜</td><td>散装/斤</td><td>—</td><td>32 kg</td><td>下层</td></tr>
                              <tr><td>有机西红柿</td><td>盒装 500g</td><td>24 盒</td><td>12 kg</td><td>中层</td></tr>
                              <tr><td>鲜鸡蛋</td><td>30 枚/盒</td><td>18 盒</td><td>9 kg</td><td>中层</td></tr>
                              <tr><td>排骨</td><td>散称/斤</td><td>—</td><td>25 kg</td><td>冷藏</td></tr>
                              <tr><td>鲜奶</td><td>250ml×12</td><td>15 件</td><td>45 kg</td><td>冷藏</td></tr>
                            </table>
                          </div>
                          <div class="logistics-dispatch-cost-detail">
                            <span class="label">预估成本</span>
                            <div class="cost-breakdown">油费 ¥68 · 人工 ¥80 · 损耗 ¥18 · 其他 ¥20 = <strong>合计 ¥186</strong></div>
                          </div>
                        </div>
                      </div>
                      <div class="logistics-dispatch-route-card">
                        <div class="logistics-dispatch-route-header">
                          <span class="logistics-dispatch-route-id">车次 02</span>
                          <span class="logistics-dispatch-route-status">已下发</span>
                        </div>
                        <div class="logistics-dispatch-route-body">
                          <div class="logistics-dispatch-route-row"><span class="label">司机</span><span>李师傅</span></div>
                          <div class="logistics-dispatch-route-row logistics-dispatch-vehicle-info">
                            <span class="label">车辆</span>
                            <span>3.5m 冷藏车 · 容积 10m³ · 载重 1.5 吨</span>
                          </div>
                          <div class="logistics-dispatch-route-row"><span class="label">全程用时</span><span>约 3h 15min</span></div>
                          <div class="logistics-dispatch-route-path">
                            <span class="label">完整路线</span>
                            <div class="route-path-full">
                              华东仓(06:30) → 渝北店(07:05, 12min) → 北碚店(07:45, 10min) → 两路店(08:25, 15min) → 龙溪店(09:00, 12min) → 回龙观店(09:35, 10min) → 回仓(10:00)
                            </div>
                          </div>
                          <div class="logistics-dispatch-loading-detail">
                            <span class="label">装载明细</span>
                            <table class="loading-detail-table">
                              <tr><th>品名</th><th>规格</th><th>数量</th><th>重量</th><th>装载位</th></tr>
                              <tr><td>排骨</td><td>散称/斤</td><td>—</td><td>35 kg</td><td>冷藏</td></tr>
                              <tr><td>五花肉</td><td>散称/斤</td><td>—</td><td>28 kg</td><td>冷藏</td></tr>
                              <tr><td>鲜鸡蛋</td><td>30 枚/盒</td><td>24 盒</td><td>12 kg</td><td>中层</td></tr>
                              <tr><td>鲜奶</td><td>250ml×12</td><td>12 件</td><td>36 kg</td><td>冷藏</td></tr>
                              <tr><td>叶菜组合</td><td>多品混装</td><td>—</td><td>31 kg</td><td>下层</td></tr>
                            </table>
                          </div>
                          <div class="logistics-dispatch-cost-detail">
                            <span class="label">预估成本</span>
                            <div class="cost-breakdown">油费 ¥52 · 人工 ¥60 · 损耗 ¥15 · 其他 ¥15 = <strong>合计 ¥142</strong></div>
                          </div>
                        </div>
                      </div>
                      <div class="logistics-dispatch-route-card">
                        <div class="logistics-dispatch-route-header">
                          <span class="logistics-dispatch-route-id">车次 03</span>
                          <span class="logistics-dispatch-route-status logistics-dispatch-route-status-pending">待确认</span>
                        </div>
                        <div class="logistics-dispatch-route-body">
                          <div class="logistics-dispatch-route-row"><span class="label">司机</span><span>张师傅</span></div>
                          <div class="logistics-dispatch-route-row logistics-dispatch-vehicle-info">
                            <span class="label">车辆</span>
                            <span>4.2m 厢式货车 · 容积 15m³ · 载重 2.5 吨</span>
                          </div>
                          <div class="logistics-dispatch-route-row"><span class="label">全程用时</span><span>约 3h 50min</span></div>
                          <div class="logistics-dispatch-route-path">
                            <span class="label">完整路线</span>
                            <div class="route-path-full">
                              华东仓(07:00) → 南岸店(07:40, 15min) → 巴南店(08:25, 12min) → 南坪店(09:05, 18min) → 弹子石店(09:50, 10min) → 茶园店(10:25, 12min) → 鱼洞店(11:00, 10min) → 回仓(11:35)
                            </div>
                          </div>
                          <div class="logistics-dispatch-loading-detail">
                            <span class="label">装载明细</span>
                            <table class="loading-detail-table">
                              <tr><th>品名</th><th>规格</th><th>数量</th><th>重量</th><th>装载位</th></tr>
                              <tr><td>草莓</td><td>盒装 250g</td><td>20 盒</td><td>5 kg</td><td>上层</td></tr>
                              <tr><td>鲜切菠萝</td><td>盒装 300g</td><td>15 盒</td><td>4.5 kg</td><td>上层</td></tr>
                              <tr><td>油麦菜</td><td>散装/斤</td><td>—</td><td>38 kg</td><td>下层</td></tr>
                              <tr><td>莴笋</td><td>散装/斤</td><td>—</td><td>25 kg</td><td>下层</td></tr>
                              <tr><td>有机鸡蛋</td><td>15 枚/盒</td><td>20 盒</td><td>10 kg</td><td>中层</td></tr>
                            </table>
                          </div>
                          <div class="logistics-dispatch-cost-detail">
                            <span class="label">预估成本</span>
                            <div class="cost-breakdown">油费 ¥58 · 人工 ¥75 · 损耗 ¥20 · 其他 ¥15 = <strong>合计 ¥168</strong></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </section>
                </div>
              </div>
              <div class="docflow-right">
                <div class="docflow-ops-header">操作区</div>
                <div class="docflow-ops-section">
                  <h4>待确认调配</h4>
                  <div class="docflow-ops-card" id="logisticsDispatchPendingOps">
                    <div class="docflow-ops-item docflow-ops-item-alert" data-alloc-id="alloc-1">
                      <span class="docflow-ops-label">华东仓 +2 人 +1 车</span>
                      <span class="docflow-ops-meta docflow-ops-meta-danger">06:00-08:30、09:00-11:00 · 强配集中</span>
                      <div class="logistics-dispatch-alloc-actions">
                        <button class="ops-btn primary" onclick="event.stopPropagation(); logisticsDispatchConfirm('alloc-1')">确认</button>
                        <button class="ops-btn" onclick="event.stopPropagation(); logisticsDispatchReject('alloc-1')">驳回</button>
                      </div>
                    </div>
                    <div class="docflow-ops-item" data-alloc-id="alloc-2">
                      <span class="docflow-ops-label">华北仓 +1 人</span>
                      <span class="docflow-ops-meta">05:30-08:00 · 周末前峰</span>
                      <div class="logistics-dispatch-alloc-actions">
                        <button class="ops-btn primary" onclick="event.stopPropagation(); logisticsDispatchConfirm('alloc-2')">确认</button>
                        <button class="ops-btn" onclick="event.stopPropagation(); logisticsDispatchReject('alloc-2')">驳回</button>
                      </div>
                    </div>
                    <div class="docflow-ops-item" data-alloc-id="alloc-3">
                      <span class="docflow-ops-label">华中仓 +1 人</span>
                      <span class="docflow-ops-meta">06:15-08:45 · 周末前峰</span>
                      <div class="logistics-dispatch-alloc-actions">
                        <button class="ops-btn primary" onclick="event.stopPropagation(); logisticsDispatchConfirm('alloc-3')">确认</button>
                        <button class="ops-btn" onclick="event.stopPropagation(); logisticsDispatchReject('alloc-3')">驳回</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="docflow-ops-section">
                  <h4>AI 建议摘要</h4>
                  <div class="docflow-ops-card">
                    <div class="report-box success" style="margin: 0; padding: 12px;">
                      <strong>人力缺口：</strong>华东 +2（06:00-11:00）、华北 +1（05:30-08:00）、华中 +1（06:15-08:45）<br>
                      <strong>运力缺口：</strong>华东 +1 车（06:00-11:00）<br>
                      <strong>建议：</strong>优先调配华东，华北/华中可从华南/西南借调
                    </div>
                  </div>
                </div>
                <div class="docflow-ops-section">
                  <h4>快捷操作</h4>
                  <div class="ops-quick-row">
                    <button class="inspection-config-btn" onclick="showLogisticsDispatchConfigModal()">配置调度规则</button>
                    <button class="inspection-config-btn" onclick="logisticsDispatchExport()">导出调配表</button>
                    <button class="inspection-config-btn" onclick="logisticsDispatchSendNotice()">发送调度通知</button>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- 市调选品 -->
          <div id="scene-market" class="scene-panel">
            <div class="card">
              <div class="card-title">市调选品分析</div>
              <p class="detail" style="margin-bottom: 20px; color: var(--text-secondary); font-size: 13px;">
                数据源（Excel 上传或系统选今日市调）→ 竞品分析 + 自有商品结构 → 是否引入、定价、采购量与决策原因
              </p>
              <div class="data-source-card">
                <div style="margin-bottom: 12px; font-weight: 500;">数据源</div>
                <div class="upload-zone">
                  <input type="text" readonly value="上传 Excel 市调商品采集结构" style="flex:1; min-width: 200px; padding: 8px 12px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                  <button class="upload-btn">上传</button>
                  <span style="color: var(--text-muted);">或</span>
                  <input type="text" readonly id="marketSelectInput" value="从系统选指定日期市调结果数据" style="flex:1; min-width: 200px; padding: 8px 12px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                  <button class="select-btn" onclick="showMarketSelectModal()">选择</button>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card" style="margin: 0;">
                  <div class="card-title">市调/竞品列表</div>
                  <table class="data-table">
                    <tr><th>商品</th><th>竞品价格</th><th>门店/品类</th></tr>
                    <tr><td>小白菜</td><td>¥2.98/斤</td><td>永辉·菜湖</td></tr>
                    <tr><td>有机西红柿</td><td>¥6.20/斤</td><td>盒马·江北</td></tr>
                    <tr><td>莴果</td><td>¥5.80/斤</td><td>永辉·菜湖</td></tr>
                    <tr><td>油麦菜</td><td>¥2.38/斤</td><td>永辉·南坪</td></tr>
                    <tr><td>有机鸡蛋</td><td>¥2.18/枚</td><td>盒马·江北</td></tr>
                    <tr><td>鲜切菠萝</td><td>¥13.80/盒</td><td>沃尔玛·沙坪坝</td></tr>
                    <tr><td>草莓</td><td>¥21.80/斤</td><td>永辉·菜湖</td></tr>
                    <tr><td>预制红烧肉</td><td>¥32.00/盒</td><td>盒马·江北</td></tr>
                  </table>
                </div>
                <div class="card" style="margin: 0;">
                  <div class="card-title">竞品分析 + 自有商品结构</div>
                  <p style="font-size: 12px; margin-bottom: 8px;">竞品对比：价格</p>
                  <p style="font-size: 12px; margin-bottom: 8px;">自有结构：同类商品有无、卖点空闲等</p>
                  <p style="font-size: 12px; color: var(--accent);">AI 分析 → 是否引入、定价、采购量、决策原因</p>
                  <button class="btn btn-primary" style="margin-top: 12px;">开始分析</button>
                </div>
              </div>
              <div class="card" style="margin: 0;">
                <div class="card-header-row">
                  <div class="card-title">AI 引入决策建议</div>
                  <div class="export-dropdown" id="aiDecisionExportDropdown">
                    <button class="export-trigger" onclick="toggleExportDropdown('aiDecisionExportDropdown')">导出</button>
                    <div class="export-dropdown-menu">
                      <button onclick="exportAiDecision('excel')">📊 导出为 Excel</button>
                      <button onclick="exportAiDecision('pdf')">📄 导出为 PDF</button>
                    </div>
                  </div>
                </div>
                <table class="data-table data-table-actions" id="aiDecisionTable">
                  <tr><th>商品</th><th>是否引入</th><th>定价建议</th><th>采购量建议</th><th>决策原因</th><th>操作</th></tr>
                  <tr>
                    <td>小白菜</td>
                    <td style="color: var(--success);">建议引入</td>
                    <td>¥2.60~2.80/斤</td>
                    <td>80~120 kg/周</td>
                    <td>竞品价有优势；自有菜湖空闲；季节销量上升；库存充足可控制采购额</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('小白菜', '¥2.60~2.80/斤', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>有机西红柿</td>
                    <td style="color: var(--success);">建议引入</td>
                    <td>¥5.80~6.20/斤</td>
                    <td>40~60 kg/周</td>
                    <td>竞品缺货；毛利空间充足；可替代普通西红柿高端卖点</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('有机西红柿', '¥5.80~6.20/斤', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>莴果</td>
                    <td style="color: var(--text-muted);">暂不引入</td>
                    <td>—</td>
                    <td>—</td>
                    <td>同类已有莴果卖点，销量平平；促销后再考虑引入</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('莴果', '—', false)">引入</button></td>
                  </tr>
                  <tr>
                    <td>进口牛油果</td>
                    <td style="color: var(--text-muted);">暂不引入</td>
                    <td>—</td>
                    <td>—</td>
                    <td>竞品价格过高；损耗风险大；门店客群匹配度低</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('进口牛油果', '—', false)">引入</button></td>
                  </tr>
                  <tr>
                    <td>鲜切菠萝</td>
                    <td style="color: var(--accent);">建议限量试销</td>
                    <td>¥12.80/盒</td>
                    <td>20~30 盒/周</td>
                    <td>新品；先试销 2 周观察动销；可放水果区引流</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('鲜切菠萝', '¥12.80/盒', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>油麦菜</td>
                    <td style="color: var(--warning);">建议汰换后引入</td>
                    <td>¥2.20~2.40/斤</td>
                    <td>50~80 kg/周</td>
                    <td>可替代滞销莴苣卖点；竞品价有优势；需先清空莴苣库存</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('油麦菜', '¥2.20~2.40/斤', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>有机鸡蛋</td>
                    <td style="color: var(--success);">建议引入</td>
                    <td>¥1.98/枚</td>
                    <td>200~300 枚/周</td>
                    <td>与小白菜组合促销；毛利可控；蛋品区有空位</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('有机鸡蛋', '¥1.98/枚', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>冷冻虾仁</td>
                    <td style="color: var(--text-muted);">暂不引入</td>
                    <td>—</td>
                    <td>—</td>
                    <td>毛利不足；冷冻柜位紧张；需评估冷链能力</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('冷冻虾仁', '—', false)">引入</button></td>
                  </tr>
                  <tr>
                    <td>草莓</td>
                    <td style="color: var(--accent);">建议引入但需观察</td>
                    <td>¥18.80~22.00/斤</td>
                    <td>30~50 kg/周</td>
                    <td>季节上行；损耗需控；建议先小量试销 1 周</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('草莓', '¥18.80~22.00/斤', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>预制红烧肉</td>
                    <td style="color: var(--success);">建议引入</td>
                    <td>¥28.00~32.00/盒</td>
                    <td>15~25 盒/周</td>
                    <td>预制菜趋势；竞品热销；可补充熟食区品类</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('预制红烧肉', '¥28.00~32.00/盒', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>进口车厘子</td>
                    <td style="color: var(--text-muted);">暂不引入</td>
                    <td>—</td>
                    <td>—</td>
                    <td>季节因素；价格波动大；建议春节档再评估</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('进口车厘子', '—', false)">引入</button></td>
                  </tr>
                  <tr>
                    <td>酸奶组合装</td>
                    <td style="color: var(--accent);">建议与现有组合引入</td>
                    <td>¥19.90/组</td>
                    <td>50~80 组/周</td>
                    <td>可与鲜奶组合促销；标品区有空位；竞品活动频繁</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('酸奶组合装', '¥19.90/组', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>有机菠菜</td>
                    <td style="color: var(--warning);">库存不足暂缓引入</td>
                    <td>¥4.50~5.00/斤</td>
                    <td>—</td>
                    <td>供应商产能有限；建议 2 周后再评估补货</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('有机菠菜', '¥4.50~5.00/斤', true)">引入</button></td>
                  </tr>
                  <tr>
                    <td>散装坚果</td>
                    <td style="color: var(--text-muted);">暂不引入</td>
                    <td>—</td>
                    <td>—</td>
                    <td>需新增散装设备；投入产出比待评估</td>
                    <td><button class="btn-link" onclick="showProductIntroduceModal('散装坚果', '—', false)">引入</button></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>

          <!-- 合同智检 -->
          <div id="scene-contract" class="scene-panel">
            <div class="card">
              <div class="card-title">合同智检</div>
              <p class="detail" style="margin-bottom: 20px; color: var(--text-secondary); font-size: 13px;">
                选择系统合同模版或上传 Word/PDF → AI 风险识别与标注 → 风险清单与建议修改 → 支持对话式优化模版
              </p>
              <div class="data-source-card">
                <div style="margin-bottom: 12px; font-weight: 500;">合同来源</div>
                <div class="upload-zone">
                  <input type="text" readonly id="contractTemplateInput" value="从系统选择合同模版" style="flex:1; min-width: 200px; padding: 8px 12px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                  <button class="select-btn" onclick="showContractTemplateModal()">选择模版</button>
                  <span style="color: var(--text-muted);">或</span>
                  <input type="text" readonly value="上传 Word 或 PDF 合同" style="flex:1; min-width: 200px; padding: 8px 12px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                  <button class="upload-btn">上传</button>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card" style="margin: 0;">
                  <div class="card-title">系统合同模版</div>
                  <table class="data-table">
                    <tr><th>模版名称</th><th>类型</th><th>上次智检</th><th>风险等级及数量</th></tr>
                    <tr><td>采购主合同</td><td>采购</td><td>2026-01-15</td><td><span class="contract-risk-summary-inline"><span style="color:var(--danger)">高3</span> <span style="color:var(--warning)">中4</span> <span style="color:var(--text-muted)">低1</span></span></td></tr>
                    <tr><td>生鲜补充协议</td><td>采购</td><td>2026-01-12</td><td><span class="contract-risk-summary-inline"><span style="color:var(--danger)">高1</span> <span style="color:var(--warning)">中1</span></span></td></tr>
                    <tr><td>快消补充协议</td><td>采购</td><td>2026-01-10</td><td><span class="contract-risk-summary-inline"><span style="color:var(--warning)">中1</span></span></td></tr>
                    <tr><td>加盟合同</td><td>加盟</td><td>2025-12-28</td><td><span class="contract-risk-summary-inline"><span style="color:var(--danger)">高1</span></span></td></tr>
                    <tr><td>商品联营合同</td><td>联营</td><td>2025-12-20</td><td><span class="contract-risk-summary-inline" style="color:var(--text-muted)">0</span></td></tr>
                  </table>
                </div>
                <div class="card" style="margin: 0;">
                  <div class="card-title">本次智检概览</div>
                  <div class="contract-risk-summary">
                    <div class="contract-risk-stat">
                      <span class="contract-risk-stat-val" style="color: var(--danger);">3</span>
                      <span class="contract-risk-stat-label">高风险</span>
                    </div>
                    <div class="contract-risk-stat">
                      <span class="contract-risk-stat-val" style="color: var(--warning);">5</span>
                      <span class="contract-risk-stat-label">中风险</span>
                    </div>
                    <div class="contract-risk-stat">
                      <span class="contract-risk-stat-val" style="color: var(--text-muted);">2</span>
                      <span class="contract-risk-stat-label">低风险</span>
                    </div>
                  </div>
                  <p style="font-size: 12px; margin-bottom: 8px;">当前分析：采购主合同</p>
                  <p style="font-size: 12px; color: var(--accent);">AI 已标注 10 处风险，建议优先处理违约金条款与争议解决方式</p>
                  <button class="btn btn-primary" style="margin-top: 12px;">开始智检</button>
                </div>
              </div>
              <div class="card" style="margin: 0;">
                <div class="card-title">风险清单与建议</div>
                <div class="contract-risk-select-row">
                  <span class="contract-risk-select-label">选择模版：</span>
                  <select class="contract-risk-select" id="contractRiskTemplateSelect" onchange="filterContractRisksByTemplate(this.value)">
                    <option value="all">全部模版</option>
                    <option value="采购主合同">采购主合同</option>
                    <option value="生鲜补充协议">生鲜补充协议</option>
                    <option value="快消补充协议">快消补充协议</option>
                    <option value="加盟合同">加盟合同</option>
                    <option value="商品联营合同">商品联营合同</option>
                  </select>
                </div>
                <div id="contractRiskContent">
                  <!-- 全部模版：按模版分组展示 -->
                  <div id="contractRiskAll" class="contract-risk-all">
                    <div class="contract-risk-group" data-template="采购主合同">
                      <div class="contract-risk-group-header">
                        <span class="contract-risk-group-title">采购主合同</span>
                        <span class="contract-risk-group-count">7 条修正</span>
                        <button class="btn-sm btn-primary" onclick="openContractOptimizeModal('采购主合同')">一键修正</button>
                      </div>
                      <table class="data-table data-table-actions">
                        <tr><th>条款位置</th><th>风险等级</th><th>风险类型</th><th>风险描述</th><th>建议修改</th><th>操作</th></tr>
                        <tr><td>第 7.2 条</td><td><span class="risk-badge risk-high">高</span></td><td>违约金</td><td>违约金比例 30% 过高，超出法定上限</td><td>建议调整为日万分之五或年 24% 以内</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 0)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 9.3 条</td><td><span class="risk-badge risk-high">高</span></td><td>争议解决</td><td>约定仲裁但未明确仲裁机构</td><td>补充具体仲裁机构名称，如「重庆仲裁委员会」</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 1)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 5.1 条</td><td><span class="risk-badge risk-high">高</span></td><td>付款条款</td><td>账期 90 天对供应商资金压力大</td><td>建议缩短至 60 天或增加提前付款折扣条款</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 2)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 4.2 条</td><td><span class="risk-badge risk-mid">中</span></td><td>质量异议</td><td>异议期 3 天过短，生鲜品类易引发纠纷</td><td>建议延长至 7 天，并明确书面异议形式</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 3)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 6.1 条</td><td><span class="risk-badge risk-mid">中</span></td><td>权利义务</td><td>退换货条件表述模糊，「质量问题」未定义</td><td>补充质量问题的具体认定标准或引用国标</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 4)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 8.1 条</td><td><span class="risk-badge risk-mid">中</span></td><td>保密条款</td><td>保密期限「合同终止后 2 年」可能不足</td><td>可考虑延长至 5 年或约定「合理必要期限」</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 5)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 3.2 条</td><td><span class="risk-badge risk-low">低</span></td><td>格式规范</td><td>条款编号与引用存在不一致</td><td>统一编号格式，修正交叉引用</td><td><button class="btn-link" onclick="openContractOptimizeModal('采购主合同', 6)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                      </table>
                    </div>
                    <div class="contract-risk-group" data-template="生鲜补充协议">
                      <div class="contract-risk-group-header">
                        <span class="contract-risk-group-title">生鲜补充协议</span>
                        <span class="contract-risk-group-count">2 条修正</span>
                        <button class="btn-sm btn-primary" onclick="openContractOptimizeModal('生鲜补充协议')">一键修正</button>
                      </div>
                      <table class="data-table data-table-actions">
                        <tr><th>条款位置</th><th>风险等级</th><th>风险类型</th><th>风险描述</th><th>建议修改</th><th>操作</th></tr>
                        <tr><td>第 2.1 条</td><td><span class="risk-badge risk-high">高</span></td><td>损耗责任</td><td>损耗责任未明确划分，生鲜品类易产生争议</td><td>补充损耗比例及责任承担方式</td><td><button class="btn-link" onclick="openContractOptimizeModal('生鲜补充协议', 0)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                        <tr><td>第 2.3 条</td><td><span class="risk-badge risk-mid">中</span></td><td>保质期</td><td>保质期表述「按国标」过于笼统</td><td>明确具体保质期要求或引用 GB 标准条款</td><td><button class="btn-link" onclick="openContractOptimizeModal('生鲜补充协议', 1)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                      </table>
                    </div>
                    <div class="contract-risk-group" data-template="快消补充协议">
                      <div class="contract-risk-group-header">
                        <span class="contract-risk-group-title">快消补充协议</span>
                        <span class="contract-risk-group-count">1 条修正</span>
                        <button class="btn-sm btn-primary" onclick="openContractOptimizeModal('快消补充协议')">一键修正</button>
                      </div>
                      <table class="data-table data-table-actions">
                        <tr><th>条款位置</th><th>风险等级</th><th>风险类型</th><th>风险描述</th><th>建议修改</th><th>操作</th></tr>
                        <tr><td>第 1.2 条</td><td><span class="risk-badge risk-mid">中</span></td><td>临期处理</td><td>临期商品处理方式未约定</td><td>补充临期 90/60/30 天不同处理方式及折扣比例</td><td><button class="btn-link" onclick="openContractOptimizeModal('快消补充协议', 0)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                      </table>
                    </div>
                    <div class="contract-risk-group" data-template="加盟合同">
                      <div class="contract-risk-group-header">
                        <span class="contract-risk-group-title">加盟合同</span>
                        <span class="contract-risk-group-count">1 条修正</span>
                        <button class="btn-sm btn-primary" onclick="openContractOptimizeModal('加盟合同')">一键修正</button>
                      </div>
                      <table class="data-table data-table-actions">
                        <tr><th>条款位置</th><th>风险等级</th><th>风险类型</th><th>风险描述</th><th>建议修改</th><th>操作</th></tr>
                        <tr><td>第 5.2 条</td><td><span class="risk-badge risk-high">高</span></td><td>保证金</td><td>保证金退还条件表述模糊</td><td>明确退还条件、时限及扣除情形</td><td><button class="btn-link" onclick="openContractOptimizeModal('加盟合同', 0)">修正</button> <button class="btn-link" onclick="showToast('已标记为不予修改')">不予修改</button></td></tr>
                      </table>
                    </div>
                    <div class="contract-risk-group" data-template="商品联营合同">
                      <div class="contract-risk-group-header">
                        <span class="contract-risk-group-title">商品联营合同</span>
                        <span class="contract-risk-group-count">0 条修正</span>
                      </div>
                      <p class="contract-risk-empty">该模版暂无风险修正项</p>
                    </div>
                  </div>
                  <!-- 单个模版：仅展示对应模版的修正条款 -->
                  <div id="contractRiskSingle" class="contract-risk-single" style="display: none;">
                    <div class="contract-risk-single-header" id="contractRiskSingleHeader"></div>
                    <div id="contractRiskSingleBody">
                      <table class="data-table" id="contractRiskSingleTable"></table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card" style="margin: 0;">
                <div class="card-title">AI 模版优化</div>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">输入您的修改需求，AI 将根据风险清单对模版进行优化并生成修订稿</p>
                <div class="input-area">
                  <input type="text" placeholder="例如：将违约金调整为日万分之五，补充重庆仲裁委员会为争议解决机构…" id="contractOptimizeInput">
                  <button class="btn btn-primary" onclick="contractOptimize()">生成优化稿</button>
                </div>
                <div class="quick-asks" style="margin-top: 12px;">
                  <span style="font-size: 12px; color: var(--text-muted); margin-right: 8px;">快捷需求：</span>
                  <span class="quick-ask">按风险清单逐条修正</span>
                  <span class="quick-ask">仅修正高/中风险项</span>
                  <span class="quick-ask">增加我方有利条款</span>
                  <span class="quick-ask">缩短账期并增加付款灵活性</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 财务 -->
          <div id="scene-finance" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">本月销售凭证与金蝶差异有哪些？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="background: var(--accent-dim); padding: 14px 18px; border-radius: 10px; margin-bottom: 16px;">
                        共发现 2 类异常、1 类已自动处理；建议优先处理对账差异 320 元。
                      </div>
                      <div class="finance-item warn">
                        凭证 PZ-20260115-008 科目与规则库不一致，建议：应收账款_零售_微信
                      </div>
                      <div class="finance-item danger">
                        休库配送单 CD-20260114 与金蝶金额差 320 元，建议核对运费分摊
                      </div>
                      <div class="finance-item success">
                        已自动推荐科目并生成凭证 3 条，待审核。单据类型：加盟管理费 → 建议科目：加盟商辅助管理费/销项税 · 一键应用
                      </div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">打开销售对账明细表</button>
                        <button class="btn btn-ghost">待审批凭证列表</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">PZ-20260115-008 这个凭证具体哪里不对？能帮我修正吗？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">凭证 PZ-20260115-008 异常分析</div>
                      <table class="data-table">
                        <tr><th style="width: 120px;">字段</th><th>当前值</th><th>规则库建议</th></tr>
                        <tr><td>科目</td><td>应收账款_零售</td><td style="color: var(--accent);">应收账款_零售_微信</td></tr>
                        <tr><td>金额</td><td>¥1,280.00</td><td>—</td></tr>
                        <tr><td>来源</td><td>微信支付流水</td><td>需细分到微信渠道</td></tr>
                      </table>
                      <div class="detail" style="margin-top: 12px;">该笔为 1 月 15 日微信零售收款，规则库要求零售应收需按支付渠道细分。已为您生成修正建议，是否一键应用？</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">一键应用修正</button>
                        <button class="btn btn-ghost">手动修改</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">好的，帮我应用修正。顺便把本月报表摘要也给我</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">已应用修正 · 本月报表摘要</div>
                      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="kpi-card blue" style="padding: 14px;">
                          <div class="kpi-label">待审凭证</div>
                          <div class="kpi-value" style="font-size: 18px;">12 条</div>
                        </div>
                        <div class="kpi-card green" style="padding: 14px;">
                          <div class="kpi-label">已自动匹配</div>
                          <div class="kpi-value" style="font-size: 18px;">89%</div>
                        </div>
                        <div class="kpi-card orange" style="padding: 14px;">
                          <div class="kpi-label">对账差异</div>
                          <div class="kpi-value" style="font-size: 18px;">1 笔</div>
                        </div>
                      </div>
                      <div class="detail">凭证 PZ-20260115-008 已按规则库修正为「应收账款_零售_微信」。本月整体凭证自动化率 89%，较上月提升 3 个百分点。剩余 1 笔对账差异（CD-20260114）待您核对运费分摊后处理。</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 经营助手 -->
          <div id="scene-assistant" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="quick-asks" style="margin-bottom: 8px;">
                  <span class="quick-ask">今日门店销售如何？</span>
                  <span class="quick-ask">待审凭证有哪些？</span>
                  <span class="quick-ask">菜湖区滞销品有哪些？</span>
                  <span class="quick-ask">小白菜建议补多少？</span>
                  <span class="quick-ask">华东仓运力预测</span>
                  <span class="quick-ask">全国各仓入库出库分析</span>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">我们店今天下午客流比上周少，可能是什么原因？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">结合近 7 日数据，可能原因：</div>
                      <div class="detail">
                        1）今日时段销售对比：14:00-16:00 较上周同期 -15%<br>
                        2）周边竞品活动 · 可查看《经营实况》时段销售报表。需要我帮你打开吗？
                      </div>
                      <div class="detail" style="margin-top: 12px;">
                        建议：加强生鲜促销或调整陈列。是否生成促销建议单？
                      </div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">打开时段报表</button>
                        <button class="btn btn-ghost">生成促销建议单</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">能不能帮我看下具体是哪些时段下滑比较明显？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">今日 vs 上周同期 · 时段客流对比</div>
                      <table class="data-table">
                        <tr><th>时段</th><th>今日客流</th><th>上周同期</th><th>变化</th></tr>
                        <tr><td>10:00-12:00</td><td>128</td><td>125</td><td style="color: var(--success);">+2.4%</td></tr>
                        <tr><td>12:00-14:00</td><td>156</td><td>162</td><td style="color: var(--warning);">-3.7%</td></tr>
                        <tr><td>14:00-16:00</td><td>89</td><td>105</td><td style="color: var(--danger);">-15.2%</td></tr>
                        <tr><td>16:00-18:00</td><td>112</td><td>118</td><td style="color: var(--warning);">-5.1%</td></tr>
                        <tr><td>18:00-20:00</td><td>134</td><td>132</td><td style="color: var(--success);">+1.5%</td></tr>
                      </table>
                      <div class="detail">14:00-16:00 下滑最明显（-15.2%），其次是 16:00-18:00（-5.1%）。下午茶/买菜高峰时段受影响，可能与周边超市 14:00 开始的限时折扣有关。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">查看竞品活动</button>
                        <button class="btn btn-ghost">生成促销建议单</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">好的，帮我生成促销建议单吧</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">下午时段促销建议单（已生成）</div>
                      <div class="finance-item info" style="margin-bottom: 12px;">
                        <strong>活动时段：</strong>14:00-18:00 · 限时 4 小时<br>
                        <strong>主推品类：</strong>叶菜、蛋品、酸奶
                      </div>
                      <div class="finance-item success" style="margin-bottom: 12px;">
                        <strong>建议组合：</strong>小白菜 + 鸡蛋 组合价 ¥9.9（原价 ¥12.8）<br>
                        <strong>陈列建议：</strong>入口显眼位，配合「下午茶买菜」话术
                      </div>
                      <div class="detail" style="margin-top: 12px;">预计可拉升 14:00-16:00 客流 8-12%，已同步到活动创建页，是否一键发布？</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">一键发布活动</button>
                        <button class="btn btn-ghost">修改后再发</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 运力预测 -->
          <div id="scene-logistics" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">明天华东仓作业量会怎样？需要加人还是加车？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent);">基于今日分拣单、强配、抢菜、T+2 补货单汇总，华东仓明日预估作业量较昨日增约 15%。</div>
                      <div class="detail">建议：分拣临时 +2 人，运力 +1 车。</div>
                      <div class="detail">原因：强配单量集中、抢菜批次延后，建议提前调配人力与车辆。</div>
                      <div class="detail" style="font-size: 13px; color: var(--text-muted);">数据来源：分拣单、仓配单（强配）、采购单（抢菜）、T+2 补货单</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">那华南仓呢？压力大不大？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">华东 vs 华南 · 明日作业量对比</div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="kpi-card blue" style="padding: 16px;">
                          <div class="kpi-label">华东仓</div>
                          <div class="kpi-value" style="font-size: 18px;">+15%</div>
                          <div class="kpi-change">较昨日 · 建议 +2 人 +1 车</div>
                        </div>
                        <div class="kpi-card green" style="padding: 16px;">
                          <div class="kpi-label">华南仓</div>
                          <div class="kpi-value" style="font-size: 18px;">+3%</div>
                          <div class="kpi-change">较昨日 · 人力运力充足</div>
                        </div>
                      </div>
                      <div class="detail">华南仓明日作业量增幅较小，当前人力与运力可覆盖。华东压力主要来自强配单量集中，华南暂无类似情况。</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">能不能给个各仓人力调配建议表？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">全国各仓 · 明日人力运力调配建议</div>
                      <table class="data-table">
                        <tr><th>区域仓</th><th>作业量变化</th><th>分拣人力</th><th>运力</th><th>备注</th></tr>
                        <tr><td>华东</td><td style="color: var(--danger);">+15%</td><td>+2 人</td><td>+1 车</td><td>强配集中</td></tr>
                        <tr><td>华南</td><td style="color: var(--success);">+3%</td><td>—</td><td>—</td><td>充足</td></tr>
                        <tr><td>华北</td><td style="color: var(--warning);">+8%</td><td>+1 人</td><td>—</td><td>可调配</td></tr>
                        <tr><td>西南</td><td style="color: var(--success);">+2%</td><td>—</td><td>—</td><td>充足</td></tr>
                        <tr><td>华中</td><td style="color: var(--warning);">+6%</td><td>+1 人</td><td>—</td><td>周末前峰</td></tr>
                      </table>
                      <div class="detail" style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">华东仓建议优先调配，华北/华中可考虑从华南/西南临时借调 1 人。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">导出调配表</button>
                        <button class="btn btn-ghost">发送调度通知</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 报表分析 -->
          <div id="scene-report" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">最近全国各仓的入库、出库情况帮我分析下，有什么建议？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent);">已归集全国 12 个区域仓近 7 日报表并合并分析。</div>
                      <div class="detail">入库：华东同比 +12%，华南 +8%；出库：西南略降 -3%，华北持平。</div>
                      <div class="detail">建议与规划：</div>
                      <div class="detail">1）关注华东库容利用率，建议加强周转；2）西南出库下滑可排查订单与配送时效。</div>
                      <div class="detail" style="font-size: 13px; color: var(--text-muted);">数据来源：全国仓库报表自动归集与汇总</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">西南仓出库下滑具体是哪些品类？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">西南仓 · 近 7 日出库品类明细（较上周）</div>
                      <table class="data-table">
                        <tr><th>品类</th><th>出库量变化</th><th>占比</th><th>可能原因</th></tr>
                        <tr><td>蔬菜</td><td style="color: var(--danger);">-8.2%</td><td>32%</td><td>订单量下降</td></tr>
                        <tr><td>肉禽</td><td style="color: var(--warning);">-2.1%</td><td>28%</td><td>—</td></tr>
                        <tr><td>水果</td><td style="color: var(--success);">+3.5%</td><td>18%</td><td>—</td></tr>
                        <tr><td>标品</td><td style="color: var(--danger);">-5.6%</td><td>22%</td><td>配送时效影响</td></tr>
                      </table>
                      <div class="detail">蔬菜、标品下滑明显，蔬菜可能与门店订货节奏调整有关，标品可重点排查配送时效与缺货情况。</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">华东库容利用率多高？需要预警吗？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">华东仓 · 库容与周转指标</div>
                      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="kpi-card orange" style="padding: 14px;">
                          <div class="kpi-label">库容利用率</div>
                          <div class="kpi-value" style="font-size: 18px;">86%</div>
                          <div class="kpi-change">接近预警线 90%</div>
                        </div>
                        <div class="kpi-card blue" style="padding: 14px;">
                          <div class="kpi-label">平均周转天数</div>
                          <div class="kpi-value" style="font-size: 18px;">4.2 天</div>
                          <div class="kpi-change">较上周 -0.3 天</div>
                        </div>
                        <div class="kpi-card green" style="padding: 14px;">
                          <div class="kpi-label">入库峰值</div>
                          <div class="kpi-value" style="font-size: 18px;">+12%</div>
                          <div class="kpi-change">较上周</div>
                        </div>
                      </div>
                      <div class="report-box warn" style="margin-top: 12px;">
                        <strong>建议：</strong>库容 86% 已接近 90% 预警线，建议 1）加快出库周转；2）暂缓非紧急入库；3）可考虑临时外租仓分流。
                      </div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">设置库容预警</button>
                        <button class="btn btn-ghost">查看周转明细</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 门店经营分析 -->
          <div id="scene-store" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">本周销售、毛利、客流对比上周如何？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="kpi-grid">
                        <div class="kpi-card blue">
                          <div class="kpi-label">销售额</div>
                          <div class="kpi-value">12.8万</div>
                          <div class="kpi-change">+8.2%</div>
                        </div>
                        <div class="kpi-card green">
                          <div class="kpi-label">毛利额</div>
                          <div class="kpi-value">2.9万</div>
                          <div class="kpi-change">+5.1%</div>
                        </div>
                        <div class="kpi-card orange">
                          <div class="kpi-label">客流</div>
                          <div class="kpi-value">3,240</div>
                          <div class="kpi-change">+3.6%</div>
                        </div>
                        <div class="kpi-card red">
                          <div class="kpi-label">14:00-16:00</div>
                          <div class="kpi-value">-15%</div>
                          <div class="kpi-change">较上周</div>
                        </div>
                      </div>
                      <div class="report-box" style="background: var(--bg-elevated); margin: 16px 0;">
                        整体向好，销售额与毛利均超上周。下午时段客流下滑可能与周边竞品、天气有关，建议加强生鲜促销或调整陈列。
                      </div>
                      <button class="btn btn-primary">打开时段报表</button>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">14:00-16:00 下滑，和竞品有关系吗？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">14:00-16:00 客流下滑 · 关联分析</div>
                      <div class="finance-item warn" style="margin-bottom: 12px;">
                        <strong>竞品活动：</strong>周边永辉 14:00 起「叶菜限时 8 折」，持续 2 小时，与您店 14:00-16:00 客流下滑时段高度重合。
                      </div>
                      <div class="finance-item info" style="margin-bottom: 12px;">
                        <strong>天气：</strong>本周下午时段天气正常，无明显影响。
                      </div>
                      <div class="detail">综合判断：竞品限时折扣为主要因素，建议在 14:00-16:00 推出针对性促销，或提前至 13:30 启动以抢占客流。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">生成竞品应对方案</button>
                        <button class="btn btn-ghost">查看竞品活动详情</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">帮我生成改进计划</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">本周经营改进计划（已生成）</div>
                      <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>下午时段促销：</strong>14:00-16:00 叶菜 + 蛋品组合价 ¥9.9，提前至 13:30 启动</li>
                        <li><strong>陈列调整：</strong>入口显眼位增加「下午茶买菜」专区，突出性价比</li>
                        <li><strong>滞销处理：</strong>油麦菜、莴苣做限时折扣，降低周转压力</li>
                        <li><strong>下周关注：</strong>客单价、14:00-16:00 客流环比</li>
                      </ol>
                      <div class="report-box success" style="margin-top: 16px;">
                        预计可拉升 14:00-16:00 客流 8-12%，整体客单价保持或微增。是否一键同步到明日经营指引？
                      </div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">同步到经营指引</button>
                        <button class="btn btn-ghost">导出计划</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 商品结构 -->
          <div id="scene-product" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">菜湖区品类占比和滞销畅销、汰换建议？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">品类占比</div>
                      <div class="category-bar">
                        <span class="veg">蔬菜 42%</span>
                        <span class="meat">肉禽 28%</span>
                        <span class="fruit">水果 18%</span>
                        <span class="other">标品 12%</span>
                      </div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px;">
                        <div class="report-box success">
                          <div style="font-weight: 600; margin-bottom: 8px;">畅销 Top5</div>
                          排骨、五花肉、小白菜、苹果、香菇
                        </div>
                        <div class="report-box warn">
                          <div style="font-weight: 600; margin-bottom: 8px;">滞销 周转&lt;2</div>
                          <span style="background: var(--warning); padding: 2px 8px; border-radius: 4px; font-size: 11px;">促销售</span> 油麦菜、莴苣
                          <span style="background: var(--danger); padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 4px;">汰换</span> 西兰花
                          <button class="btn btn-primary" style="margin-top: 12px;">生成汰换建议单</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">西兰花为什么建议汰换？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">西兰花 · 汰换依据</div>
                      <table class="data-table">
                        <tr><th>指标</th><th>西兰花</th><th>品类均值</th><th>判断</th></tr>
                        <tr><td>近 7 日周转</td><td>1.2 次</td><td>2.8 次</td><td style="color: var(--danger);">远低于均值</td></tr>
                        <tr><td>动销率</td><td>42%</td><td>78%</td><td style="color: var(--danger);">低</td></tr>
                        <tr><td>损耗率</td><td>12%</td><td>5%</td><td style="color: var(--danger);">偏高</td></tr>
                        <tr><td>毛利贡献</td><td>-0.3%</td><td>+2.1%</td><td style="color: var(--danger);">负贡献</td></tr>
                      </table>
                      <div class="detail">西兰花周转低、损耗高、毛利负贡献，且与同品类小白菜、莴苣存在陈列竞争。建议汰换后腾出卖点给畅销蔬菜或新品。</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">油麦菜、莴苣先促销还是直接汰换？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">油麦菜、莴苣 · 促销 vs 汰换建议</div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="finance-item info">
                          <strong>油麦菜</strong><br>
                          周转 1.8 次，略低于均值。建议：<span style="color: var(--accent);">先促销</span>，与蛋品组合价可拉升动销，观察 1 周后再决定是否汰换。
                        </div>
                        <div class="finance-item info">
                          <strong>莴苣</strong><br>
                          周转 1.6 次，季节上行期。建议：<span style="color: var(--accent);">先促销</span>，限时 8 折或组合装，预计可提升至 2.2 次以上。
                        </div>
                      </div>
                      <div class="detail">两者均有促销空间，不建议直接汰换。先做 1 周促销，若周转仍低于 2 次再考虑汰换。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">生成促销方案</button>
                        <button class="btn btn-ghost">仅汰换西兰花</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 定价策略 -->
          <div id="scene-pricing" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">小白菜定价参考：竞品和成本？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary">建议零售 2.60–2.80 元/斤，毛利可控。</div>
                      <table class="data-table">
                        <tr><th>竞品价</th><th>成本</th><th>建议价</th><th>操作</th></tr>
                        <tr>
                          <td>2.60–2.98 元/斤<br><span style="font-size: 11px; color: var(--text-muted);">重庆店 ¥2.98</span></td>
                          <td>1.85 元/斤<br><span style="font-size: 11px; color: var(--text-muted);">损耗约 5%</span></td>
                          <td style="color: var(--accent); font-weight: 600;">2.60–2.80 元/斤<br><span style="font-size: 11px; color: var(--success);">毛利率 28–32%</span></td>
                          <td><button class="btn btn-primary">同步定价</button></td>
                        </tr>
                      </table>
                      <div style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">数据来源：市调、竞品库、采购成本</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">如果我想做引流，可以定多低？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">小白菜 · 引流价建议</div>
                      <table class="data-table">
                        <tr><th>策略</th><th>建议价</th><th>毛利率</th><th>适用场景</th></tr>
                        <tr><td>常规价</td><td>2.60–2.80 元/斤</td><td>28–32%</td><td>日常销售</td></tr>
                        <tr><td>引流价</td><td style="color: var(--accent); font-weight: 600;">1.98–2.18 元/斤</td><td>10–15%</td><td>限时/限购，带动关联</td></tr>
                        <tr><td>底线价</td><td>1.68 元/斤</td><td>约 0%</td><td>清仓/紧急促销</td></tr>
                      </table>
                      <div class="detail">引流价建议 1.98–2.18 元/斤，配合限购（如每人 2 斤）或时段限制（14:00–16:00），可有效拉客流且控制毛利损失。不建议长期低于 1.98。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">设置引流价</button>
                        <button class="btn btn-ghost">查看引流案例</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">成本最近有波动吗？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">小白菜 · 近 4 周采购成本趋势</div>
                      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="kpi-card blue" style="padding: 12px;"><div class="kpi-label">第1周</div><div class="kpi-value" style="font-size: 16px;">1.92</div><div class="kpi-change">元/斤</div></div>
                        <div class="kpi-card blue" style="padding: 12px;"><div class="kpi-label">第2周</div><div class="kpi-value" style="font-size: 16px;">1.88</div><div class="kpi-change">-2.1%</div></div>
                        <div class="kpi-card green" style="padding: 12px;"><div class="kpi-label">第3周</div><div class="kpi-value" style="font-size: 16px;">1.85</div><div class="kpi-change">-1.6%</div></div>
                        <div class="kpi-card orange" style="padding: 12px;"><div class="kpi-label">本周</div><div class="kpi-value" style="font-size: 16px;">1.85</div><div class="kpi-change">持平</div></div>
                      </div>
                      <div class="detail">成本近 4 周小幅下行，本周 1.85 元/斤与上周持平。预计下周随产地供应增加，成本或维持或略降，当前定价空间充足。</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>

          <!-- 智能补货 -->
          <div id="scene-replenish" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages">
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">下周小白菜、排骨补货建议量？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <table class="data-table">
                        <tr><th>商品</th><th>建议量</th><th>依据</th><th>操作</th></tr>
                        <tr>
                          <td>小白菜</td>
                          <td style="font-weight: 600; color: var(--accent);">80–120 kg/周</td>
                          <td>近7日销量 库存3日 季节上行</td>
                          <td><button class="btn btn-primary">同步</button></td>
                        </tr>
                        <tr>
                          <td>排骨</td>
                          <td style="font-weight: 600; color: var(--accent);">45–65 kg/周</td>
                          <td>销量趋势 周末高峰 当前库存</td>
                          <td><button class="btn btn-primary">同步</button></td>
                        </tr>
                      </table>
                      <button class="btn btn-ghost" style="margin-top: 12px;">批量同步补货</button>
                      <div style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">已融合销量、库存、季节、促销</div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">排骨周末会多卖吗？需要提前加量吗？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">排骨 · 周内销量分布（近 4 周均值）</div>
                      <table class="data-table">
                        <tr><th>星期</th><th>日均销量</th><th>较平日</th><th>建议</th></tr>
                        <tr><td>周一至周四</td><td>8.2 kg</td><td>—</td><td>基准</td></tr>
                        <tr><td>周五</td><td>11.5 kg</td><td style="color: var(--success);">+40%</td><td>提前备货</td></tr>
                        <tr><td>周六</td><td>14.2 kg</td><td style="color: var(--success);">+73%</td><td>重点加量</td></tr>
                        <tr><td>周日</td><td>12.8 kg</td><td style="color: var(--success);">+56%</td><td>保持充足</td></tr>
                      </table>
                      <div class="detail">周末（五、六、日）排骨销量明显高于平日，建议周五前补足至 55–65 kg，周六早高峰前再补 10–15 kg 以应对集中采购。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">按周末加量同步</button>
                        <button class="btn btn-ghost">查看历史趋势</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chat-msg chat-msg-user">
                  <div class="user-bubble">小白菜和排骨一起做组合促销怎么样？</div>
                </div>
                <div class="chat-msg chat-msg-ai">
                  <div class="ai-reply-box">
                    <div class="ai-reply-header">营营无忧</div>
                    <div class="ai-reply-content">
                      <div class="summary" style="font-weight: 600; color: var(--accent); margin-bottom: 12px;">小白菜 + 排骨 · 组合促销建议</div>
                      <div class="finance-item success" style="margin-bottom: 12px;">
                        <strong>组合方案：</strong>小白菜 2 斤 + 排骨 1 斤 · 组合价 ¥28.8（原价 ¥34.2，约 8.5 折）<br>
                        <strong>毛利：</strong>组合毛利约 22%，可接受
                      </div>
                      <div class="finance-item info" style="margin-bottom: 12px;">
                        <strong>补货建议：</strong>若做组合促销，小白菜建议量上调至 100–140 kg/周，排骨 55–75 kg/周，以应对关联销售拉升。
                      </div>
                      <div class="detail">两者关联度高（家常菜搭配），组合促销可拉升客单价与动销。建议周末重点推广，陈列上可做「家常小炒」专区。</div>
                      <div style="margin-top: 16px;">
                        <button class="btn btn-primary">生成组合促销方案</button>
                        <button class="btn btn-ghost">按组合量同步补货</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>
          <!-- 新对话（空白） -->
          <div id="scene-new-chat" class="scene-panel chat-layout">
            <div class="chat-body">
              <div class="chat-messages" id="newChatMessages"></div>
            </div>
            <div class="chat-input-bar">
              <div class="input-area">
                <input type="text" placeholder="输入你的问题...">
                <button class="btn btn-primary">发送</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast 提示容器 -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- 市调数据选择弹窗 -->
  <div class="modal-overlay" id="marketSelectModal">
    <div class="modal">
      <div class="modal-header">
        <h3>选择市调数据</h3>
        <button class="modal-close" onclick="closeMarketSelectModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 13px;">选择指定日期的市调采集结果，将自动加载竞品价格与商品结构</p>
        <table class="data-table" id="marketSelectTable">
          <tr><th></th><th>日期</th><th>门店</th><th>采集商品数</th><th>竞品门店</th><th>状态</th></tr>
          <tr class="market-select-row" data-date="2026-01-30" data-store="菜湖店" data-count="28" data-competitor="永辉·菜湖">
            <td><input type="radio" name="marketSelect" value="0"></td>
            <td>2026-01-30</td>
            <td>菜湖店</td>
            <td>28</td>
            <td>永辉·菜湖</td>
            <td style="color: var(--success);">已完成</td>
          </tr>
          <tr class="market-select-row" data-date="2026-01-29" data-store="江北店" data-count="32" data-competitor="盒马·江北">
            <td><input type="radio" name="marketSelect" value="1"></td>
            <td>2026-01-29</td>
            <td>江北店</td>
            <td>32</td>
            <td>盒马·江北</td>
            <td style="color: var(--success);">已完成</td>
          </tr>
          <tr class="market-select-row" data-date="2026-01-28" data-store="南坪店" data-count="24" data-competitor="永辉·南坪">
            <td><input type="radio" name="marketSelect" value="2"></td>
            <td>2026-01-28</td>
            <td>南坪店</td>
            <td>24</td>
            <td>永辉·南坪</td>
            <td style="color: var(--success);">已完成</td>
          </tr>
          <tr class="market-select-row" data-date="2026-01-27" data-store="菜湖店" data-count="26" data-competitor="永辉·菜湖">
            <td><input type="radio" name="marketSelect" value="3"></td>
            <td>2026-01-27</td>
            <td>菜湖店</td>
            <td>26</td>
            <td>永辉·菜湖</td>
            <td style="color: var(--success);">已完成</td>
          </tr>
          <tr class="market-select-row" data-date="2026-01-26" data-store="沙坪坝店" data-count="30" data-competitor="沃尔玛·沙坪坝">
            <td><input type="radio" name="marketSelect" value="4"></td>
            <td>2026-01-26</td>
            <td>沙坪坝店</td>
            <td>30</td>
            <td>沃尔玛·沙坪坝</td>
            <td style="color: var(--success);">已完成</td>
          </tr>
        </table>
        <div style="margin-top: 20px; display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="confirmMarketSelect()">确认选择</button>
          <button class="btn btn-ghost" onclick="closeMarketSelectModal()">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 商品引入进度弹窗 -->
  <div class="modal-overlay" id="productIntroduceModal">
    <div class="modal product-introduce-modal">
      <div class="modal-header">
        <h3>商品引入 · <span id="productIntroduceName">小白菜</span></h3>
        <button class="modal-close" onclick="closeProductIntroduceModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="product-introduce-info" id="productIntroduceInfo"></div>
        <div class="product-introduce-steps" id="productIntroduceSteps">
          <div class="introduce-step" data-step="0">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">数据校验</span>
              <span class="introduce-step-detail">是否主数据完整，且没有引入过</span>
            </div>
            <span class="introduce-step-status"></span>
          </div>
          <div class="introduce-step" data-step="1">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">创建商品</span>
              <span class="introduce-step-detail"></span>
            </div>
            <span class="introduce-step-status"></span>
          </div>
          <div class="introduce-step" data-step="2">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">上传图片</span>
              <span class="introduce-step-detail"></span>
            </div>
            <span class="introduce-step-status"></span>
          </div>
          <div class="introduce-step" data-step="3">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">调整价格</span>
              <span class="introduce-step-detail"></span>
            </div>
            <span class="introduce-step-status"></span>
          </div>
          <div class="introduce-step" data-step="4">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">设置规格等信息</span>
              <span class="introduce-step-detail">如需人工确认，请填写下方信息</span>
              <div class="introduce-step-input" id="productIntroduceSpecInput" style="display:none;">
                <input type="text" placeholder="请确认规格信息，如：500g/袋、1kg/盒…" id="productIntroduceSpecValue">
                <button class="btn btn-primary btn-sm" onclick="confirmProductIntroduceSpec()">确认</button>
              </div>
            </div>
            <span class="introduce-step-status"></span>
          </div>
          <div class="introduce-step" data-step="5">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">分档到门店</span>
              <span class="introduce-step-detail"></span>
            </div>
            <span class="introduce-step-status"></span>
          </div>
          <div class="introduce-step" data-step="6">
            <span class="introduce-step-icon">○</span>
            <div class="introduce-step-body">
              <span class="introduce-step-label">设置成功</span>
              <span class="introduce-step-detail"></span>
            </div>
            <span class="introduce-step-status"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 合同模版选择弹窗 -->
  <div class="modal-overlay" id="contractTemplateModal">
    <div class="modal">
      <div class="modal-header">
        <h3>选择合同模版</h3>
        <button class="modal-close" onclick="closeContractTemplateModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 13px;">选择系统内已有合同模版进行智检，支持采购、加盟、租赁、外包、用工等类型</p>
        <table class="data-table" id="contractTemplateTable">
          <tr><th></th><th>模版名称</th><th>类型</th><th>上次智检</th><th>风险数</th></tr>
          <tr class="contract-template-row" data-name="采购主合同" data-type="采购" data-date="2026-01-15" data-risks="10">
            <td><input type="radio" name="contractTemplate" value="0"></td>
            <td>采购主合同</td>
            <td>采购</td>
            <td>2026-01-15</td>
            <td>10</td>
          </tr>
          <tr class="contract-template-row" data-name="生鲜补充协议" data-type="采购" data-date="2026-01-12" data-risks="6">
            <td><input type="radio" name="contractTemplate" value="1"></td>
            <td>生鲜补充协议</td>
            <td>采购</td>
            <td>2026-01-12</td>
            <td>6</td>
          </tr>
          <tr class="contract-template-row" data-name="快消补充协议" data-type="采购" data-date="2026-01-10" data-risks="5">
            <td><input type="radio" name="contractTemplate" value="2"></td>
            <td>快消补充协议</td>
            <td>采购</td>
            <td>2026-01-10</td>
            <td>5</td>
          </tr>
          <tr class="contract-template-row" data-name="加盟合同" data-type="加盟" data-date="2025-12-28" data-risks="8">
            <td><input type="radio" name="contractTemplate" value="3"></td>
            <td>加盟合同</td>
            <td>加盟</td>
            <td>2025-12-28</td>
            <td>8</td>
          </tr>
          <tr class="contract-template-row" data-name="商品联营合同" data-type="联营" data-date="2025-12-20" data-risks="7">
            <td><input type="radio" name="contractTemplate" value="4"></td>
            <td>商品联营合同</td>
            <td>联营</td>
            <td>2025-12-20</td>
            <td>7</td>
          </tr>
        </table>
        <div style="margin-top: 20px; display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="confirmContractTemplateSelect()">确认选择</button>
          <button class="btn btn-ghost" onclick="closeContractTemplateModal()">取消</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 合同优化稿弹窗 -->
  <div class="modal-overlay contract-optimize-modal" id="contractOptimizeModal">
    <div class="contract-optimize-dialog">
      <div class="contract-optimize-header">
        <h3>合同优化稿预览 · 采购主合同</h3>
        <button class="modal-close" onclick="closeContractOptimizeModal()">×</button>
      </div>
      <div class="contract-optimize-body">
        <div class="contract-optimize-content">
          <div class="contract-doc" id="contractDocContent">
            <h4>谊品生鲜 · 供应商采购主合同</h4>
            <p>甲方（采购方）：谊品生鲜科技有限公司<br>乙方（供应方）：_____________________</p>
            <p>鉴于甲方拟向乙方采购商品，双方经协商一致，订立本合同。</p>

            <div class="contract-clause">
              <strong>第三条 商品与交付</strong>
              <p>3.1 乙方应按订单约定品种、规格、数量交付商品至甲方指定仓库。<br>
              3.2 商品验收标准参照<span class="contract-annot risk-low" data-rev="7" title="点击查看修订建议"><span class="contract-annot-num">[7]</span>国标及双方确认的样品</span>，如有不一致以书面确认为准。</p>
            </div>

            <div class="contract-clause">
              <strong>第四条 质量与异议</strong>
              <p>4.1 乙方保证所供商品符合食品安全相关法规。<br>
              4.2 甲方对商品质量有异议的，应于收货后<span class="contract-annot risk-mid" data-rev="4" title="点击查看修订建议"><span class="contract-annot-num">[4]</span>3 个工作日</span>内以书面形式提出，逾期视为验收合格。</p>
            </div>

            <div class="contract-clause">
              <strong>第五条 付款</strong>
              <p>5.1 甲方应于<span class="contract-annot risk-high" data-rev="3" title="点击查看修订建议"><span class="contract-annot-num">[3]</span>收货后 90 日内</span>向乙方支付货款，具体以对账单为准。</p>
            </div>

            <div class="contract-clause">
              <strong>第六条 退换货</strong>
              <p>6.1 因<span class="contract-annot risk-mid" data-rev="5" title="点击查看修订建议"><span class="contract-annot-num">[5]</span>质量问题</span>导致的退换货，由乙方承担运费及损失。</p>
            </div>

            <div class="contract-clause">
              <strong>第七条 违约责任</strong>
              <p>7.1 一方违约的，应赔偿对方因此遭受的损失。<br>
              7.2 乙方逾期交货或甲方逾期付款的，违约方应按未履行金额的<span class="contract-annot risk-high" data-rev="1" title="点击查看修订建议"><span class="contract-annot-num">[1]</span>30%</span>向守约方支付违约金。</p>
            </div>

            <div class="contract-clause">
              <strong>第八条 保密</strong>
              <p>8.1 双方应对合同履行中知悉的商业秘密承担保密义务，保密期限为<span class="contract-annot risk-mid" data-rev="6" title="点击查看修订建议"><span class="contract-annot-num">[6]</span>合同终止后 2 年</span>。</p>
            </div>

            <div class="contract-clause">
              <strong>第九条 争议解决</strong>
              <p>9.1 因本合同发生争议，双方应友好协商。<br>
              9.2 协商不成的，任何一方可提交<span class="contract-annot risk-high" data-rev="2" title="点击查看修订建议"><span class="contract-annot-num">[2]</span>仲裁</span>解决。</p>
            </div>

            <p style="margin-top: 24px;">甲方（盖章）：____________ &nbsp;&nbsp; 乙方（盖章）：____________<br>签订日期：____年____月____日</p>
          </div>
        </div>
        <div class="contract-optimize-sidebar" id="contractRevisionSidebar">
          <div class="contract-revision-title">修订说明（共 7 处）</div>
          <div class="contract-revision-item risk-high" data-rev="1" onclick="scrollToContractRev(1)">
            <div class="contract-revision-num">[1] 第 7.2 条 · 高风险</div>
            <div class="contract-revision-orig">违约金 30%</div>
            <div class="contract-revision-sugg">→ 调整为日万分之五或年 24% 以内</div>
          </div>
          <div class="contract-revision-item risk-high" data-rev="2" onclick="scrollToContractRev(2)">
            <div class="contract-revision-num">[2] 第 9.3 条 · 高风险</div>
            <div class="contract-revision-orig">仲裁（未明确机构）</div>
            <div class="contract-revision-sugg">→ 补充「重庆仲裁委员会」</div>
          </div>
          <div class="contract-revision-item risk-high" data-rev="3" onclick="scrollToContractRev(3)">
            <div class="contract-revision-num">[3] 第 5.1 条 · 高风险</div>
            <div class="contract-revision-orig">账期 90 日</div>
            <div class="contract-revision-sugg">→ 缩短至 60 日或增加提前付款折扣</div>
          </div>
          <div class="contract-revision-item" data-rev="4" onclick="scrollToContractRev(4)">
            <div class="contract-revision-num">[4] 第 4.2 条 · 中风险</div>
            <div class="contract-revision-orig">异议期 3 天</div>
            <div class="contract-revision-sugg">→ 延长至 7 天，明确书面异议形式</div>
          </div>
          <div class="contract-revision-item" data-rev="5" onclick="scrollToContractRev(5)">
            <div class="contract-revision-num">[5] 第 6.1 条 · 中风险</div>
            <div class="contract-revision-orig">「质量问题」未定义</div>
            <div class="contract-revision-sugg">→ 补充认定标准或引用国标</div>
          </div>
          <div class="contract-revision-item" data-rev="6" onclick="scrollToContractRev(6)">
            <div class="contract-revision-num">[6] 第 8.1 条 · 中风险</div>
            <div class="contract-revision-orig">保密期 2 年</div>
            <div class="contract-revision-sugg">→ 延长至 5 年或约定合理必要期限</div>
          </div>
          <div class="contract-revision-item" data-rev="7" onclick="scrollToContractRev(7)">
            <div class="contract-revision-num">[7] 第 3.2 条 · 低风险</div>
            <div class="contract-revision-orig">条款编号引用不一致</div>
            <div class="contract-revision-sugg">→ 统一编号格式，修正交叉引用</div>
          </div>
        </div>
      </div>
      <div class="contract-optimize-footer">
        <button class="btn btn-ghost" onclick="closeContractOptimizeModal()">关闭</button>
        <button class="btn btn-primary" onclick="exportContractOptimize('word')">导出为 Word</button>
        <button class="btn btn-primary" onclick="exportContractOptimize('pdf')">导出为 PDF</button>
      </div>
    </div>
  </div>

  <!-- 数据弹窗 -->
  <div class="data-modal-overlay" id="dataModal">
    <div class="data-modal">
      <div class="data-modal-header">
        <h3 id="dataModalTitle">数据详情</h3>
        <button class="data-modal-close" onclick="closeDataModal()">×</button>
      </div>
      <div class="data-modal-body" id="dataModalBody"></div>
    </div>
  </div>

  <!-- 门店经营分析报告弹窗 -->
  <div id="reportModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>📊 门店经营分析报告</h3>
        <button class="modal-close" onclick="closeReport()">×</button>
      </div>
      <div class="modal-body">
        <div class="report-header">
          <div class="report-header-text">
            <h4>📋 门店经营分析报告</h4>
            <p>报告周期：2026年1月第4周 | 菜湖店（A01032）| 数据来源：POS、金蝶、市调采集 | 生成时间：2026-01-30 21:15</p>
          </div>
          <div class="report-export-dropdown" id="reportExportDropdown">
            <button class="report-export-trigger" onclick="toggleReportExport()">导出</button>
            <div class="report-export-menu">
              <button onclick="exportReport('word')">📄 导出为 Word</button>
              <button onclick="exportReport('pdf')">📄 导出为 PDF</button>
            </div>
          </div>
        </div>
        <div class="report-summary">
          <h5>📌 报告摘要</h5>
          <p><strong>核心结论：</strong>销售额、毛利额、客流量环比向好，客单价下降 2.1% 需关注；14:00-16:00 时段受竞品分流影响，生鲜动销率 82% 低于区域均值。</p>
          <p><strong>优先行动：</strong>① 叶菜限时促销或组合蛋品（P0）② 14:00 前启动下午促销对标永辉（P0）③ 陈列调整提升下午进店转化（P1）</p>
        </div>
        <div class="report-section">
          <h4>一、核心经营指标</h4>
          <div class="report-kpi">
            <div class="kpi-card blue">
              <div class="kpi-label">销售额</div>
              <div class="kpi-value">12.8万</div>
              <div class="kpi-change">环比+8.2%</div>
              <div class="kpi-change-yoy">同比+5.3%</div>
            </div>
            <div class="kpi-card green">
              <div class="kpi-label">毛利额</div>
              <div class="kpi-value">2.94万</div>
              <div class="kpi-change">环比+5.1%</div>
              <div class="kpi-change-yoy">同比+3.8%</div>
            </div>
            <div class="kpi-card" style="background: rgba(100,149,237,0.1); border: 1px solid rgba(100,149,237,0.3);">
              <div class="kpi-label">毛利率</div>
              <div class="kpi-value" style="color: #6495ed;">23.0%</div>
              <div class="kpi-change" style="color: var(--success);">环比+0.2pp</div>
              <div class="kpi-change-yoy">同比-0.5pp</div>
            </div>
            <div class="kpi-card orange">
              <div class="kpi-label">客流量</div>
              <div class="kpi-value">3,240</div>
              <div class="kpi-change">环比+3.6%</div>
              <div class="kpi-change-yoy">同比+2.1%</div>
            </div>
            <div class="kpi-card red">
              <div class="kpi-label">客单价</div>
              <div class="kpi-value">39.5元</div>
              <div class="kpi-change">环比-2.1%</div>
              <div class="kpi-change-yoy">同比-1.2%</div>
            </div>
          </div>
          <p class="report-note">数据依据：POS 日结汇总 1/23-1/29；环比 vs 上周 1/16-1/22，同比 vs 去年同期 1/24-1/30</p>
        </div>
        <div class="report-section">
          <h4>二、原始数据与推理依据</h4>
          <div class="report-box" style="background: rgba(139,156,179,0.08); border-color: var(--border);">
            <h5 style="margin-bottom: 10px;">时段销售明细（原始数据）</h5>
            <table class="data-table" style="font-size: 12px;">
              <tr><th>时段</th><th>本周销售额</th><th>上周销售额</th><th>环比</th><th>本周客流</th><th>上周客流</th></tr>
              <tr><td>07:00-09:00</td><td>2.18万</td><td>2.05万</td><td style="color: var(--success);">+6.3%</td><td>620</td><td>598</td></tr>
              <tr><td>09:00-12:00</td><td>3.42万</td><td>3.28万</td><td style="color: var(--success);">+4.3%</td><td>892</td><td>865</td></tr>
              <tr><td>12:00-14:00</td><td>2.15万</td><td>2.12万</td><td style="color: var(--success);">+1.4%</td><td>548</td><td>542</td></tr>
              <tr><td>14:00-16:00</td><td>1.28万</td><td>1.51万</td><td style="color: var(--danger);">-15.2%</td><td>312</td><td>368</td></tr>
              <tr><td>16:00-18:00</td><td>1.95万</td><td>1.88万</td><td style="color: var(--success);">+3.7%</td><td>485</td><td>472</td></tr>
              <tr><td>18:00-21:00</td><td>1.82万</td><td>1.76万</td><td style="color: var(--success);">+3.4%</td><td>383</td><td>375</td></tr>
            </table>
            <p style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">推理：14:00-16:00 时段销售额与客流双降，为本周主要拖累；其余时段表现正常或优于上周。</p>
          </div>
          <div class="report-box" style="background: rgba(139,156,179,0.08); border-color: var(--border); margin-top: 12px;">
            <h5 style="margin-bottom: 10px;">品类销售结构（原始数据）</h5>
            <table class="data-table" style="font-size: 12px;">
              <tr><th>品类</th><th>本周销售额</th><th>占比</th><th>动销率</th><th>区域均值</th><th>环比</th></tr>
              <tr><td>蔬菜</td><td>4.2万</td><td>32.8%</td><td>82%</td><td>88%</td><td style="color: var(--danger);">-2.1%</td></tr>
              <tr><td>肉禽</td><td>3.1万</td><td>24.2%</td><td>91%</td><td>89%</td><td style="color: var(--success);">+5.2%</td></tr>
              <tr><td>蛋品</td><td>1.8万</td><td>14.1%</td><td>95%</td><td>92%</td><td style="color: var(--success);">+8.1%</td></tr>
              <tr><td>水果</td><td>1.6万</td><td>12.5%</td><td>78%</td><td>85%</td><td>持平</td></tr>
              <tr><td>标品</td><td>2.1万</td><td>16.4%</td><td>65%</td><td>70%</td><td style="color: var(--success);">+3.2%</td></tr>
            </table>
            <p style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">推理：蔬菜动销率 82% 低于区域 88%，与滞销商品（小白菜、莴苣、油麦菜）拖累一致。</p>
          </div>
        </div>
        <div class="report-section">
          <h4>三、根因分析</h4>
          <div class="report-box" style="background: rgba(139,156,179,0.08); border-color: var(--border); margin-bottom: 12px;">
            <h5 style="margin-bottom: 10px;">周边竞品活动明细（市调 1/28）</h5>
            <table class="data-table" style="font-size: 12px;">
              <tr><th>门店</th><th>活动</th><th>时段</th><th>主推品类</th></tr>
              <tr><td>永辉 · 菜湖店</td><td>叶菜限时 8 折</td><td>14:00-16:00</td><td>叶菜</td></tr>
              <tr><td>盒马 · 江北店</td><td>满 50 减 8</td><td>全天</td><td>全品类</td></tr>
              <tr><td>谊品 · 本店</td><td>—</td><td>—</td><td>—</td></tr>
            </table>
            <p style="margin-top: 8px; font-size: 12px; color: var(--danger);">永辉 14:00-16:00 叶菜 8 折与本店下午客流下滑时段重叠，存在明显分流。</p>
          </div>
          <div class="report-diagnosis">
            <h5>⚠ 客单价下降 2.1% 的原因</h5>
            <ul>
              <li><strong>数据支撑：</strong>本周客单价 39.5 元 vs 上周 40.3 元；14:00-16:00 时段客单价 41.0 元 vs 41.1 元，基本持平。</li>
              <li><strong>推理结论：</strong>客单价下降主要来自 14:00-16:00 客流结构变化——该时段客流减少 56 人（-15.2%），而该时段通常为高客单（午休后采购），流失的可能是高价值客群。</li>
            </ul>
            <h5 style="margin-top: 12px;">14:00-16:00 客流下滑的可能原因</h5>
            <ul>
              <li><strong>竞品活动：</strong>市调数据（1/28 永辉·菜湖）显示，永辉 14:00-16:00 推出「叶菜限时 8 折」，与本店时段重叠。</li>
              <li><strong>品类动销：</strong>生鲜动销率 82% 低于区域 88%，小白菜、莴苣、油麦菜周转 1.2-1.8 次，滞销可能影响陈列与吸引力。</li>
            </ul>
          </div>
        </div>
        <div class="report-section">
          <h4>四、畅销/滞销 TOP</h4>
          <div class="report-top-grid">
            <div class="report-box" style="background: rgba(0,200,150,0.08); border-color: rgba(0,200,150,0.3);">
              <h5 style="margin-bottom: 10px; color: var(--success);">畅销 TOP5</h5>
              <table class="data-table" style="font-size: 12px;">
                <tr><th>商品</th><th>销量</th><th>周转</th><th>环比</th></tr>
                <tr><td>鸡蛋</td><td>520 盒</td><td>4.2</td><td style="color: var(--success);">+12%</td></tr>
                <tr><td>排骨</td><td>185 kg</td><td>3.8</td><td style="color: var(--success);">+8%</td></tr>
                <tr><td>五花肉</td><td>142 kg</td><td>3.5</td><td style="color: var(--success);">+5%</td></tr>
                <tr><td>鲜奶</td><td>380 件</td><td>3.2</td><td style="color: var(--success);">+6%</td></tr>
                <tr><td>有机西红柿</td><td>95 kg</td><td>2.9</td><td style="color: var(--success);">+4%</td></tr>
              </table>
            </div>
            <div class="report-box" style="background: rgba(255,107,107,0.08); border-color: rgba(255,107,107,0.3);">
              <h5 style="margin-bottom: 10px; color: var(--danger);">滞销 TOP5</h5>
              <table class="data-table data-table-actions" style="font-size: 12px;">
                <tr><th>商品</th><th>周转</th><th>库存天数</th><th>建议</th><th>操作</th></tr>
                <tr><td>西兰花</td><td>1.2</td><td>8 天</td><td>建议汰换</td><td><button class="btn-link" onclick="closeReport(); switchScene('replenish'); showToast('已跳转至补货建议')">查看补货建议</button></td></tr>
                <tr><td>小白菜</td><td>1.5</td><td>5 天</td><td>促销/组合</td><td><button class="btn-link" onclick="closeReport(); showDataModal('小白菜补货建议', report促销建议Html)">查看补货建议</button></td></tr>
                <tr><td>莴苣</td><td>1.6</td><td>5 天</td><td>促销/组合</td><td><button class="btn-link" onclick="closeReport(); showDataModal('莴苣补货建议', report促销建议Html)">查看补货建议</button></td></tr>
                <tr><td>油麦菜</td><td>1.8</td><td>4 天</td><td>促销/组合</td><td><button class="btn-link" onclick="closeReport(); showDataModal('油麦菜补货建议', report促销建议Html)">查看补货建议</button></td></tr>
                <tr><td>预制红烧肉</td><td>1.4</td><td>6 天</td><td>限时折扣</td><td><button class="btn-link" onclick="closeReport(); showDataModal('预制红烧肉补货建议', report促销建议Html)">查看补货建议</button></td></tr>
              </table>
            </div>
          </div>
          <p class="report-note" style="margin-top: 8px;">损耗率 2.1%，损耗金额约 ¥268，在合理范围；蔬菜品类损耗占 65%。</p>
        </div>
        <div class="report-section">
          <h4>五、经营诊断（综合结论）</h4>
          <div class="report-diagnosis">
            <ul>
              <li>下午 14:00-16:00 为本周主要短板，销售额较上周 -15.2%，需重点应对竞品分流</li>
              <li>生鲜品类动销率 82% 低于区域均值 88%；小白菜、莴苣、油麦菜周转&lt;2 次，存在滞销风险</li>
              <li>早高峰、晚高峰表现良好，说明核心客群与常规运营稳定</li>
            </ul>
          </div>
        </div>
        <div class="report-section">
          <h4>六、改进建议（含推理依据）</h4>
          <div class="report-suggestions">
            <h5>✓ 行动建议</h5>
            <ul>
              <li><span class="priority-badge p0">P0</span><span><strong>小白菜、莴苣、油麦菜：</strong>限时折扣或与蛋品组合促销。依据：周转&lt;2 次，库存天数偏高，组合促销可拉升动销并降低损耗。</span></li>
              <li><span class="priority-badge p0">P0</span><span><strong>14:00 前启动促销：</strong>抢占下午客流。依据：永辉 14:00 启动，建议本店 13:30 或 14:00 同步启动，形成对标。</span></li>
              <li><span class="priority-badge p1">P1</span><span><strong>陈列调整：</strong>入口显眼位陈列「下午茶买菜」专区。依据：提升下午时段进店转化与客单价。</span></li>
            </ul>
            <p style="margin-top: 12px; font-size: 12px; color: var(--accent);">预计可挽回 14:00-16:00 客流 8-12%，整体客单价保持或微增。</p>
          </div>
          <div class="report-actions">
            <button class="btn btn-primary" onclick="closeReport(); showDataModal('时段销售明细', report时段明细Html)">打开时段报表</button>
            <button class="btn btn-primary" onclick="closeReport(); showToast('已同步至经营指引'); switchScene('dashboard')">同步到经营指引</button>
            <button class="btn btn-ghost" onclick="closeReport(); showDataModal('促销建议单', report促销建议Html)">生成促销建议单</button>
            <button class="btn btn-ghost" onclick="showRemindModal()">⏰ 设置下次提醒</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const report时段明细Html = `<table class="data-table"><tr><th>时段</th><th>本周销售额</th><th>上周销售额</th><th>环比</th><th>本周客流</th><th>上周客流</th></tr><tr><td>07:00-09:00</td><td>2.18万</td><td>2.05万</td><td style="color: var(--success);">+6.3%</td><td>620</td><td>598</td></tr><tr><td>09:00-12:00</td><td>3.42万</td><td>3.28万</td><td style="color: var(--success);">+4.3%</td><td>892</td><td>865</td></tr><tr><td>12:00-14:00</td><td>2.15万</td><td>2.12万</td><td style="color: var(--success);">+1.4%</td><td>548</td><td>542</td></tr><tr><td>14:00-16:00</td><td>1.28万</td><td>1.51万</td><td style="color: var(--danger);">-15.2%</td><td>312</td><td>368</td></tr><tr><td>16:00-18:00</td><td>1.95万</td><td>1.88万</td><td style="color: var(--success);">+3.7%</td><td>485</td><td>472</td></tr><tr><td>18:00-21:00</td><td>1.82万</td><td>1.76万</td><td style="color: var(--success);">+3.4%</td><td>383</td><td>375</td></tr></table>`;
    const report促销建议Html = `<div class="report-box success" style="margin-bottom: 16px;"><strong>活动名称：</strong>下午茶买菜·叶菜+蛋品组合<br><strong>时段：</strong>14:00-18:00<br><strong>组合价：</strong>¥9.9（原价¥12.8）</div><table class="data-table"><tr><th>商品</th><th>原价</th><th>组合价</th><th>预计销量</th></tr><tr><td>小白菜+鸡蛋</td><td>¥12.8</td><td>¥9.9</td><td>80-100 份</td></tr><tr><td>油麦菜+鸡蛋</td><td>¥11.5</td><td>¥8.9</td><td>50-70 份</td></tr></table><p style="margin-top: 12px; color: var(--accent);">预计可拉升 14:00-16:00 客流 8-12%</p>`;
    const scenes = {
      home: { title: '首页', subtitle: '操作指引' },
      'trustee-calendar': { title: '托管日历', subtitle: 'AI 托管状态与门店/仓库设置' },
      dashboard: { title: 'AI门店经营', subtitle: '全天候自动执行门店经营任务' },
      inspection: { title: 'AI门店巡检', subtitle: '临期商品、异常升级、日报周报自动发现与处置' },
      market: { title: '市调选品分析', subtitle: '数据源 → 竞品分析 + 自有商品结构 → 是否引入、定价、采购量与决策原因' },
      'new-chat': { title: '新对话', subtitle: '在此输入问题，开始与营营无忧对话' },
      finance: { title: '财务 AI 提效', subtitle: '异常凭证识别、对账差异分析、报表/审批流自然语言查询与摘要' },
      assistant: { title: '营营无忧经营助手', subtitle: '对话式经营分析，覆盖门店经营、商品结构、定价策略、智能补货' },
      logistics: { title: '运力资源预测', subtitle: '结合分拣单、仓配单、采购单、T+2 补货单预估作业量，指导人力与运力调配' },
      report: { title: '报表分析', subtitle: '自动归集全国仓库报表，汇总合并并分析，给出建议与规划' },
      store: { title: '门店经营分析决策', subtitle: '对话式分析销售、毛利、客流及时段对比，支持同比/环比与根因解读' },
      product: { title: '商品结构分析决策', subtitle: '品类占比、滞销与畅销识别、汰换建议，支持一键生成分析单' },
      pricing: { title: '商品定价策略', subtitle: '竞品与成本参考，对话获取建议价，支持一键同步定价' },
      replenish: { title: '智能补货与需求预测', subtitle: 'AI 补货建议量、需求预测、依据解读、一键同步补货/灯塔' },
      'logistics-dispatch': { title: 'AI物流调度', subtitle: '运力实时监控、作业量评估、资源调配、车次路线优化，AI 托管调度' },
      contract: { title: '合同智检', subtitle: '合同模版风险识别与标注、风险清单与建议修改、支持对话式优化模版' }
    };

    /* 托管日历 */
    const trusteeAiModules = [
      { id: 'dashboard', name: 'AI门店经营', short: '门店', hasStore: true },
      { id: 'inspection', name: 'AI门店巡检', short: '巡检', hasStore: true },
      { id: 'logistics-dispatch', name: 'AI物流调度', short: '物流', hasWarehouse: true }
    ];
    const trusteeStores = ['菜湖店', '江北店', '南坪店', '渝北店'];
    const trusteeWarehouses = ['华东仓', '华南仓', '华北仓', '所有仓库'];
    let trusteeCalendarYear = new Date().getFullYear(), trusteeCalendarMonth = new Date().getMonth() + 1;
    let trusteeAiStatus = {}; // { "2025-01-31": { dashboard: true, inspection: true, store: '菜湖店', logisticsWarehouse: '华东仓', ... } }
    function trusteeGetDateKey(y, m, d) { return y + '-' + String(m).padStart(2,'0') + '-' + String(d).padStart(2,'0'); }
    function trusteeGetDayStatus(y, m, d) {
      const key = trusteeGetDateKey(y, m, d);
      if (!trusteeAiStatus[key]) {
        trusteeAiStatus[key] = { dashboard: true, inspection: true, 'logistics-dispatch': true, store: '菜湖店', logisticsWarehouse: '华东仓' };
      }
      return trusteeAiStatus[key];
    }
    function trusteeIsPast(y, m, d) {
      const t = new Date();
      const td = new Date(t.getFullYear(), t.getMonth(), t.getDate()).getTime();
      const cd = new Date(y, m - 1, d).getTime();
      return cd < td;
    }
    function trusteeIsFuture(y, m, d) {
      const t = new Date();
      const td = new Date(t.getFullYear(), t.getMonth(), t.getDate()).getTime();
      const cd = new Date(y, m - 1, d).getTime();
      return cd > td;
    }
    function trusteeBuildDayModules(status) {
      return trusteeAiModules.map(mod => '<div class="day-mod"><span class="day-mod-item">' + (mod.short || mod.name) + '<span class="day-mod-dot ' + (status[mod.id] ? 'on' : 'off') + '" title="' + mod.name + (status[mod.id] ? ' 托管中' : ' 未开启') + '"></span></span></div>').join('');
    }
    function trusteeCalendarRender() {
      const grid = document.getElementById('trusteeCalendarGrid');
      const monthEl = document.getElementById('trusteeCalendarMonth');
      if (!grid) return;
      const first = new Date(trusteeCalendarYear, trusteeCalendarMonth - 1, 1);
      const last = new Date(trusteeCalendarYear, trusteeCalendarMonth, 0);
      const startPad = first.getDay();
      const daysInMonth = last.getDate();
      const prevLast = new Date(trusteeCalendarYear, trusteeCalendarMonth - 2, 0).getDate();
      const today = new Date();
      const todayKey = trusteeGetDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
      let html = '';
      for (let i = 0; i < startPad; i++) {
        const d = prevLast - startPad + i + 1;
        const y = trusteeCalendarMonth === 1 ? trusteeCalendarYear - 1 : trusteeCalendarYear;
        const m = trusteeCalendarMonth === 1 ? 12 : trusteeCalendarMonth - 1;
        const status = trusteeGetDayStatus(y, m, d);
        const isToday = trusteeGetDateKey(y, m, d) === todayKey;
        const isPast = trusteeIsPast(y, m, d);
        const isFuture = trusteeIsFuture(y, m, d);
        const modulesHtml = isFuture ? '' : '<div class="day-modules">' + trusteeBuildDayModules(status) + '</div>';
        const editable = isToday;
        const noEditClass = !editable ? ' past' : '';
        html += '<div class="home-calendar-day other-month' + noEditClass + '" data-y="' + y + '" data-m="' + m + '" data-d="' + d + '" data-editable="' + editable + '"><span class="day-num">' + d + '</span>' + modulesHtml + '</div>';
      }
      for (let d = 1; d <= daysInMonth; d++) {
        const status = trusteeGetDayStatus(trusteeCalendarYear, trusteeCalendarMonth, d);
        const key = trusteeGetDateKey(trusteeCalendarYear, trusteeCalendarMonth, d);
        const isToday = key === todayKey;
        const isPast = trusteeIsPast(trusteeCalendarYear, trusteeCalendarMonth, d);
        const isFuture = trusteeIsFuture(trusteeCalendarYear, trusteeCalendarMonth, d);
        const modulesHtml = isFuture ? '' : '<div class="day-modules">' + trusteeBuildDayModules(status) + '</div>';
        const editable = isToday;
        const noEditClass = !editable ? ' past' : '';
        html += '<div class="home-calendar-day' + (isToday ? ' today' : '') + noEditClass + '" data-y="' + trusteeCalendarYear + '" data-m="' + trusteeCalendarMonth + '" data-d="' + d + '" data-editable="' + editable + '"><span class="day-num">' + d + '</span>' + modulesHtml + '</div>';
      }
      const total = startPad + daysInMonth;
      const remain = total % 7 === 0 ? 0 : 7 - (total % 7);
      for (let i = 0; i < remain; i++) {
        const d = i + 1;
        const y = trusteeCalendarMonth === 12 ? trusteeCalendarYear + 1 : trusteeCalendarYear;
        const m = trusteeCalendarMonth === 12 ? 1 : trusteeCalendarMonth + 1;
        const status = trusteeGetDayStatus(y, m, d);
        const isToday = trusteeGetDateKey(y, m, d) === todayKey;
        const isPast = trusteeIsPast(y, m, d);
        const isFuture = trusteeIsFuture(y, m, d);
        const modulesHtml = isFuture ? '' : '<div class="day-modules">' + trusteeBuildDayModules(status) + '</div>';
        const editable = isToday;
        const noEditClass = !editable ? ' past' : '';
        html += '<div class="home-calendar-day other-month' + noEditClass + '" data-y="' + y + '" data-m="' + m + '" data-d="' + d + '" data-editable="' + editable + '"><span class="day-num">' + d + '</span>' + modulesHtml + '</div>';
      }
      grid.innerHTML = html;
      if (monthEl) monthEl.textContent = trusteeCalendarYear + '年' + trusteeCalendarMonth + '月';
      grid.querySelectorAll('.home-calendar-day:not(.home-calendar-empty)').forEach(el => {
        el.addEventListener('click', () => {
          if (el.dataset.editable !== 'true') return;
          trusteeCalendarOpenDay(parseInt(el.dataset.y), parseInt(el.dataset.m), parseInt(el.dataset.d));
        });
      });
    }
    function trusteeCalendarOpenDay(y, m, d) {
      const key = trusteeGetDateKey(y, m, d);
      const status = trusteeGetDayStatus(y, m, d);
      let rowsHtml = '';
      trusteeAiModules.forEach((mod, idx) => {
        rowsHtml += '<div class="trustee-modal-row" data-mod="' + mod.id + '">';
        rowsHtml += '<div class="trustee-modal-row-main"><span>' + mod.name + '</span><div class="home-calendar-toggle' + (status[mod.id] ? ' on' : '') + '" data-mod="' + mod.id + '" onclick="trusteeCalendarToggleMod(this)"></div></div>';
        if (mod.hasWarehouse && status[mod.id]) {
          rowsHtml += '<div class="trustee-modal-row-extra"><span class="trustee-modal-label">仓库</span><select class="trustee-modal-select" data-field="logisticsWarehouse">' + trusteeWarehouses.map(w => '<option value="' + w + '"' + (status.logisticsWarehouse === w ? ' selected' : '') + '>' + w + '</option>').join('') + '</select></div>';
        }
        rowsHtml += '</div>';
        if (idx === 1 && (status.dashboard || status.inspection)) {
          rowsHtml += '<div class="trustee-modal-row trustee-modal-row-shared" data-mod="shared-store"><div class="trustee-modal-row-extra"><span class="trustee-modal-label">门店经营 & 门店巡检 共用</span><select class="trustee-modal-select" data-field="store">' + trusteeStores.map(s => '<option value="' + s + '"' + (status.store === s ? ' selected' : '') + '>' + s + '</option>').join('') + '</select></div></div>';
        }
      });
      const modalHtml = '<div class="home-calendar-modal-overlay" id="trusteeCalendarModalOverlay">' +
        '<div class="home-calendar-modal trustee-calendar-modal">' +
        '<h4>' + y + '年' + m + '月' + d + '日 托管设置</h4>' +
        '<div class="trustee-modal-rows">' + rowsHtml + '</div>' +
        '<div class="home-calendar-modal-actions">' +
        '<button class="btn-ghost" onclick="trusteeCalendarModalAll(false)">全部关闭</button>' +
        '<button class="btn-ghost" onclick="trusteeCalendarModalAll(true)">全部开启</button>' +
        '<button class="btn-confirm" onclick="trusteeCalendarModalClose(\'' + key + '\')">确定</button>' +
        '</div></div></div>';
      const old = document.getElementById('trusteeCalendarModalOverlay');
      if (old) old.remove();
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const overlay = document.getElementById('trusteeCalendarModalOverlay');
      overlay.dataset.dateKey = key;
      overlay.addEventListener('click', (e) => { if (e.target === overlay) trusteeCalendarModalClose(key); });
      trusteeCalendarBindToggleExtra();
    }
    function trusteeCalendarBindToggleExtra() {
      document.querySelectorAll('#trusteeCalendarModalOverlay .home-calendar-toggle').forEach(t => {
        t.addEventListener('click', () => setTimeout(() => trusteeCalendarUpdateExtraRows(), 0));
      });
    }
    function trusteeCalendarUpdateExtraRows() {
      const overlay = document.getElementById('trusteeCalendarModalOverlay');
      if (!overlay) return;
      const dashboardToggle = overlay.querySelector('.trustee-modal-row[data-mod="dashboard"] .home-calendar-toggle');
      const inspectionToggle = overlay.querySelector('.trustee-modal-row[data-mod="inspection"] .home-calendar-toggle');
      const storeOrInspectionOn = (dashboardToggle?.classList.contains('on') || inspectionToggle?.classList.contains('on'));
      let sharedRow = overlay.querySelector('.trustee-modal-row[data-mod="shared-store"]');
      if (storeOrInspectionOn) {
        if (!sharedRow) {
          sharedRow = document.createElement('div');
          sharedRow.className = 'trustee-modal-row trustee-modal-row-shared';
          sharedRow.dataset.mod = 'shared-store';
          sharedRow.innerHTML = '<div class="trustee-modal-row-extra"><span class="trustee-modal-label">门店经营 & 门店巡检 共用</span><select class="trustee-modal-select" data-field="store">' + trusteeStores.map(s => '<option value="' + s + '">' + s + '</option>').join('') + '</select></div>';
          const inspectionRow = overlay.querySelector('.trustee-modal-row[data-mod="inspection"]');
          inspectionRow?.insertAdjacentElement('afterend', sharedRow);
        }
      } else if (sharedRow) {
        sharedRow.remove();
      }
      trusteeAiModules.forEach(mod => {
        if (!mod.hasWarehouse) return;
        const row = overlay.querySelector('.trustee-modal-row[data-mod="' + mod.id + '"]');
        const toggle = row?.querySelector('.home-calendar-toggle');
        let extra = row?.querySelector('.trustee-modal-row-extra');
        if (!row || !toggle) return;
        const isOn = toggle.classList.contains('on');
        if (isOn) {
          if (!extra) { extra = document.createElement('div'); extra.className = 'trustee-modal-row-extra'; row.appendChild(extra); }
          if (!extra.querySelector('select')) {
            extra.innerHTML = '<span class="trustee-modal-label">仓库</span><select class="trustee-modal-select" data-field="logisticsWarehouse">' + trusteeWarehouses.map(w => '<option value="' + w + '">' + w + '</option>').join('') + '</select>';
          }
        } else if (extra) {
          extra.remove();
        }
      });
    }
    function trusteeCalendarToggleMod(el) {
      el.classList.toggle('on');
      trusteeCalendarUpdateExtraRows();
    }
    function trusteeCalendarModalAll(on) {
      document.querySelectorAll('#trusteeCalendarModalOverlay .home-calendar-toggle').forEach(t => {
        t.classList.toggle('on', on);
      });
      trusteeCalendarUpdateExtraRows();
    }
    function trusteeCalendarModalClose(dateKey) {
      const overlay = document.getElementById('trusteeCalendarModalOverlay');
      if (!overlay) return;
      const toggles = overlay.querySelectorAll('.home-calendar-toggle');
      const selects = overlay.querySelectorAll('.trustee-modal-select');
      const newStatus = { dashboard: false, inspection: false, docflow: false, 'logistics-dispatch': false, store: '菜湖店', logisticsWarehouse: '华东仓' };
      trusteeAiModules.forEach((mod, i) => {
        newStatus[mod.id] = toggles[i]?.classList.contains('on') || false;
      });
      selects.forEach(sel => {
        const field = sel.dataset.field;
        if (field) newStatus[field] = sel.value;
      });
      trusteeAiStatus[dateKey] = newStatus;
      overlay.remove();
      trusteeCalendarRender();
      if (typeof trusteeStatsUpdate === 'function') trusteeStatsUpdate();
      if (typeof trusteeUpdateModuleBadges === 'function') trusteeUpdateModuleBadges();
    }
    function trusteeUpdateModuleBadges() {
      const today = new Date();
      const status = trusteeGetDayStatus(today.getFullYear(), today.getMonth() + 1, today.getDate());
      document.querySelectorAll('.module-trustee-badge').forEach(badge => {
        const modId = badge.dataset.mod;
        const textEl = badge.querySelector('.module-trustee-text');
        const isOn = status[modId];
        badge.classList.toggle('off', !isOn);
        if (textEl) textEl.textContent = isOn ? 'AI托管中' : 'AI 未托管';
      });
      document.querySelectorAll('.module-trustee-content').forEach(wrap => {
        const modId = wrap.dataset.mod;
        const isOn = status[modId];
        wrap.style.display = isOn ? '' : 'none';
      });
      trusteeAiModules.forEach(mod => {
        const modId = mod.id;
        const isOn = status[modId];
        const panel = document.getElementById('scene-' + modId);
        if (panel) {
          panel.querySelectorAll('.module-trustee-when-managed').forEach(el => {
            el.style.display = isOn ? '' : 'none';
          });
        }
      });
    }
    function trusteeCalendarPrevMonth() { trusteeCalendarMonth--; if (trusteeCalendarMonth < 1) { trusteeCalendarMonth = 12; trusteeCalendarYear--; } trusteeCalendarRender(); }
    function trusteeCalendarNextMonth() { trusteeCalendarMonth++; if (trusteeCalendarMonth > 12) { trusteeCalendarMonth = 1; trusteeCalendarYear++; } trusteeCalendarRender(); }
    function trusteeCalendarToday() {
      const t = new Date();
      trusteeCalendarYear = t.getFullYear();
      trusteeCalendarMonth = t.getMonth() + 1;
      trusteeCalendarRender();
    }
    function trusteeCalendarCopyWeek() {
      const t = new Date();
      const key = trusteeGetDateKey(t.getFullYear(), t.getMonth() + 1, t.getDate());
      const status = trusteeGetDayStatus(t.getFullYear(), t.getMonth() + 1, t.getDate());
      for (let i = 1; i <= 7; i++) {
        const d = new Date(t);
        d.setDate(d.getDate() + i);
        const k = trusteeGetDateKey(d.getFullYear(), d.getMonth() + 1, d.getDate());
        trusteeAiStatus[k] = { ...status };
      }
      trusteeCalendarRender();
      showToast('已复制到本周剩余天数');
    }
    function trusteeStatsUpdate() {
      const hoursEl = document.getElementById('trusteeStatsTodayHours');
      if (hoursEl) {
        const now = new Date();
        const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 0, 0);
        const ms = Math.max(0, now - startToday);
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        hoursEl.textContent = (h > 0 ? h + ' 小时 ' : '') + m + ' 分';
      }
      const today = new Date();
      const status = trusteeGetDayStatus(today.getFullYear(), today.getMonth() + 1, today.getDate());
      const moduleList = document.getElementById('trusteeStatsModuleList');
      if (moduleList) {
        trusteeAiModules.forEach(mod => {
          const modEl = moduleList.querySelector('.trustee-stats-module[data-mod="' + mod.id + '"]');
          const dot = modEl?.querySelector('.trustee-module-dot');
          if (dot) {
            dot.classList.toggle('on', status[mod.id]);
            dot.classList.toggle('off', !status[mod.id]);
          }
        });
      }
      const badge = document.getElementById('trusteeStatsBadge');
      if (badge) {
        const anyOn = trusteeAiModules.some(mod => status[mod.id]);
        if (anyOn) {
          badge.classList.remove('off');
          badge.innerHTML = '<span class="ai-pulse"></span> AI 托管中';
        } else {
          badge.classList.add('off');
          badge.innerHTML = '<span class="ai-pulse"></span> AI 未托管';
        }
      }
    }
    function homeQuickAskText(text) {
      const input = document.getElementById('homeAskInput');
      if (input) { input.value = text; input.focus(); }
      switchScene('assistant');
      const chatInput = document.querySelector('#scene-assistant .chat-input-bar input');
      if (chatInput) { chatInput.value = text; chatInput.focus(); }
    }
    function homeQuickAsk() {
      const input = document.getElementById('homeAskInput');
      const text = input?.value?.trim();
      if (text) homeQuickAskText(text);
    }
    function homeUpdateGreeting() {
      const h = new Date().getHours();
      let greeting = '早上好';
      if (h >= 12 && h < 18) greeting = '下午好';
      else if (h >= 18) greeting = '晚上好';
      const prefix = greeting + '，';
      const prefixEl = document.getElementById('homeGreetingPrefix');
      const spacerEl = document.getElementById('homeGreetingSpacer');
      if (prefixEl) prefixEl.textContent = prefix;
      if (spacerEl) spacerEl.textContent = prefix;
    }
    function homeUpdateDate() {
      const d = new Date();
      const week = ['日','一','二','三','四','五','六'][d.getDay()];
      const el = document.getElementById('homeDate');
      if (el) el.textContent = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' 周' + week;
    }

    const chatScenes = ['new-chat', 'finance', 'assistant', 'logistics', 'report', 'store', 'product', 'pricing', 'replenish'];
    function switchScene(scene) {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.history-item[data-scene]').forEach(n => n.classList.remove('active'));
      const navEl = document.querySelector(`.nav-item[data-scene="${scene}"]`);
      const histEl = scene !== 'new-chat' ? document.querySelector(`.history-item[data-scene="${scene}"]`) : null;
      if (navEl) navEl.classList.add('active');
      if (histEl) histEl.classList.add('active');
      document.querySelectorAll('.scene-panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById('scene-' + scene);
      if (panel) panel.classList.add('active');
      document.getElementById('scene-title').textContent = scenes[scene]?.title || '';
      document.getElementById('scene-subtitle').textContent = scenes[scene]?.subtitle || '';
      const mainContent = document.getElementById('mainContent');
      if (mainContent) {
        mainContent.scrollTop = 0;
        if (chatScenes.includes(scene)) mainContent.classList.add('chat-mode');
        else mainContent.classList.remove('chat-mode');
        if (scene === 'home') mainContent.classList.add('home-view');
        else mainContent.classList.remove('home-view');
      }
      if (scene === 'docflow' && typeof renderDocflowList === 'function') renderDocflowList();
      if (scene === 'home') {
        if (typeof homeUpdateGreeting === 'function') homeUpdateGreeting();
        if (typeof homeUpdateDate === 'function') homeUpdateDate();
      }
      if (scene === 'trustee-calendar') {
        if (typeof trusteeCalendarRender === 'function') trusteeCalendarRender();
        if (typeof trusteeStatsUpdate === 'function') trusteeStatsUpdate();
      }
      if (['dashboard', 'inspection', 'docflow', 'logistics-dispatch'].includes(scene)) {
        if (typeof trusteeUpdateModuleBadges === 'function') trusteeUpdateModuleBadges();
      }
    }

    /* AI物流调度：Tab 切换 */
    function logisticsDispatchSwitchTab(tabId) {
      document.querySelectorAll('.logistics-dispatch-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.logistics-dispatch-panel').forEach(p => p.classList.remove('active'));
      const tab = document.querySelector(`.logistics-dispatch-tab[data-tab="${tabId}"]`);
      const panel = document.getElementById(`logistics-dispatch-${tabId}`);
      if (tab) tab.classList.add('active');
      if (panel) panel.classList.add('active');
    }
    function logisticsDispatchToggleWarehouse(warehouseId) {
      const card = document.querySelector(`.logistics-dispatch-warehouse-card[data-warehouse="${warehouseId}"]`);
      if (card) card.classList.toggle('expanded');
    }
    document.querySelectorAll('.logistics-dispatch-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        if (tabId) logisticsDispatchSwitchTab(tabId);
      });
    });

    document.querySelectorAll('.nav-label[data-toggle], .nav-sublabel[data-toggle]').forEach(label => {
      label.addEventListener('click', () => {
        const targetId = label.dataset.toggle;
        const content = document.getElementById(targetId);
        if (content) {
          content.classList.toggle('collapsed');
          label.classList.toggle('collapsed');
        }
      });
    });

    document.querySelectorAll('.nav-item').forEach(el => {
      el.addEventListener('click', () => {
        const scene = el.dataset.scene;
        if (scene) switchScene(scene);
      });
    });

    /* 门店流程智管：Tab 切换 */
    document.querySelectorAll('.storeflow-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const flow = tab.dataset.flow;
        document.querySelectorAll('.storeflow-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.storeflow-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        const panel = document.getElementById('storeflow-' + flow);
        if (panel) panel.classList.add('active');
      });
    });

    document.querySelectorAll('.history-item[data-scene]').forEach(el => {
      el.addEventListener('click', () => {
        switchScene(el.dataset.scene);
      });
    });

    document.querySelectorAll('.quick-ask').forEach(el => {
      el.addEventListener('click', () => {
        if (el.hasAttribute('onclick')) return;
        const text = el.textContent.trim();
        const contractInput = document.getElementById('contractOptimizeInput');
        const contractPanel = document.getElementById('scene-contract');
        const chatInput = document.querySelector('.scene-panel.chat-layout.active .chat-input-bar input');
        const aiInput = document.getElementById('aiInput');
        if (contractInput && contractPanel?.classList.contains('active') && el.closest('#scene-contract')) {
          contractInput.value = text;
          contractInput.focus();
        } else if (el.closest('#scene-reportprecision')) {
          return;
        } else if (chatInput) {
          chatInput.value = text;
          chatInput.focus();
        } else if (aiInput) {
          aiInput.value = text;
          aiInput.focus();
        }
      });
    });

    function sendToAI() {
      const input = document.getElementById('aiInput');
      const q = input?.value?.trim();
      if (q) {
        showToast('已发送：「' + q + '」');
        input.value = '';
      } else {
        showToast('请输入问题后再发送', 'loading');
      }
    }

    function showReport() {
      document.getElementById('reportModal').classList.add('active');
    }
    function closeReport() {
      document.getElementById('reportModal').classList.remove('active');
      document.getElementById('reportExportDropdown')?.classList.remove('open');
    }
    function toggleReportExport() {
      document.getElementById('reportExportDropdown')?.classList.toggle('open');
    }
    function exportReport(format) {
      const fileName = format === 'word' ? '门店经营分析报告_20260130.docx' : '门店经营分析报告_20260130.pdf';
      showDataModal('导出成功', `<div class="report-box success"><strong>已导出至：</strong>${fileName}</div><p style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">包含核心指标、时段明细、品类结构、畅销滞销TOP、根因分析、改进建议等完整内容。</p>`);
      document.getElementById('reportExportDropdown')?.classList.remove('open');
    }

    /* 时间线任务详情：展示简要结果 + 跳转操作 */
    const taskDetails = {
      replenish: {
        title: '补货提醒 · 简要结果',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            检测到 <strong>12</strong> 款商品库存低于安全线，已推送补货建议至补货单。
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>当前库存</th><th>安全线</th><th>建议补货量</th></tr>
            <tr><td>鲜奶</td><td>8 件</td><td>15 件</td><td>20 件</td></tr>
            <tr><td>鸡蛋</td><td>12 盒</td><td>20 盒</td><td>25 盒</td></tr>
            <tr><td>小白菜</td><td>15 kg</td><td>25 kg</td><td>40 kg</td></tr>
            <tr><td>油麦菜</td><td>8 kg</td><td>15 kg</td><td>25 kg</td></tr>
          </table>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已跳转至补货单');">查看完整补货建议</button>
            <button class="btn btn-ghost" onclick="closeDataModal(); showToast('已同步至补货单');">一键同步补货</button>
          </div>
        `,
        action: '查看补货建议'
      },
      purchase: {
        title: '采购订单 · 待确认',
        html: `
          <div class="report-box" style="margin-bottom: 16px; background: rgba(255,179,71,0.1); border-color: rgba(255,179,71,0.3);">
            共 <strong>23</strong> 单采购订单待确认，预计明日 06:00 前到货。
          </div>
          <table class="data-table">
            <tr><th>供应商</th><th>商品</th><th>数量</th><th>金额</th></tr>
            <tr><td>渝北鲜品</td><td>小白菜、油麦菜</td><td>80 kg</td><td>¥420</td></tr>
            <tr><td>江北蛋业</td><td>鸡蛋</td><td>50 盒</td><td>¥380</td></tr>
            <tr><td>南坪肉联</td><td>排骨、五花肉</td><td>45 kg</td><td>¥1,260</td></tr>
          </table>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="quickConfirmOrders(); closeDataModal();">一键确认订单</button>
            <button class="btn btn-ghost" onclick="closeDataModal(); showToast('已跳转至订单修改页');">修改后再确认</button>
          </div>
        `,
        action: '去确认'
      },
      marketing: {
        title: '营销活动 · 蔬菜专区限时 8 折',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            <strong>活动状态：</strong>进行中 · 已同步 POS 与小程序<br>
            <strong>参与商品：</strong>小白菜、莴苣、油麦菜<br>
            <strong>预计效果：</strong>周转提升约 15%
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>原价</th><th>活动价</th><th>折扣</th></tr>
            <tr><td>小白菜</td><td>¥2.98/斤</td><td>¥2.38/斤</td><td>8 折</td></tr>
            <tr><td>莴苣</td><td>¥5.80/斤</td><td>¥4.64/斤</td><td>8 折</td></tr>
            <tr><td>油麦菜</td><td>¥2.38/斤</td><td>¥1.90/斤</td><td>8 折</td></tr>
          </table>
          <div style="margin-top: 16px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已跳转至活动管理');">查看活动详情</button>
          </div>
        `,
        action: '查看活动'
      },
      pricing: {
        title: '自动调价 · 简要结果',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            已根据竞品价格与库存，调整 <strong>8</strong> 款生鲜价格，保持竞争力。其中 3 项需您审核后生效。
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>原价</th><th>新价</th><th>原因</th><th>状态</th></tr>
            <tr><td>有机西红柿</td><td>¥6.50/斤</td><td>¥6.00/斤</td><td>竞品降价</td><td style="color: var(--warning);">待审核</td></tr>
            <tr><td>小白菜</td><td>¥2.98/斤</td><td>¥2.80/斤</td><td>库存充足</td><td style="color: var(--success);">已生效</td></tr>
            <tr><td>莴苣</td><td>¥5.80/斤</td><td>¥5.50/斤</td><td>竞品活动</td><td style="color: var(--warning);">待审核</td></tr>
          </table>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已批量审核通过');">一键审核通过</button>
            <button class="btn btn-ghost" onclick="closeDataModal(); showToast('已跳转至调价修改');">修改后生效</button>
          </div>
        `,
        action: '去审核'
      },
      review: {
        title: '今日经营复盘 · 进行中',
        html: `
          <div class="report-box" style="margin-bottom: 16px; background: var(--accent-dim); border-color: rgba(0,200,150,0.3);">
            正在分析今日销售、损耗、客流量，生成复盘报告…
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 16px;">预计 1-2 分钟内完成，完成后将推送至您的消息中心。</p>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showReport();">查看上周报告</button>
            <button class="btn btn-ghost" onclick="closeDataModal(); showToast('已设置完成后提醒');">稍后提醒</button>
          </div>
        `,
        action: '查看报告'
      },
      tomorrow: {
        title: '明日经营指引',
        html: `
          <div class="report-box" style="margin-bottom: 16px; color: var(--text-muted);">
            复盘完成后将自动生成明日补货、促销、排班建议。当前可参考上周同期数据：
          </div>
          <table class="data-table">
            <tr><th>项目</th><th>建议</th></tr>
            <tr><td>补货重点</td><td>鲜奶、鸡蛋、叶菜</td></tr>
            <tr><td>促销建议</td><td>莴苣组合装</td></tr>
            <tr><td>预计客流</td><td>约 380 人</td></tr>
            <tr><td>排班建议</td><td>早班 +1 人</td></tr>
          </table>
          <div style="margin-top: 16px;">
            <button class="btn btn-ghost" onclick="closeDataModal(); showToast('复盘完成后将自动更新');">稍后查看</button>
          </div>
        `,
        action: '查看计划'
      }
    };
    function showTaskDetail(taskId) {
      const t = taskDetails[taskId];
      if (t) showDataModal(t.title, t.html);
    }
    function show时段明细() {
      showDataModal('时段销售明细', `<table class="data-table"><tr><th>时段</th><th>销售额</th><th>客流</th></tr><tr><td>07:00-09:00</td><td>¥2,180</td><td>62</td></tr><tr><td>09:00-11:00</td><td>¥1,100</td><td>27</td></tr><tr><td>11:00-13:00</td><td>¥2,450</td><td>68</td></tr><tr><td>14:00-16:00</td><td>¥1,820</td><td>52</td></tr><tr><td>16:00-18:00</td><td>¥2,100</td><td>58</td></tr><tr><td>18:00-20:00</td><td>¥2,730</td><td>77</td></tr></table>`);
    }
    /* 报表精准分析 · 下钻明细 */
    const reportDrilldowns = {
      '时段': {
        title: '时段销售明细 · 菜湖店近 7 日',
        html: `
          <div class="report-box warn" style="margin-bottom: 16px;">
            <strong>异常标注：</strong>14:00-16:00 时段客流环比 -15.2%，与周边永辉 14:00 限时 8 折活动时段重合。
          </div>
          <table class="data-table">
            <tr><th>时段</th><th>本周销售额</th><th>上周销售额</th><th>环比</th><th>本周客流</th><th>上周客流</th><th>客流环比</th></tr>
            <tr><td>07:00-09:00</td><td>2.18万</td><td>2.05万</td><td style="color: var(--success);">+6.3%</td><td>620</td><td>598</td><td style="color: var(--success);">+3.7%</td></tr>
            <tr><td>09:00-12:00</td><td>3.42万</td><td>3.28万</td><td style="color: var(--success);">+4.3%</td><td>892</td><td>865</td><td style="color: var(--success);">+3.1%</td></tr>
            <tr><td>12:00-14:00</td><td>2.15万</td><td>2.12万</td><td style="color: var(--success);">+1.4%</td><td>548</td><td>542</td><td style="color: var(--success);">+1.1%</td></tr>
            <tr><td>14:00-16:00</td><td>1.28万</td><td>1.51万</td><td style="color: var(--danger);">-15.2%</td><td>312</td><td>368</td><td style="color: var(--danger);">-15.2%</td></tr>
            <tr><td>16:00-18:00</td><td>1.95万</td><td>1.88万</td><td style="color: var(--success);">+3.7%</td><td>485</td><td>472</td><td style="color: var(--success);">+2.8%</td></tr>
            <tr><td>18:00-21:00</td><td>1.82万</td><td>1.76万</td><td style="color: var(--success);">+3.4%</td><td>383</td><td>375</td><td style="color: var(--success);">+2.1%</td></tr>
          </table>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showReport()">查看完整经营报告</button>
            <button class="btn btn-ghost" onclick="closeDataModal()">关闭</button>
          </div>
        `
      },
      '品类周转': {
        title: '蔬菜品类 · 周转明细 + 商品结构洞察',
        html: `
          <div class="report-drilldown-section">
            <div class="report-drilldown-head">一、周转明细</div>
            <div class="report-box warn" style="margin-bottom: 12px;">
              <strong>趋势预警：</strong>蔬菜整体周转天数连续 2 周上升，油麦菜、莴苣动销放缓。
            </div>
            <table class="data-table">
              <tr><th>品类</th><th>本周周转</th><th>上周周转</th><th>变化</th><th>库存天数</th><th>建议</th></tr>
              <tr><td>油麦菜</td><td>1.8</td><td>1.5</td><td style="color: var(--danger);">+0.3</td><td>5 天</td><td>限时折扣/组合促销</td></tr>
              <tr><td>莴苣</td><td>1.6</td><td>1.4</td><td style="color: var(--danger);">+0.2</td><td>5 天</td><td>限时折扣/组合促销</td></tr>
              <tr><td>小白菜</td><td>1.5</td><td>1.5</td><td>—</td><td>4 天</td><td>保持</td></tr>
              <tr><td>生菜</td><td>2.1</td><td>2.0</td><td style="color: var(--warning);">+0.1</td><td>4 天</td><td>关注</td></tr>
              <tr><td>菠菜</td><td>1.9</td><td>1.8</td><td style="color: var(--warning);">+0.1</td><td>4 天</td><td>关注</td></tr>
            </table>
            <p style="margin-top: 8px; font-size: 11px; color: var(--text-muted);">周转 = 日均销量 / 日均库存；数值越低动销越快</p>
          </div>
          <div class="report-drilldown-section">
            <div class="report-drilldown-head">二、商品结构洞察</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">蔬菜品类占比</div>
            <div class="category-bar" style="margin-bottom: 16px;">
              <span class="veg" style="width: 35%;">叶菜 35%</span>
              <span class="meat" style="width: 28%;">根茎 28%</span>
              <span class="fruit" style="width: 22%;">瓜果 22%</span>
              <span class="other" style="width: 15%;">其他 15%</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="report-box success" style="padding: 12px;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">畅销 Top3</div>
                <div style="font-size: 12px;">小白菜、生菜、菠菜</div>
              </div>
              <div class="report-box warn" style="padding: 12px;">
                <div style="font-weight: 600; margin-bottom: 6px; font-size: 12px;">滞销 周转&lt;2</div>
                <span style="background: rgba(255,179,71,0.3); padding: 2px 6px; border-radius: 4px; font-size: 11px;">促销</span> 油麦菜、莴苣
                <span style="background: rgba(255,107,107,0.3); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;">汰换</span> 西兰花
              </div>
            </div>
            <div class="report-box" style="margin-top: 12px; padding: 10px 12px; font-size: 12px;">
              <strong>汰换建议：</strong>油麦菜、莴苣先促销（限时 8 折或与蛋品组合），观察 1 周；西兰花周转 1.2 次、损耗 12%，建议汰换。
            </div>
          </div>
          <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已加入经营指引')">采纳建议</button>
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已生成汰换建议单')">生成汰换建议单</button>
            <button class="btn btn-ghost" onclick="closeDataModal()">关闭</button>
          </div>
        `
      },
      '品类毛利': {
        title: '标品品类 · 毛利明细 + 定价参考',
        html: `
          <div class="report-drilldown-section">
            <div class="report-drilldown-head">一、品类毛利明细</div>
            <div class="report-box warn" style="margin-bottom: 12px;">
              <strong>异常标注：</strong>标品毛利率较上周 -1.2%，可能与促销力度加大、成本小幅上涨有关。
            </div>
            <table class="data-table">
              <tr><th>品类</th><th>本周毛利率</th><th>上周毛利率</th><th>变化</th><th>可能原因</th></tr>
              <tr><td>蔬菜</td><td>22.5%</td><td>22.8%</td><td style="color: var(--warning);">-0.3%</td><td>促销</td></tr>
              <tr><td>肉禽</td><td>18.2%</td><td>18.1%</td><td style="color: var(--success);">+0.1%</td><td>—</td></tr>
              <tr><td>水果</td><td>25.1%</td><td>25.0%</td><td style="color: var(--success);">+0.1%</td><td>—</td></tr>
              <tr><td>标品</td><td>15.8%</td><td>17.0%</td><td style="color: var(--danger);">-1.2%</td><td>促销+成本</td></tr>
              <tr><td>熟食</td><td>32.5%</td><td>32.3%</td><td style="color: var(--success);">+0.2%</td><td>—</td></tr>
            </table>
          </div>
          <div class="report-drilldown-section">
            <div class="report-drilldown-head">二、标品定价参考</div>
            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">代表商品：鲜奶、食用油、调味品等，竞品与成本参考</p>
            <table class="data-table">
              <tr><th>商品</th><th>竞品价</th><th>成本</th><th>建议价</th><th>毛利率</th><th>操作</th></tr>
              <tr>
                <td>鲜奶 250ml</td>
                <td>3.80–4.20 元/盒<br><span style="font-size: 11px; color: var(--text-muted);">永辉 ¥3.98</span></td>
                <td>2.65 元/盒</td>
                <td style="color: var(--accent); font-weight: 600;">3.60–3.90 元/盒</td>
                <td>26–32%</td>
                <td><button class="btn-sm btn-primary" onclick="showToast('已同步定价')">同步</button></td>
              </tr>
              <tr>
                <td>食用油 5L</td>
                <td>68–75 元/桶<br><span style="font-size: 11px; color: var(--text-muted);">盒马 ¥72</span></td>
                <td>52 元/桶</td>
                <td style="color: var(--accent); font-weight: 600;">69–72 元/桶</td>
                <td>25–29%</td>
                <td><button class="btn-sm btn-primary" onclick="showToast('已同步定价')">同步</button></td>
              </tr>
              <tr>
                <td>酱油 500ml</td>
                <td>8.50–9.80 元/瓶</td>
                <td>5.20 元/瓶</td>
                <td style="color: var(--accent); font-weight: 600;">8.80–9.50 元/瓶</td>
                <td>41–45%</td>
                <td><button class="btn-sm btn-primary" onclick="showToast('已同步定价')">同步</button></td>
              </tr>
            </table>
            <div class="report-box" style="margin-top: 12px; padding: 10px 12px; font-size: 12px;">
              <strong>策略建议：</strong>标品毛利承压，建议 1）减少无谓促销，重点商品做限时引流；2）成本上涨品类可微调 2–3%；3）高毛利调味品保持，低毛利鲜奶可做组合促销。
            </div>
          </div>
          <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已批量同步标品定价')">批量同步定价</button>
            <button class="btn btn-ghost" onclick="closeDataModal()">关闭</button>
          </div>
        `
      }
    };
    function showReportDrilldown(type) {
      const d = reportDrilldowns[type];
      if (d) showDataModal(d.title, d.html);
    }

    /* 明日经营指引卡片点击：展示详情或跳转 */
    const planDetails = {
      replenish: { title: '明日补货重点', html: '<table class="data-table"><tr><th>品类</th><th>建议量</th><th>依据</th></tr><tr><td>鲜奶</td><td>20 件</td><td>今日销量 + 周末加量</td></tr><tr><td>鸡蛋</td><td>25 盒</td><td>库存 12 盒，安全线 20</td></tr><tr><td>叶菜</td><td>50 kg</td><td>小白菜、油麦菜、莴苣</td></tr></table><div style="margin-top: 16px;"><button class="btn btn-primary" onclick="closeDataModal(); showTaskDetail(\'replenish\')">查看补货建议</button></div>' },
      marketing: { title: '明日促销建议', html: '<div class="report-box success" style="margin-bottom: 16px;">莴苣组合装 · 14:00-18:00<br>预计可拉升下午时段客流 8-12%</div><div style="margin-top: 16px;"><button class="btn btn-primary" onclick="closeDataModal(); showTaskDetail(\'marketing\')">查看活动详情</button></div>' },
      traffic: { title: '明日客流预测', html: '<table class="data-table"><tr><th>时段</th><th>预计客流</th><th>较今日</th></tr><tr><td>早高峰 7:00-9:00</td><td>约 85 人</td><td style="color: var(--success);">+12%</td></tr><tr><td>午间 11:00-13:00</td><td>约 95 人</td><td>+8%</td></tr><tr><td>下午 14:00-18:00</td><td>约 120 人</td><td style="color: var(--success);">+15%</td></tr><tr><td>晚高峰 18:00-20:00</td><td>约 80 人</td><td>+5%</td></tr></table><p style="margin-top: 12px; color: var(--text-muted); font-size: 12px;">基于周末 + 促销活动综合预测</p>' },
      shift: { title: '明日排班建议', html: '<table class="data-table"><tr><th>时段</th><th>建议人数</th><th>说明</th></tr><tr><td>早班 6:00-14:00</td><td>+1 人</td><td>周末早高峰 + 到货验收</td></tr><tr><td>中班 10:00-18:00</td><td>—</td><td>保持</td></tr><tr><td>晚班 14:00-22:00</td><td>—</td><td>保持</td></tr></table><div style="margin-top: 16px;"><button class="btn btn-primary" onclick="closeDataModal(); showToast(\'已跳转至排班系统\')">去排班</button></div>' },
      delivery: { title: '明日到货提醒', html: '<table class="data-table"><tr><th>供应商</th><th>预计到货</th><th>商品</th></tr><tr><td>渝北鲜品</td><td>06:00</td><td>小白菜、油麦菜、叶菜</td></tr><tr><td>江北蛋业</td><td>07:30</td><td>鸡蛋</td></tr><tr><td>南坪肉联</td><td>08:00</td><td>排骨、五花肉</td></tr></table><p style="margin-top: 12px; color: var(--text-muted); font-size: 12px;">采购订单确认后生效</p><div style="margin-top: 16px;"><button class="btn btn-primary" onclick="closeDataModal(); showTaskDetail(\'purchase\')">查看采购订单</button></div>' }
    };

    /* AI门店巡检详情 */
    const inspectionDetails = {
      expiring: {
        title: '临期/滞销 · 促销建议',
        html: `
          <div class="report-box warn" style="margin-bottom: 16px;">
            共发现 <strong>5</strong> 款临期商品、<strong>3</strong> 款滞销，建议限时促销或组合促销。
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>剩余天数/周转</th><th>库存</th><th>建议</th></tr>
            <tr><td>西兰花</td><td>2 天</td><td>8 kg</td><td>限时 8 折</td></tr>
            <tr><td>小白菜</td><td>周转 1.5</td><td>15 kg</td><td>与蛋品组合促销</td></tr>
            <tr><td>莴苣</td><td>周转 1.6</td><td>12 kg</td><td>与蛋品组合促销</td></tr>
            <tr><td>油麦菜</td><td>周转 1.8</td><td>8 kg</td><td>与蛋品组合促销</td></tr>
            <tr><td>预制红烧肉</td><td>4 天</td><td>6 盒</td><td>限时折扣</td></tr>
          </table>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已同步至促销系统');">一键同步促销</button>
            <button class="btn btn-ghost" onclick="closeDataModal(); showTaskDetail('marketing');">查看营销活动</button>
          </div>
        `
      },
      inventory: {
        title: '库存异常 · 调拨建议',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            断货 <strong>0</strong> 款，超储 <strong>2</strong> 款。超储商品建议调拨至周边门店或限时促销。
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>当前库存</th><th>安全线</th><th>建议</th></tr>
            <tr><td>有机西红柿</td><td>45 kg</td><td>25 kg</td><td>调拨至南坪店 15 kg</td></tr>
            <tr><td>鲜奶</td><td>28 件</td><td>15 件</td><td>限时促销 5 件</td></tr>
          </table>
          <div style="margin-top: 16px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已生成调拨单');">生成调拨单</button>
          </div>
        `
      },
      loss: {
        title: '损耗预警 · 建议',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            整体损耗率 <strong>2.1%</strong>，在合理范围。西兰花预计损耗偏高，建议限时促销。
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>预计损耗率</th><th>库存天数</th><th>建议</th></tr>
            <tr><td>西兰花</td><td>3.2%</td><td>8 天</td><td>限时 8 折</td></tr>
          </table>
          <div style="margin-top: 16px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showInspectionDetail('expiring');">查看促销建议</button>
          </div>
        `
      },
      cert: {
        title: '资质/证照 · 到期提醒',
        html: `
          <div class="report-box warn" style="margin-bottom: 16px;">
            共 <strong>1</strong> 份检测报告 7 天后到期，请及时续办。
          </div>
          <table class="data-table">
            <tr><th>供应商</th><th>证照类型</th><th>到期日</th><th>操作</th></tr>
            <tr><td>渝北鲜品</td><td>检测报告</td><td>2026-02-06</td><td><button class="btn-sm btn-primary" onclick="closeDataModal(); showToast('已推送续办提醒');">续办提醒</button></td></tr>
          </table>
        `
      },
      license: {
        title: '门店证照 · 巡检结果',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            菜湖店（A01032）门店证照均在有效期内，无需处置。
          </div>
          <div style="margin-bottom: 12px;"><strong>营业执照</strong> · 统一社会信用代码 91500103MA5XXX · 有效期至 2028-12-31</div>
          <div style="margin-bottom: 12px;"><strong>食品经营许可证</strong> · 渝食药监食经许字[2024]第XXX号 · 有效期至 2027-06-30</div>
          <p style="font-size: 12px; color: var(--text-muted);">系统每日 07:15 自动巡检，到期前 30 天将推送续办提醒至店长及运营。</p>
        `
      },
      foodSafety: {
        title: '食安报告/批次检测 · 巡检结果',
        html: `
          <div class="report-box warn" style="margin-bottom: 16px;">
            共 <strong>2</strong> 款商品缺批次检测报告，收货环节将无法通过合格验证，请督促供应商补传。
          </div>
          <div style="margin-bottom: 12px;"><strong>缺报告商品：</strong>有机西红柿（批次 20260128-A）、鲜切菠萝（批次 20260127-B）</div>
          <div style="margin-bottom: 12px;"><strong>合规要求：</strong>《食品安全法》要求食用农产品全流程可追溯，收货时需验证合格证及批次检测报告，缺证商品不得入库。</div>
          <div style="margin-top: 16px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已推送补传提醒至供应商');">推送补传提醒</button>
            <button class="btn btn-ghost" onclick="closeDataModal();">关闭</button>
          </div>
        `
      },
      daily: {
        title: '今日巡检日报',
        html: `
          <div class="report-daily-header">
            <div class="report-daily-title">2025-01-30 菜湖店巡检日报</div>
            <div class="report-daily-meta">生成时间 21:05 · 巡检项 9 项</div>
            <div class="report-daily-badges">
              <span class="report-badge ok"><strong>6</strong> 正常</span>
              <span class="report-badge warn"><strong>2</strong> 预警</span>
              <span class="report-badge alert"><strong>1</strong> 异常</span>
            </div>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">一、临期与滞销</div>
            <div class="report-mini-kpi">
              <div class="mini-kpi-item"><span class="mini-kpi-val" style="color: var(--warning);">5</span><span class="mini-kpi-label">临期</span></div>
              <div class="mini-kpi-item"><span class="mini-kpi-val" style="color: var(--warning);">3</span><span class="mini-kpi-label">滞销</span></div>
            </div>
            <ul class="report-list">
              <li><strong>临期：</strong>西兰花 2 天、预制红烧肉 4 天 → 建议限时折扣</li>
              <li><strong>滞销：</strong>小白菜、莴苣、油麦菜周转&lt;2 次 → 建议与蛋品组合促销</li>
            </ul>
            <div class="report-tag">已生成促销建议单，可一键同步 POS/小程序</div>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">二、库存与损耗</div>
            <div class="report-mini-kpi">
              <div class="mini-kpi-item"><span class="mini-kpi-val" style="color: var(--success);">0</span><span class="mini-kpi-label">断货</span></div>
              <div class="mini-kpi-item"><span class="mini-kpi-val" style="color: var(--warning);">2</span><span class="mini-kpi-label">超储</span></div>
              <div class="mini-kpi-item"><span class="mini-kpi-val" style="color: var(--success);">2.1%</span><span class="mini-kpi-label">损耗率</span></div>
            </div>
            <ul class="report-list">
              <li>超储：有机西红柿 45 kg、鲜奶 28 件 → 已推送调拨/促销建议</li>
              <li>损耗：西兰花预计偏高 → 建议纳入下午限时促销</li>
            </ul>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">三、合规与证照</div>
            <div class="report-status-row">
              <span class="status-chip ok">门店证照 正常</span>
              <span class="status-chip warn">渝北鲜品 7 天后到期</span>
              <span class="status-chip warn">2 款缺批次检测</span>
            </div>
            <ul class="report-list">
              <li>营业执照、食品经营许可证均在有效期内</li>
              <li>供应商渝北鲜品检测报告 2 月 6 日到期，已推送续办</li>
              <li>有机西红柿、鲜切菠萝缺批次检测，已推送补传提醒</li>
            </ul>
          </div>
          <div class="report-daily-section report-daily-alert">
            <div class="report-section-title">四、待处置异常</div>
            <div class="report-alert-card">
              <strong>对账差异 CD-20260114</strong> · 金额差 ¥320 · 建议核对运费分摊
            </div>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">已自动升级至财务，请优先跟进</p>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">五、明日关注</div>
            <div class="report-focus-list">
              <div class="focus-item">① 叶菜限时促销/组合蛋品执行效果</div>
              <div class="focus-item">② 超储商品调拨单确认</div>
              <div class="focus-item">③ 渝北鲜品检测报告续办进度</div>
            </div>
          </div>
          <div style="margin-top: 20px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已导出今日巡检日报.pdf');">导出日报</button>
            <button class="btn btn-ghost" onclick="closeDataModal();">关闭</button>
          </div>
        `
      },
      weekly: {
        title: '本周巡检周报',
        html: `
          <div class="report-daily-header">
            <div class="report-daily-title">2025-01-27 ~ 02-02 菜湖店巡检周报</div>
            <div class="report-daily-meta">生成时间 周一 08:00 · 本周异常较上周 -2 项</div>
            <div class="report-daily-badges">
              <span class="report-badge ok">临期处理及时率 <strong>92%</strong></span>
              <span class="report-badge ok">合规项 <strong>全部通过</strong></span>
            </div>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">一、本周巡检趋势</div>
            <div class="report-trend-grid">
              <div class="trend-item">
                <span class="trend-label">临期/滞销</span>
                <span class="trend-val">12 款</span>
                <span class="trend-change down">↓ 较上周 15 款</span>
              </div>
              <div class="trend-item">
                <span class="trend-label">库存异常</span>
                <span class="trend-val">5 次</span>
                <span class="trend-change down">↓ 较上周 6 次</span>
              </div>
              <div class="trend-item">
                <span class="trend-label">对账差异</span>
                <span class="trend-val">1 笔</span>
                <span class="trend-change down">↓ 较上周 2 笔</span>
              </div>
            </div>
            <p class="report-daily-note">临期改善主要得益于叶菜组合促销执行到位；超储多为有机西红柿、鲜奶，建议持续关注调拨与促销。</p>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">二、合规与食安</div>
            <div class="report-status-row">
              <span class="status-chip ok">门店证照 有效</span>
              <span class="status-chip warn">渝北鲜品 2/6 到期</span>
              <span class="status-chip ok">食安缺报告 2 款 ↓</span>
            </div>
            <ul class="report-list">
              <li>门店营业执照、食品经营许可证本周全部在有效期内</li>
              <li>供应商渝北鲜品检测报告 2 月 6 日到期，已推送续办</li>
              <li>商品食安报告本周 2 款缺批次检测，较上周 3 款有改善</li>
            </ul>
          </div>
          <div class="report-daily-section">
            <div class="report-section-title">三、改进建议</div>
            <div class="report-suggest-grid">
              <div class="suggest-card">
                <div class="suggest-num">1</div>
                <div class="suggest-text">叶菜类临期预警提前至 3 天推送，便于安排促销档期</div>
              </div>
              <div class="suggest-card">
                <div class="suggest-num">2</div>
                <div class="suggest-text">超储商品与周边门店建立调拨联动，减少限时促销对毛利影响</div>
              </div>
              <div class="suggest-card">
                <div class="suggest-num">3</div>
                <div class="suggest-text">食安补传提醒增加供应商联系人，提高补传效率</div>
              </div>
            </div>
          </div>
          <div class="report-daily-section report-daily-focus">
            <div class="report-section-title">四、下周重点关注</div>
            <div class="report-focus-list">
              <div class="focus-item">渝北鲜品检测报告续办</div>
              <div class="focus-item">对账差异 CD-20260114 处理闭环</div>
              <div class="focus-item">叶菜类临期预警提前配置</div>
            </div>
          </div>
          <div style="margin-top: 20px; display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="closeDataModal(); showToast('已导出本周巡检周报.pdf');">导出周报</button>
            <button class="btn btn-ghost" onclick="closeDataModal();">关闭</button>
          </div>
        `
      }
    };

    function showPlanDetail(planId) {
      const p = planDetails[planId];
      if (p) showDataModal(p.title, p.html);
    }
    function showInspectionDetail(type) {
      const d = inspectionDetails[type];
      if (d) showDataModal(d.title, d.html);
    }
    function showInspectionConfigModal() {
      const html = `
        <div class="config-modal-desc">配置巡检项、执行频率、预警阈值及异常升级规则，支持按门店或区域批量应用。</div>
        <div class="config-modal-section">
          <div class="config-modal-title">巡检项开关</div>
          <div class="config-modal-checkboxes">
            <label class="config-check-item"><input type="checkbox" checked> 临期/滞销扫描</label>
            <label class="config-check-item"><input type="checkbox" checked> 库存异常</label>
            <label class="config-check-item"><input type="checkbox" checked> 损耗预警</label>
            <label class="config-check-item"><input type="checkbox" checked> 供应商资质/证照</label>
            <label class="config-check-item"><input type="checkbox" checked> 门店营业执照/食品证</label>
            <label class="config-check-item"><input type="checkbox" checked> 食安报告/批次检测</label>
          </div>
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">执行频率</div>
          <div class="config-modal-rows">
            <div class="config-row"><span class="config-label">日检时间</span><input class="config-input" type="text" value="06:00"></div>
            <div class="config-row"><span class="config-label">周检时间</span><select class="config-input config-select"><option>周一 08:00</option><option>周二 08:00</option><option>周三 08:00</option></select></div>
          </div>
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">预警阈值</div>
          <div class="config-modal-rows">
            <div class="config-row"><span class="config-label">临期提前天数</span><input class="config-input config-input-sm" type="text" value="3"><span class="config-unit">天</span></div>
            <div class="config-row"><span class="config-label">滞销周转阈值</span><input class="config-input config-input-sm" type="text" value="2"><span class="config-unit">次</span></div>
            <div class="config-row"><span class="config-label">证照到期提前</span><input class="config-input config-input-sm" type="text" value="30"><span class="config-unit">天</span></div>
          </div>
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">异常升级规则</div>
          <div class="config-modal-note">对账差异超 200 元、证照 7 天内到期、食安缺报告超 2 款时，自动升级至责任人并推送工单。</div>
          <div class="config-row"><span class="config-label">升级对象</span><input class="config-input config-input-full" type="text" value="店长、运营、财务" placeholder="逗号分隔"></div>
        </div>
        <div class="config-modal-actions">
          <button class="btn btn-primary" onclick="closeDataModal(); showToast('巡检规则已保存');">保存配置</button>
          <button class="btn btn-ghost" onclick="closeDataModal();">取消</button>
        </div>
      `;
      showDataModal('配置巡检规则', html);
    }

    /* AI单据流托管：数据与渲染 */
    const docflowItemsData = [
      { id: 'purchase-1', docno: 'CG-20260130-001', type: '采购单', status: 'ok', desc: '渝北鲜品 · 小白菜 80kg · ¥420', descHtml: '渝北鲜品 · 小白菜 80kg · <span class="docflow-amount">¥420</span>', flow: [{ n: '门店发起', s: 'done', t: '08:10' }, { n: '采购员提交', s: 'done', t: '08:12' }, { n: 'AI审核', s: 'done', t: '08:15' }, { n: '财务复核', s: 'done', t: '08:18' }, { n: '推供应商', s: 'done', t: '08:20' }], date: '2026-01-30', time: '08:15', supplier: '渝北鲜品' },
      { id: 'purchase-2', docno: 'CG-20260130-002', type: '采购单', status: 'warn', desc: '南坪肉联 · 排骨 45kg · ¥1,260', descHtml: '南坪肉联 · 排骨 45kg · <span class="docflow-amount">¥1,260</span>', flow: [{ n: '门店发起', s: 'done', t: '09:15' }, { n: '采购员提交', s: 'done', t: '09:18' }, { n: 'AI审核', s: 'done', t: '09:20' }, { n: '待店长确认', s: 'current', t: '-' }, { n: '财务复核', s: 'pending', t: '' }, { n: '推供应商', s: 'pending', t: '' }], date: '2026-01-30', time: '09:20', supplier: '南坪肉联' },
      { id: 'purchase-3', docno: 'CG-20260130-003', type: '采购单', status: 'ok', desc: '江北蛋业 · 鸡蛋 50 盒 · ¥380', descHtml: '江北蛋业 · 鸡蛋 50 盒 · <span class="docflow-amount">¥380</span>', flow: [{ n: '门店发起', s: 'done', t: '10:00' }, { n: '采购员提交', s: 'done', t: '10:02' }, { n: 'AI审核', s: 'done', t: '10:05' }, { n: '财务复核', s: 'done', t: '10:08' }, { n: '推供应商', s: 'done', t: '10:10' }], date: '2026-01-30', time: '10:05', supplier: '江北蛋业' },
      { id: 'purchase-4', docno: 'CG-20260129-015', type: '采购单', status: 'ok', desc: '永辉供应链 · 预制菜 20 箱 · ¥1,680', descHtml: '永辉供应链 · 预制菜 20 箱 · <span class="docflow-amount">¥1,680</span>', flow: [{ n: '门店发起', s: 'done', t: '14:20' }, { n: '采购员提交', s: 'done', t: '14:25' }, { n: 'AI审核', s: 'done', t: '14:28' }, { n: '财务复核', s: 'done', t: '14:35' }, { n: '推供应商', s: 'done', t: '14:40' }], date: '2026-01-29', time: '14:28', supplier: '永辉供应链' },
      { id: 'transfer-1', docno: 'DB-20260129-008', type: '调拨单', status: 'alert', desc: '有机西红柿 15kg · 菜湖→南坪', descHtml: '有机西红柿 15kg · 菜湖→南坪 · <span class="docflow-highlight">卡单 6h</span>', flow: [{ n: '发起', s: 'done', t: '14:00' }, { n: '调出店确认', s: 'done', t: '14:05' }, { n: '仓库确认', s: 'error', t: '超时' }, { n: '物流配送', s: 'pending', t: '' }, { n: '调入店收货', s: 'pending', t: '' }], date: '2026-01-29', time: '14:00', supplier: '', causeType: 'system', causeText: '仓库确认环节调用 WMS 接口超时，判定为系统问题' },
      { id: 'transfer-2', docno: 'DB-20260130-003', type: '调拨单', status: 'ok', desc: '油麦菜 30kg · 南坪→菜湖', descHtml: '油麦菜 30kg · 南坪→菜湖', flow: [{ n: '发起', s: 'done', t: '06:30' }, { n: '调出店确认', s: 'done', t: '06:35' }, { n: '仓库确认', s: 'done', t: '06:45' }, { n: '物流配送', s: 'done', t: '08:20' }, { n: '调入店收货', s: 'done', t: '08:50' }], date: '2026-01-30', time: '08:50', supplier: '' },
      { id: 'return-1', docno: 'TH-20260128-003', type: '退货单', status: 'alert', desc: '渝北鲜品 · 西兰花 10kg 品质问题', descHtml: '渝北鲜品 · 西兰花 10kg 品质问题 · <span class="docflow-highlight">卡单 12h</span>', flow: [{ n: '门店发起', s: 'done', t: '10:00' }, { n: '店长审批', s: 'done', t: '10:15' }, { n: '供应商确认', s: 'error', t: '超时' }, { n: '物流取货', s: 'pending', t: '' }, { n: '完成', s: 'pending', t: '' }], date: '2026-01-28', time: '10:00', supplier: '渝北鲜品', causeType: 'business', causeText: '供应商未响应超 12 小时，判定为业务问题，需人工催办' },
      { id: 'return-2', docno: 'TH-20260129-001', type: '退货单', status: 'ok', desc: '南坪肉联 · 排骨 5kg 临期', descHtml: '南坪肉联 · 排骨 5kg 临期', flow: [{ n: '门店发起', s: 'done', t: '09:00' }, { n: '店长审批', s: 'done', t: '09:10' }, { n: '供应商确认', s: 'done', t: '09:30' }, { n: '物流取货', s: 'done', t: '11:00' }, { n: '完成', s: 'done', t: '11:30' }], date: '2026-01-29', time: '11:30', supplier: '南坪肉联' },
      { id: 'reconcile-1', docno: 'CD-20260114', type: '对账单', status: 'warn', desc: '休库配送单 · 差异 ¥320', descHtml: '休库配送单 · 差异 <span class="docflow-amount">¥320</span>', flow: [{ n: '发起', s: 'done', t: '09:00' }, { n: '金蝶对账', s: 'done', t: '09:30' }, { n: '差异待处理', s: 'current', t: '-' }, { n: '财务确认', s: 'pending', t: '' }, { n: '归档', s: 'pending', t: '' }], date: '2026-01-14', time: '09:00', supplier: '' },
      { id: 'reconcile-2', docno: 'CD-20260128', type: '对账单', status: 'ok', desc: '渝北鲜品 1 月对账 · 无差异', descHtml: '渝北鲜品 1 月对账 · 无差异', flow: [{ n: '发起', s: 'done', t: '10:00' }, { n: '金蝶对账', s: 'done', t: '10:15' }, { n: '财务确认', s: 'done', t: '10:30' }, { n: '归档', s: 'done', t: '10:35' }], date: '2026-01-28', time: '10:35', supplier: '渝北鲜品' },
      { id: 'voucher-1', docno: 'PZ-20260130-089', type: '凭证', status: 'ok', desc: '菜湖店 1/30 入库凭证', descHtml: '菜湖店 1/30 入库凭证', flow: [{ n: '发起', s: 'done', t: '08:00' }, { n: '财务录入', s: 'done', t: '08:15' }, { n: 'AI稽核', s: 'done', t: '08:18' }, { n: '归档', s: 'done', t: '08:20' }], date: '2026-01-30', time: '08:20', supplier: '' },
      { id: 'purchase-5', docno: 'CG-20260129-022', type: '采购单', status: 'reject', desc: '新供应商 · 有机蔬菜 50kg · ¥2,800', descHtml: '新供应商 · 有机蔬菜 50kg · <span class="docflow-amount">¥2,800</span> · <span class="docflow-highlight">已驳回</span>', flow: [{ n: '门店发起', s: 'done', t: '11:00' }, { n: '采购员提交', s: 'done', t: '11:15' }, { n: 'AI审核', s: 'done', t: '11:18' }, { n: 'AI驳回', s: 'error', t: '11:18' }], date: '2026-01-29', time: '11:18', supplier: '新供应商', rejectReason: '供应商资质未通过审核' },
      { id: 'purchase-6', docno: 'CG-20260128-018', type: '采购单', status: 'reject', desc: '渝北鲜品 · 进口牛油果 100 个 · ¥1,890', descHtml: '渝北鲜品 · 进口牛油果 100 个 · <span class="docflow-amount">¥1,890</span> · <span class="docflow-highlight">已驳回</span>', flow: [{ n: '门店发起', s: 'done', t: '14:20' }, { n: '采购员提交', s: 'done', t: '14:35' }, { n: 'AI审核', s: 'done', t: '14:38' }, { n: 'AI驳回', s: 'error', t: '14:38' }], date: '2026-01-28', time: '14:38', supplier: '渝北鲜品', rejectReason: '单价较市价偏高 15%，建议重新询价' },
      { id: 'transfer-3', docno: 'DB-20260128-012', type: '调拨单', status: 'reject', desc: '草莓 20kg · 南坪→菜湖', descHtml: '草莓 20kg · 南坪→菜湖 · <span class="docflow-highlight">已驳回</span>', flow: [{ n: '发起', s: 'done', t: '09:00' }, { n: '调出店确认', s: 'done', t: '09:10' }, { n: 'AI审核', s: 'done', t: '09:12' }, { n: 'AI驳回', s: 'error', t: '09:12' }], date: '2026-01-28', time: '09:12', supplier: '', rejectReason: '调出店库存不足，无法满足调拨量' },
      { id: 'return-3', docno: 'TH-20260127-005', type: '退货单', status: 'reject', desc: '南坪肉联 · 排骨 8kg 临期', descHtml: '南坪肉联 · 排骨 8kg 临期 · <span class="docflow-highlight">已驳回</span>', flow: [{ n: '门店发起', s: 'done', t: '16:00' }, { n: '店长审批', s: 'done', t: '16:15' }, { n: 'AI审核', s: 'done', t: '16:18' }, { n: 'AI驳回', s: 'error', t: '16:18' }], date: '2026-01-27', time: '16:18', supplier: '南坪肉联', rejectReason: '退货理由不充分，临期日期距今日超过 7 天' },
      { id: 'voucher-2', docno: 'PZ-20260126-156', type: '凭证', status: 'reject', desc: '南坪店 1/26 入库凭证', descHtml: '南坪店 1/26 入库凭证 · <span class="docflow-highlight">已驳回</span>', flow: [{ n: '发起', s: 'done', t: '10:00' }, { n: '财务录入', s: 'done', t: '10:20' }, { n: 'AI稽核', s: 'done', t: '10:22' }, { n: 'AI驳回', s: 'error', t: '10:22' }], date: '2026-01-26', time: '10:22', supplier: '', rejectReason: '凭证金额与采购单 CG-20260125-033 不一致，差 ¥120' }
    ];
    const docflowTypeLabels = { '采购单': '采购单', '调拨单': '调拨单', '退货单': '退货单', '对账单': '对账单', '凭证': '凭证' };
    const docflowStatusLabels = { ok: 'AI 自动通过', warn: '待人工', alert: '异常中断', reject: '已驳回' };
    let docflowFilter = { type: 'all', range: 'week', search: '' };
    let docflowPage = 1;
    const docflowPageSize = 10;
    let docflowSelectedIds = new Set();
    const docflowRetryState = {}; // { docId: 'idle'|'retrying'|'success' }

    function getDocflowDateLabel(dateStr) {
      const d = new Date(dateStr);
      const today = new Date();
      today.setHours(0,0,0,0);
      const docDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const diff = Math.floor((today - docDate) / 86400000);
      if (diff === 0) return '今日';
      if (diff === 1) return '昨日';
      if (diff < 7) return diff + ' 天前';
      return dateStr.slice(5, 10);
    }
    function docflowInRange(item, range) {
      const d = new Date(item.date);
      const today = new Date();
      today.setHours(0,0,0,0);
      const docDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const diff = Math.floor((today - docDate) / 86400000);
      if (range === 'today') return diff === 0;
      if (range === 'yesterday') return diff === 1;
      if (range === 'week') return diff >= 0 && diff < 7;
      return true;
    }
    function renderDocflowList() {
      const listEl = document.getElementById('docflowList');
      const emptyEl = document.getElementById('docflowEmpty');
      const emptyTextEl = document.getElementById('docflowEmptyText');
      const titleEl = document.getElementById('docflowListTitle');
      const rangeLabels = { today: '今日', yesterday: '昨日', week: '近 7 天' };
      titleEl.textContent = rangeLabels[docflowFilter.range] || '近期单据';
      let allItems = docflowItemsData.filter(i => {
        if (docflowFilter.type !== 'all' && i.type !== docflowFilter.type) return false;
        if (!docflowInRange(i, docflowFilter.range)) return false;
        if (docflowFilter.search) {
          const q = docflowFilter.search.toLowerCase();
          if (!i.docno.toLowerCase().includes(q) && !i.supplier.toLowerCase().includes(q) && !i.desc.toLowerCase().includes(q)) return false;
        }
        return true;
      });
      const totalPages = Math.max(1, Math.ceil(allItems.length / docflowPageSize));
      if (docflowPage > totalPages) docflowPage = totalPages;
      const start = (docflowPage - 1) * docflowPageSize;
      const items = allItems.slice(start, start + docflowPageSize);
      const paginationEl = document.getElementById('docflowPagination');
      const pagePrevEl = document.getElementById('docflowPagePrev');
      const pageNextEl = document.getElementById('docflowPageNext');
      const pageInfoEl = document.getElementById('docflowPageInfo');
      if (allItems.length > docflowPageSize) {
        paginationEl.style.display = 'flex';
        if (pageInfoEl) pageInfoEl.textContent = docflowPage + ' / ' + totalPages;
        if (pagePrevEl) { pagePrevEl.disabled = docflowPage <= 1; pagePrevEl.style.opacity = docflowPage <= 1 ? '0.5' : '1'; }
        if (pageNextEl) { pageNextEl.disabled = docflowPage >= totalPages; pageNextEl.style.opacity = docflowPage >= totalPages ? '0.5' : '1'; }
      } else {
        paginationEl.style.display = 'none';
      }
      listEl.innerHTML = items.map(item => {
        const statusClass = item.status === 'ok' ? 'docflow-item-auto' : item.status === 'warn' ? 'docflow-item-pending' : item.status === 'reject' ? 'docflow-item-reject' : 'docflow-item-error';
        const dateLabel = getDocflowDateLabel(item.date);
        const flowHtml = item.flow.map((f, i) => {
          const cls = f.s === 'done' ? 'done' : f.s === 'current' ? 'current' : f.s === 'error' ? 'error' : 'pending';
          const arr = i < item.flow.length - 1 ? '<span class="docflow-flow-arrow">→</span>' : '';
          return '<span class="docflow-flow-node ' + cls + '">' + f.n + '</span>' + arr;
        }).join('');
        const checkbox = item.status === 'warn' ? '<input type="checkbox" class="docflow-item-checkbox" data-docid="' + item.id + '" onclick="event.stopPropagation();" onchange="docflowToggleSelect(\'' + item.id + '\')">' : '';
        const statusLabel = docflowStatusLabels[item.status] || item.status;
        return '<div class="docflow-item ' + statusClass + '" data-docid="' + item.id + '" onclick="showDocflowDetail(\'' + item.id + '\')">' +
          '<div class="docflow-item-inner">' +
          '<div class="docflow-item-checkbox-wrap">' + (checkbox || '') + '</div>' +
          '<div class="docflow-item-body" style="flex:1;min-width:0;">' +
          '<div class="docflow-item-header"><div class="docflow-item-header-left"><span class="docflow-docno">' + item.docno + '</span><span class="docflow-item-time">' + dateLabel + ' ' + item.time + '</span></div><span class="docflow-status ' + item.status + '">' + statusLabel + '</span></div>' +
          '<div class="docflow-item-desc">' + item.descHtml + '</div>' +
          '<div class="docflow-flow-visual">' + flowHtml + '</div>' +
          '</div></div></div>';
      }).join('');
      emptyEl.style.display = items.length ? 'none' : 'block';
      emptyTextEl.textContent = docflowFilter.type !== 'all' ? '暂无' + docflowFilter.type : (docflowFilter.search ? '未找到匹配单据' : '暂无单据');
      docflowUpdateTabCounts();
      const auto = docflowItemsData.filter(i => i.status === 'ok').length;
      const pend = docflowItemsData.filter(i => i.status === 'warn').length;
      const err = docflowItemsData.filter(i => i.status === 'alert').length;
      const reject = docflowItemsData.filter(i => i.status === 'reject').length;
      const total = docflowItemsData.length;
      const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
      el('docflowStatAuto', auto);
      el('docflowStatPending', pend);
      el('docflowStatError', err);
      el('docflowStatReject', reject);
      el('docflowStatTotal', total);
    }
    function docflowUpdateTabCounts() {
      const counts = { 采购单: 0, 调拨单: 0, 退货单: 0, 对账单: 0, 凭证: 0 };
      const q = (docflowFilter.search || '').toLowerCase();
      docflowItemsData.forEach(i => {
        if (!docflowInRange(i, docflowFilter.range)) return;
        if (q && !i.docno.toLowerCase().includes(q) && !(i.supplier||'').toLowerCase().includes(q) && !i.desc.toLowerCase().includes(q)) return;
        if (counts[i.type] !== undefined) counts[i.type]++;
      });
      ['采购单','调拨单','退货单','对账单','凭证'].forEach(t => {
        const el = document.getElementById('docflowTab' + t);
        if (el) el.textContent = counts[t];
      });
    }
    function docflowSwitchTab(type) {
      docflowFilter.type = type;
      docflowPage = 1;
      document.querySelectorAll('#docflowTypeTabs .docflow-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('#docflowTypeTabs .docflow-tab[data-type="' + type + '"]')?.classList.add('active');
      renderDocflowList();
    }
    function docflowSwitchRange(range) {
      docflowFilter.range = range;
      docflowPage = 1;
      document.querySelectorAll('#docflowTimeFilter .docflow-time-btn').forEach(t => t.classList.remove('active'));
      document.querySelector('#docflowTimeFilter .docflow-time-btn[data-range="' + range + '"]')?.classList.add('active');
      renderDocflowList();
    }
    function docflowPagePrev() {
      if (docflowPage > 1) { docflowPage--; renderDocflowList(); }
    }
    function docflowPageNext() {
      const allItems = docflowItemsData.filter(i => {
        if (docflowFilter.type !== 'all' && i.type !== docflowFilter.type) return false;
        if (!docflowInRange(i, docflowFilter.range)) return false;
        if (docflowFilter.search) {
          const q = docflowFilter.search.toLowerCase();
          if (!i.docno.toLowerCase().includes(q) && !(i.supplier||'').toLowerCase().includes(q) && !i.desc.toLowerCase().includes(q)) return false;
        }
        return true;
      });
      const totalPages = Math.max(1, Math.ceil(allItems.length / docflowPageSize));
      if (docflowPage < totalPages) { docflowPage++; renderDocflowList(); }
    }
    function docflowOpsClick(docId) {
      const item = docflowItemsData.find(i => i.id === docId);
      if (item && docflowFilter.type !== 'all' && docflowFilter.type !== item.type) {
        docflowSwitchTab(item.type);
      }
      showDocflowDetail(docId);
      setTimeout(() => {
        const itemEl = document.querySelector('#docflowList .docflow-item[data-docid="' + docId + '"]');
        if (itemEl) itemEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        document.querySelectorAll('.docflow-ops-item').forEach(o => o.classList.remove('highlighted'));
        document.querySelector('.docflow-ops-item[data-docid="' + docId + '"]')?.classList.add('highlighted');
        setTimeout(() => document.querySelector('.docflow-ops-item.highlighted')?.classList.remove('highlighted'), 2000);
      }, 50);
    }
    function docflowToggleSelect(id) {
      const cb = document.querySelector('.docflow-item-checkbox[data-docid="' + id + '"]');
      if (cb && cb.checked) docflowSelectedIds.add(id); else docflowSelectedIds.delete(id);
      const bar = document.getElementById('docflowBatchBar');
      const countEl = document.getElementById('docflowBatchCount');
      if (docflowSelectedIds.size > 0) {
        bar.style.display = 'flex';
        if (countEl) countEl.textContent = docflowSelectedIds.size;
      } else bar.style.display = 'none';
    }
    function docflowBatchApprove() {
      showToast('已批量通过 ' + docflowSelectedIds.size + ' 项');
      docflowSelectedIds.clear();
      document.getElementById('docflowBatchBar').style.display = 'none';
      document.querySelectorAll('.docflow-item-checkbox:checked').forEach(cb => cb.checked = false);
    }
    function docflowBatchReject() {
      showToast('已批量驳回 ' + docflowSelectedIds.size + ' 项');
      docflowSelectedIds.clear();
      document.getElementById('docflowBatchBar').style.display = 'none';
      document.querySelectorAll('.docflow-item-checkbox:checked').forEach(cb => cb.checked = false);
    }
    function renderDocflowAlertOps() {
      const card = document.getElementById('docflowAlertOpsCard');
      if (!card) return;
      const alerts = docflowItemsData.filter(i => i.status === 'alert');
      if (alerts.length === 0) {
        card.innerHTML = '<div class="docflow-empty" style="padding:24px 16px;"><span class="docflow-empty-text" style="color:var(--text-muted);font-size:13px;">暂无异常中断</span></div>';
        return;
      }
      card.innerHTML = alerts.map(item => {
        const errNode = item.flow.find(f => f.s === 'error');
        const meta = errNode ? ((errNode.t || '超时') + ' · ' + (item.causeType === 'system' ? '系统问题' : '业务问题')) : '异常';
        const isSystem = item.causeType === 'system';
        const retryState = docflowRetryState[item.id] || 'idle';
        const btnText = isSystem ? (retryState === 'retrying' ? '重试中…' : '查看详情') : '催办';
        const btnCls = isSystem && retryState !== 'retrying' ? 'ops-btn primary' : 'ops-btn';
        const retryTag = isSystem && retryState === 'retrying' ? '<span class="docflow-retry-status retrying" style="font-size:11px;">⏳ 自动重试中</span>' : '';
        return '<div class="docflow-ops-item docflow-ops-item-alert" data-docid="' + item.id + '" onclick="docflowOpsClick(\'' + item.id + '\')">' +
          '<div style="flex:1;min-width:0;">' +
          '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">' +
          '<span class="docflow-ops-label">' + item.docno + ' ' + item.type + '</span>' +
          '<span class="docflow-cause-tag docflow-cause-' + (item.causeType || 'business') + '">' + (isSystem ? '系统问题' : '业务问题') + '</span>' +
          retryTag +
          '</div>' +
          '<span class="docflow-ops-meta docflow-ops-meta-danger">' + meta + '</span>' +
          '</div>' +
          '<button class="' + btnCls + '" onclick="event.stopPropagation(); showDocflowDetail(\'' + item.id + '\')"' + (retryState === 'retrying' ? ' disabled' : '') + '>' + btnText + '</button>' +
          '</div>';
      }).join('');
    }
    function renderDocflowRejectOps() {
      const card = document.getElementById('docflowRejectOpsCard');
      if (!card) return;
      const rejects = docflowItemsData.filter(i => i.status === 'reject');
      if (rejects.length === 0) {
        card.innerHTML = '<div class="docflow-empty" style="padding:24px 16px;"><span class="docflow-empty-text" style="color:var(--text-muted);font-size:13px;">暂无已驳回</span></div>';
        return;
      }
      card.innerHTML = rejects.map(item => {
        const reason = item.rejectReason || '审核不通过';
        return '<div class="docflow-ops-item docflow-ops-item-alert" data-docid="' + item.id + '" onclick="docflowOpsClick(\'' + item.id + '\')">' +
          '<div style="flex:1;min-width:0;">' +
          '<div class="docflow-ops-label">' + item.docno + ' ' + item.type + '</div>' +
          '<span class="docflow-ops-meta docflow-ops-meta-danger">' + reason + '</span>' +
          '</div>' +
          '<button class="ops-btn primary" onclick="event.stopPropagation(); showDocflowDetail(\'' + item.id + '\')">查看详情</button>' +
          '</div>';
      }).join('');
    }
    function initDocflow() {
      if (typeof renderDocflowList === 'function') renderDocflowList();
      if (typeof renderDocflowAlertOps === 'function') renderDocflowAlertOps();
      if (typeof renderDocflowRejectOps === 'function') renderDocflowRejectOps();
      document.querySelectorAll('#docflowTypeTabs .docflow-tab').forEach(t => {
        t.addEventListener('click', () => docflowSwitchTab(t.dataset.type));
      });
      document.querySelectorAll('#docflowTimeFilter .docflow-time-btn').forEach(t => {
        t.addEventListener('click', () => docflowSwitchRange(t.dataset.range));
      });
      const searchEl = document.getElementById('docflowSearch');
      if (searchEl) {
        let timer;
        searchEl.addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            docflowFilter.search = searchEl.value.trim();
            docflowPage = 1;
            renderDocflowList();
          }, 200);
        });
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDocflow);
    } else {
      initDocflow();
    }

    /* AI单据流托管详情：动态生成 */
    const docflowDetailExtra = {
      'purchase-1': { aiBox: 'success', aiText: 'AI 分析：结合供应商渝北鲜品历史履约、商品价格波动、门店库存周转，综合评估风险可控，自动通过。', details: '<li>供应商：渝北鲜品</li><li>商品：小白菜 80kg</li><li>金额：¥420</li><li>预计到货：明日 06:00</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看采购单（ERP）</button>' },
      'purchase-2': { aiBox: 'warn', aiText: 'AI 分析：排骨采购量 45kg 较近 7 日均值偏高约 20%，且金额较大；结合促销档期与库存，建议人工确认采购必要性。', details: '<li>供应商：南坪肉联</li><li>商品：排骨 45kg</li><li>金额：¥1,260</li><li>驳回原因：采购量偏高、建议人工确认</li>', actions: '<button class="btn btn-primary" onclick="closeDataModal(); showToast(\'已通过审核\');">通过</button><button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已驳回\');">驳回</button><button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看采购单（ERP）</button>' },
      'purchase-3': { aiBox: 'success', aiText: 'AI 分析：鸡蛋为高频补货品，供应商江北蛋业履约稳定，金额在合理范围，自动通过。', details: '<li>供应商：江北蛋业</li><li>商品：鸡蛋 50 盒</li><li>金额：¥380</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看采购单（ERP）</button>' },
      'purchase-4': { aiBox: 'success', aiText: 'AI 分析：预制菜为促销备货，永辉供应链合作稳定，金额与档期匹配，自动通过。', details: '<li>供应商：永辉供应链</li><li>商品：预制菜 20 箱</li><li>金额：¥1,680</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看采购单（ERP）</button>' },
      'transfer-1': { aiBox: 'alert', aiText: 'AI 识别异常：仓库确认环节调用 WMS 接口超时 6 小时，判定为系统问题，已触发自动重试。', details: '<li>商品：有机西红柿 15kg</li><li>调出：菜湖店</li><li>调入：南坪店</li><li>卡单时长：6h</li>', actions: '<button class="btn btn-primary" id="docflowRetryBtn" onclick="docflowStartRetry(\'transfer-1\')">立即重试</button><button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看调拨单（ERP）</button><button class="btn btn-ghost" onclick="closeDataModal();">关闭</button>' },
      'transfer-2': { aiBox: 'success', aiText: 'AI 监管：调拨流程各环节按时完成，无异常。', details: '<li>商品：油麦菜 30kg</li><li>调出：南坪店</li><li>调入：菜湖店</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看调拨单（ERP）</button>' },
      'return-1': { aiBox: 'alert', aiText: 'AI 识别异常：供应商未响应超 12 小时，判定为业务问题，需人工催办或联系采购协调。', details: '<li>供应商：渝北鲜品</li><li>商品：西兰花 10kg</li><li>退货原因：品质问题</li><li>卡单时长：12h</li>', actions: '<button class="btn btn-primary" onclick="closeDataModal(); showToast(\'已推送催办\');">催办</button><button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看退货单（ERP）</button>' },
      'return-2': { aiBox: 'success', aiText: 'AI 监管：退货流程已完整走通，供应商确认及时。', details: '<li>供应商：南坪肉联</li><li>商品：排骨 5kg</li><li>退货原因：临期</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看退货单（ERP）</button>' },
      'reconcile-1': { aiBox: 'warn', aiText: 'AI 分析：休库配送单与金蝶金额差 ¥320，可能为运费分摊、损耗计提或科目归属差异，建议核对运费科目及分摊规则。', details: '<li>单据类型：休库配送单</li><li>差异金额：¥320</li><li>待处理：运费分摊核对</li>', actions: '<button class="btn btn-primary" onclick="closeDataModal(); switchScene(\'finance\');">去对账</button><button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转金蝶\');">跳转金蝶对账</button>' },
      'reconcile-2': { aiBox: 'success', aiText: 'AI 监管：对账无差异，已归档。', details: '<li>供应商：渝北鲜品</li><li>对账周期：1 月</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转金蝶\');">跳转金蝶</button>' },
      'voucher-1': { aiBox: 'success', aiText: 'AI 稽核：入库凭证与采购单、物流单一致，无异常。', details: '<li>门店：菜湖店</li><li>日期：1/30</li><li>类型：入库凭证</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转财务系统\');">查看凭证</button>' },
      'purchase-5': { aiBox: 'reject', aiText: 'AI 驳回：新供应商资质未通过审核，缺少食品经营许可证及质检报告，建议补充资质后再提交。', details: '<li>供应商：新供应商</li><li>商品：有机蔬菜 50kg</li><li>金额：¥2,800</li><li>驳回原因：供应商资质未通过审核</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看采购单（ERP）</button>' },
      'purchase-6': { aiBox: 'reject', aiText: 'AI 驳回：进口牛油果单价 ¥18.90/个，较近 7 日市调均价偏高约 15%，建议重新询价或说明溢价理由。', details: '<li>供应商：渝北鲜品</li><li>商品：进口牛油果 100 个</li><li>金额：¥1,890</li><li>驳回原因：单价较市价偏高 15%，建议重新询价</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看采购单（ERP）</button>' },
      'transfer-3': { aiBox: 'reject', aiText: 'AI 驳回：调出店（南坪）草莓库存仅 12kg，无法满足 20kg 调拨量，建议调整调拨数量或选择其他门店。', details: '<li>商品：草莓 20kg</li><li>调出：南坪店</li><li>调入：菜湖店</li><li>驳回原因：调出店库存不足，无法满足调拨量</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看调拨单（ERP）</button>' },
      'return-3': { aiBox: 'reject', aiText: 'AI 驳回：退货理由「临期」不充分，商品临期日期距今日超过 7 天，不符合退货政策。建议补充具体品质问题说明。', details: '<li>供应商：南坪肉联</li><li>商品：排骨 8kg</li><li>退货原因：临期</li><li>驳回原因：退货理由不充分，临期日期距今日超过 7 天</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看退货单（ERP）</button>' },
      'voucher-2': { aiBox: 'reject', aiText: 'AI 驳回：凭证金额 ¥1,680 与采购单 CG-20260125-033 金额 ¥1,800 不一致，差额 ¥120，请核对后修正。', details: '<li>门店：南坪店</li><li>日期：1/26</li><li>类型：入库凭证</li><li>驳回原因：凭证金额与采购单 CG-20260125-033 不一致，差 ¥120</li>', actions: '<button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转财务系统\');">查看凭证</button>' }
    };
    function buildDocflowFlowchart(flow) {
      let html = '<div class="docflow-flowchart">';
      flow.forEach((f, i) => {
        const cls = f.s === 'done' ? 'done' : f.s === 'current' ? 'current' : f.s === 'error' ? 'error' : 'pending';
        const time = f.t || '';
        html += '<div class="docflow-flowchart-node"><div class="docflow-flowchart-node-box ' + cls + '">' + f.n + '</div><div class="docflow-flowchart-node-time">' + time + '</div></div>';
        if (i < flow.length - 1) {
          const connCls = f.s === 'error' ? 'error' : f.s === 'done' ? 'done' : '';
          html += '<div class="docflow-flowchart-connector ' + connCls + '"></div>';
        }
      });
      return html + '</div>';
    }
    function showDocflowDetail(id) {
      const item = docflowItemsData.find(i => i.id === id);
      if (!item) return;
      const extra = docflowDetailExtra[id] || { aiBox: 'success', aiText: '', details: '', actions: '' };
      const statusLabel = item.status === 'ok' ? 'AI 自动通过' : item.status === 'warn' ? '待人工' : item.status === 'reject' ? '已驳回' : '异常中断';
      const title = item.type + ' ' + item.docno + ' · ' + statusLabel;
      const aiBoxCls = (extra.aiBox === 'alert' || extra.aiBox === 'reject') ? 'report-box ' + (extra.aiBox || 'alert') : 'report-box ' + extra.aiBox;
      const aiBoxSty = (extra.aiBox === 'alert' || extra.aiBox === 'reject') ? 'margin-bottom: 16px; background: rgba(255,107,107,0.1); border-color: rgba(255,107,107,0.3);' : 'margin-bottom: 16px;';
      let actions = extra.actions;
      if (item.status === 'alert' && item.causeType === 'system' && (docflowRetryState[id] === 'retrying')) {
        actions = '<button class="btn btn-ghost" disabled>重试中…</button><button class="btn btn-ghost" onclick="closeDataModal(); showToast(\'已跳转 ERP\');">查看调拨单（ERP）</button><button class="btn btn-ghost" onclick="closeDataModal();">关闭</button>';
      }
      let causeBlock = '';
      if (item.status === 'alert' && (item.causeType || item.causeText)) {
        const causeType = item.causeType || 'business';
        const causeText = item.causeText || '异常中断，需人工处理';
        const isSystem = causeType === 'system';
        const retryState = docflowRetryState[id] || 'idle';
        const retryHtml = isSystem ? (retryState === 'retrying'
          ? '<div class="docflow-retry-status retrying">⏳ 系统正在自动重试中…</div>'
          : retryState === 'success'
            ? '<div class="docflow-retry-status" style="color: var(--success);">✓ 重试成功，流程已恢复</div>'
            : '<div class="docflow-retry-status">系统已识别为可自动重试，点击「立即重试」或等待后台自动重试</div>') : '';
        causeBlock = `
        <div class="report-daily-section">
          <div class="report-section-title">原因分析</div>
          <div class="docflow-cause-box">
            <div class="cause-type-row">
              <span class="docflow-cause-tag docflow-cause-${causeType}">${isSystem ? '系统问题' : '业务问题'}</span>
            </div>
            <div class="cause-text">${causeText}</div>
            ${retryHtml}
          </div>
        </div>`;
      }
      const html = `
        <div class="${aiBoxCls}" style="${aiBoxSty}">${extra.aiText}</div>
        ${causeBlock}
        <div class="report-daily-section">
          <div class="report-section-title">单据流程路径</div>
          ${buildDocflowFlowchart(item.flow)}
        </div>
        <div class="report-daily-section">
          <div class="report-section-title">单据明细</div>
          <div class="report-list">${extra.details}</div>
        </div>
        <div class="docflow-detail-actions" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
          ${actions}
        </div>
      `;
      showDataModal(title, html);
    }
    function docflowStartRetry(id) {
      const item = docflowItemsData.find(i => i.id === id);
      if (!item || item.causeType !== 'system') return;
      docflowRetryState[id] = 'retrying';
      showDocflowDetail(id);
      setTimeout(() => {
        docflowRetryState[id] = 'success';
        const errIdx = item.flow.findIndex(f => f.s === 'error');
        if (errIdx >= 0) {
          item.flow[errIdx] = { ...item.flow[errIdx], s: 'done', t: new Date().toTimeString().slice(0, 5) };
          if (errIdx + 1 < item.flow.length) item.flow[errIdx + 1] = { ...item.flow[errIdx + 1], s: 'current', t: '-' };
        }
        item.status = 'warn';
        item.causeType = undefined;
        item.causeText = undefined;
        closeDataModal();
        renderDocflowList();
        renderDocflowAlertOps();
        showToast('重试成功，流程已恢复');
      }, 2200);
    }
    function showDocflowConfigModal() {
      const html = `
        <div class="config-modal-desc">配置各单据类型的 AI 审核规则、驳回推送对象、超时升级规则。AI 结合实际场景分析评估风险，决定是否自动审核。</div>
        <div class="config-modal-section">
          <div class="config-modal-title">采购单</div>
          <div class="config-modal-note">AI 结合供应商履约、采购量、金额、库存等综合评估，审核不通过时推送以下对象。</div>
          <div class="config-modal-rows">
            <div class="config-row"><span class="config-label">驳回推送对象</span><input class="config-input config-input-full" type="text" value="店长、采购" placeholder="逗号分隔"></div>
          </div>
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">调拨单</div>
          <div class="config-modal-note">仓库确认环节超时后自动升级为异常，推送催办。</div>
          <div class="config-modal-rows">
            <div class="config-row"><span class="config-label">确认超时</span><input class="config-input config-input-sm" type="text" value="4"><span class="config-unit">小时</span></div>
          </div>
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">退货单</div>
          <div class="config-modal-note">供应商确认超时后自动升级为异常，推送催办。</div>
          <div class="config-modal-rows">
            <div class="config-row"><span class="config-label">确认超时</span><input class="config-input config-input-sm" type="text" value="12"><span class="config-unit">小时</span></div>
          </div>
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">对账单</div>
          <div class="config-modal-note">对账差异超阈值时推送财务处理。</div>
          <div class="config-modal-rows">
            <div class="config-row"><span class="config-label">差异推送对象</span><input class="config-input config-input-full" type="text" value="财务、运营" placeholder="逗号分隔"></div>
          </div>
        </div>
        <div class="config-modal-actions">
          <button class="btn btn-primary" onclick="closeDataModal(); showToast('单据审核规则已保存');">保存配置</button>
          <button class="btn btn-ghost" onclick="docflowConfigRestoreDefault();">恢复默认</button>
          <button class="btn btn-ghost" onclick="closeDataModal();">取消</button>
        </div>
      `;
      showDataModal('配置单据审核规则', html);
    }
    function docflowConfigRestoreDefault() {
      showToast('已恢复默认配置');
    }

    /* AI物流调度：确认/驳回/配置/导出/通知 */
    function logisticsDispatchConfirm(allocId) {
      showToast('已确认调配指令');
      document.querySelectorAll(`[data-alloc-id="${allocId}"]`).forEach(el => el.closest('.docflow-ops-item')?.remove());
      const statEl = document.getElementById('logisticsDispatchStatPending');
      if (statEl) statEl.textContent = Math.max(0, parseInt(statEl.textContent || '0') - 1);
    }
    function logisticsDispatchReject(allocId) {
      showToast('已驳回调配指令');
      document.querySelectorAll(`[data-alloc-id="${allocId}"]`).forEach(el => el.closest('.docflow-ops-item')?.remove());
      const statEl = document.getElementById('logisticsDispatchStatPending');
      if (statEl) statEl.textContent = Math.max(0, parseInt(statEl.textContent || '0') - 1);
    }
    function showLogisticsDispatchConfigModal() {
      const html = `
        <div class="config-modal-desc">配置运力监控规则、作业量阈值、资源调配触发条件、路线优化偏好。AI 结合上游单据、到仓时间、货物量综合评估，自动生成调配建议与路线方案。</div>
        <div class="config-modal-section">
          <div class="config-modal-title">作业量阈值</div>
          <div class="config-modal-note">当预估作业量较昨日增幅超过阈值时，触发人力/运力调配建议。</div>
          <input type="number" class="config-modal-input" value="10" min="5" max="30"> %
        </div>
        <div class="config-modal-section">
          <div class="config-modal-title">路线优化偏好</div>
          <div class="config-modal-note">成本优先 / 时效优先 / 均衡</div>
          <select class="config-modal-input"><option>成本优先</option><option>时效优先</option><option>均衡</option></select>
        </div>
        <div class="config-modal-actions">
          <button class="ops-btn" onclick="closeDataModal(); showToast('已恢复默认')">恢复默认</button>
          <button class="ops-btn primary" onclick="closeDataModal(); showToast('配置已保存')">保存</button>
        </div>
      `;
      showDataModal('配置调度规则', html);
    }
    function logisticsDispatchExport() {
      showDataModal('导出成功', '<div class="report-box success"><strong>已导出至：</strong>运力调配_20260130.xlsx</div><p style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">包含全国各仓人力运力调配建议、车次路线、装载方案等。</p>');
    }
    function logisticsDispatchSendNotice() {
      showToast('调度通知已发送至相关仓管与司机');
    }

    /* 一键确认订单：确认后更新待办数量 */
    function quickConfirmOrders() {
      const el = document.getElementById('pendingOrderCount');
      const pendingWrap = el?.closest('.dashboard-pending');
      if (el && el.textContent === '23') {
        el.textContent = '0';
        if (pendingWrap) {
          pendingWrap.style.opacity = '0.6';
          pendingWrap.querySelector('.pending-text').innerHTML = '采购订单 <strong>0</strong> 单（已全部确认）';
          pendingWrap.querySelector('.pending-action').textContent = '查看订单 →';
        }
        showToast('已确认 23 单采购订单，预计明日 06:00 前到货');
      } else {
        showToast('订单已全部确认');
      }
    }

    /* 创建新对话 */
    function createNewChat() {
      switchScene('new-chat');
    }
    /* 删除历史对话 */
    function deleteHistoryItem(scene) {
      const el = document.querySelector('.history-item[data-scene="' + scene + '"]');
      if (!el) return;
      const isActive = el.classList.contains('active');
      el.remove();
      if (isActive) {
        const first = document.querySelector('.history-item[data-scene]');
        if (first) switchScene(first.dataset.scene);
        else switchScene('new-chat');
      }
      showToast('已删除对话');
    }

    /* 市调数据选择弹窗 */
    function showMarketSelectModal() {
      document.getElementById('marketSelectModal').classList.add('active');
    }
    function closeMarketSelectModal() {
      document.getElementById('marketSelectModal').classList.remove('active');
    }

    /* 商品引入进度弹窗 */
    let _productIntroduceTimer = null;
    let _productIntroduceResolve = null;
    function showProductIntroduceModal(productName, price, canIntroduce) {
      document.getElementById('productIntroduceName').textContent = productName;
      document.getElementById('productIntroduceInfo').innerHTML = '商品：<strong>' + productName + '</strong> · 定价建议：' + price;
      document.getElementById('productIntroduceSpecInput').style.display = 'none';
      document.getElementById('productIntroduceSpecValue').value = '';
      document.querySelectorAll('.introduce-step').forEach(el => {
        el.classList.remove('running', 'done', 'fail');
        el.querySelector('.introduce-step-icon').textContent = '○';
        el.querySelector('.introduce-step-status').textContent = '';
      });
      document.getElementById('productIntroduceModal').classList.add('active');
      if (_productIntroduceTimer) clearTimeout(_productIntroduceTimer);
      runProductIntroduceSteps(productName, canIntroduce);
    }
    function closeProductIntroduceModal() {
      document.getElementById('productIntroduceModal').classList.remove('active');
      if (_productIntroduceTimer) clearTimeout(_productIntroduceTimer);
    }
    function runProductIntroduceSteps(productName, canIntroduce) {
      const steps = document.querySelectorAll('.introduce-step');
      const needSpecConfirm = ['预制红烧肉', '鲜切菠萝', '酸奶组合装'].indexOf(productName) >= 0;
      let currentStep = 0;
      function setStepState(idx, state, statusText) {
        const el = steps[idx];
        if (!el) return;
        el.classList.remove('running', 'done', 'fail');
        el.classList.add(state);
        const icon = el.querySelector('.introduce-step-icon');
        if (icon) icon.textContent = state === 'done' ? '✓' : (state === 'fail' ? '×' : '○');
        const status = el.querySelector('.introduce-step-status');
        if (status) status.textContent = statusText || '';
      }
      function nextStep() {
        if (currentStep >= steps.length) return;
        setStepState(currentStep, 'running', '进行中…');
        const step = currentStep;
        if (step === 0) {
          if (!canIntroduce) {
            _productIntroduceTimer = setTimeout(() => {
              setStepState(0, 'fail', '校验失败：主数据不建议引入');
              steps[0].querySelector('.introduce-step-icon').textContent = '×';
              showToast('数据校验未通过');
            }, 800);
            return;
          }
          _productIntroduceTimer = setTimeout(() => {
            setStepState(0, 'done', '主数据完整，未引入过');
            currentStep = 1;
            nextStep();
          }, 800);
        } else if (step === 1) {
          _productIntroduceTimer = setTimeout(() => {
            setStepState(1, 'done', '已创建');
            currentStep = 2;
            nextStep();
          }, 800);
        } else if (step === 2) {
          _productIntroduceTimer = setTimeout(() => {
            setStepState(2, 'done', '已上传');
            currentStep = 3;
            nextStep();
          }, 800);
        } else if (step === 3) {
          _productIntroduceTimer = setTimeout(() => {
            setStepState(3, 'done', '已调整');
            currentStep = 4;
            nextStep();
          }, 800);
        } else if (step === 4) {
          if (needSpecConfirm) {
            setStepState(4, 'running', '待确认');
            document.getElementById('productIntroduceSpecInput').style.display = 'flex';
            document.getElementById('productIntroduceSpecValue').focus();
            _productIntroduceResolve = () => {
              const val = document.getElementById('productIntroduceSpecValue').value.trim();
              document.getElementById('productIntroduceSpecInput').style.display = 'none';
              setStepState(4, 'done', val || '已确认');
              currentStep = 5;
              nextStep();
            };
          } else {
            _productIntroduceTimer = setTimeout(() => {
              setStepState(4, 'done', '已设置');
              currentStep = 5;
              nextStep();
            }, 800);
          }
        } else if (step === 5) {
          _productIntroduceTimer = setTimeout(() => {
            setStepState(5, 'done', '已分档');
            currentStep = 6;
            nextStep();
          }, 800);
        } else if (step === 6) {
          _productIntroduceTimer = setTimeout(() => {
            setStepState(6, 'done', '完成');
            showToast(productName + ' 引入成功');
          }, 600);
        }
      }
      nextStep();
    }
    function confirmProductIntroduceSpec() {
      if (_productIntroduceResolve) {
        _productIntroduceResolve();
        _productIntroduceResolve = null;
      }
    }
    function confirmMarketSelect() {
      const checked = document.querySelector('#marketSelectTable input[name="marketSelect"]:checked');
      const input = document.getElementById('marketSelectInput');
      if (checked && input) {
        const row = checked.closest('tr');
        const date = row.dataset.date;
        const store = row.dataset.store;
        const count = row.dataset.count;
        const competitor = row.dataset.competitor;
        input.value = date + ' · ' + store + ' · ' + count + ' 商品 · 竞品 ' + competitor;
        showToast('已加载市调数据');
      } else {
        showToast('请先选择一条市调记录', 'loading');
      }
      closeMarketSelectModal();
    }
    document.getElementById('marketSelectModal')?.addEventListener('click', e => {
      if (e.target.id === 'marketSelectModal') closeMarketSelectModal();
    });
    document.getElementById('productIntroduceModal')?.addEventListener('click', e => {
      if (e.target.id === 'productIntroduceModal') closeProductIntroduceModal();
    });
    document.querySelectorAll('.market-select-row').forEach(row => {
      row.addEventListener('click', () => {
        const radio = row.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;
      });
    });

    /* AI 引入决策建议：导出下拉 */
    function toggleExportDropdown(id) {
      document.querySelectorAll('.export-dropdown').forEach(el => {
        if (el.id !== id) el.classList.remove('open');
      });
      document.getElementById(id)?.classList.toggle('open');
    }
    function closeExportDropdowns() {
      document.querySelectorAll('.export-dropdown').forEach(el => el.classList.remove('open'));
    }
    document.addEventListener('click', e => {
      if (!e.target.closest('.export-dropdown')) closeExportDropdowns();
    });
    function exportAiDecision(format) {
      closeExportDropdowns();
      const fileName = 'AI引入决策建议_' + new Date().toISOString().slice(0,10) + '.' + (format === 'excel' ? 'xlsx' : 'pdf');
      showDataModal('导出成功', `
        <div class="report-box success" style="margin-bottom: 16px;">
          已导出至：<strong>${fileName}</strong>
        </div>
        <p style="color: var(--text-secondary);">共 14 条 AI 引入决策建议，包含商品、是否引入、定价建议、采购量建议、决策原因。</p>
      `);
    }

    /* 合同智检：模版选择、导出、优化 */
    /* 门店流程智管：AI 填充、闭店确认等 */
    function submitOpeningFlow() {
      const openingProgressHtml = `
        <div class="storeflow-progress-modal">
          <div class="storeflow-progress-header">
            <span class="storeflow-progress-badge">AI 自动执行中</span>
            <span class="storeflow-progress-hint">以下配置由 AI 后台自动处理</span>
          </div>
          <div class="storeflow-progress-list">
            <div class="storeflow-progress-item done"><span class="storeflow-progress-icon">✓</span><span class="storeflow-progress-name">配置门店收银信息</span><span class="storeflow-progress-status">已完成</span></div>
            <div class="storeflow-progress-item running"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">商品分档到门店</span><span class="storeflow-progress-status">进行中</span></div>
            <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">生成商品配送到店配送单</span><span class="storeflow-progress-status">待执行</span></div>
            <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">开通店长相关权限</span><span class="storeflow-progress-status">待执行</span></div>
            <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">配置供应相关路由</span><span class="storeflow-progress-status">待执行</span></div>
            <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">门店店仓系统初始化</span><span class="storeflow-progress-status">待执行</span></div>
          </div>
          <div class="storeflow-progress-footer">
            <p>AI 正在后台自动执行</p>
            <button class="btn btn-primary" onclick="closeDataModal()">知道了</button>
          </div>
        </div>
      `;
      showDataModal('开业申请 · AI 自动处理计划与进度', openingProgressHtml);
    }
    function storeflowAutoFill(type) {
      if (type === 'opening') {
        showToast('AI 正在从合同/加盟商档案自动填充表单…');
        setTimeout(() => showToast('已自动填充基本信息、运营信息、公司信息、收款账号、固定费用', 'success'), 800);
      }
    }
    function showStoreflowStoreSelect() {
      showToast('选择门店（原型演示）');
    }
    function showStoreflowConvertStoreSelect() {
      showToast('选择待转自营门店（原型演示）');
    }
    function submitConvertFlow() {
      const convertProgressHtml = `
        <div class="storeflow-progress-modal">
          <div class="storeflow-progress-header">
            <span class="storeflow-progress-badge">AI 自动执行中</span>
            <span class="storeflow-progress-hint">自营转加盟 · 三步由 AI 按序自动编排</span>
          </div>
          <div class="storeflow-progress-list">
            <div class="storeflow-progress-group">
              <div class="storeflow-progress-item done"><span class="storeflow-progress-icon">✓</span><span class="storeflow-progress-name">一、新加盟门店开业</span><span class="storeflow-progress-status">已完成</span></div>
              <div class="storeflow-progress-substeps">
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>收银配置</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>商品分档</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>配送单</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>权限</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>路由</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>店仓初始化</div>
              </div>
            </div>
            <div class="storeflow-progress-group">
              <div class="storeflow-progress-item running"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">二、原自营门店闭店</span><span class="storeflow-progress-status">进行中</span></div>
              <div class="storeflow-progress-substeps">
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>在途采购/批发/调拨单</div>
                <div class="storeflow-progress-subitem running"><span class="storeflow-progress-subicon">○</span>WMS/财务库存清零</div>
                <div class="storeflow-progress-subitem manual"><span class="storeflow-progress-subicon">!</span>归还现金（需人工）</div>
                <div class="storeflow-progress-subitem"><span class="storeflow-progress-subicon">○</span>加盟账户</div>
                <div class="storeflow-progress-subitem"><span class="storeflow-progress-subicon">○</span>供应商结款</div>
                <div class="storeflow-progress-subitem"><span class="storeflow-progress-subicon">○</span>关闭人员权限</div>
              </div>
            </div>
            <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">三、夏谷系统 · 人员部门切换</span><span class="storeflow-progress-status">待执行</span></div>
          </div>
          <div class="storeflow-progress-footer">
            <p>AI 正在按序执行：新店开业 → 老店闭店 → 夏谷人员部门切换</p>
            <button class="btn btn-primary" onclick="closeDataModal()">知道了</button>
          </div>
        </div>
      `;
      showDataModal('自营转加盟 · AI 自动处理计划与进度', convertProgressHtml);
    }
    function toggleClosingConfirm(checkbox, item) {
      const submitBtn = document.getElementById('storeflowClosingSubmit');
      if (submitBtn) submitBtn.disabled = !checkbox.checked;
    }
    function submitClosingFlow() {
      const closingProgressHtml = `
        <div class="storeflow-progress-modal">
          <div class="storeflow-progress-header">
            <span class="storeflow-progress-badge">AI 自动执行中</span>
            <span class="storeflow-progress-hint">闭店 · 五步由 AI 按序自动编排，1 项需人工确认</span>
          </div>
          <div class="storeflow-progress-list">
            <div class="storeflow-progress-group">
              <div class="storeflow-progress-item done"><span class="storeflow-progress-icon">✓</span><span class="storeflow-progress-name">一、在途单据检测</span><span class="storeflow-progress-status">已完成</span></div>
              <div class="storeflow-progress-substeps">
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>采购单</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>批发单</div>
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>调拨单</div>
              </div>
            </div>
            <div class="storeflow-progress-group">
              <div class="storeflow-progress-item running"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">二、库存清零</span><span class="storeflow-progress-status">进行中</span></div>
              <div class="storeflow-progress-substeps">
                <div class="storeflow-progress-subitem done"><span class="storeflow-progress-subicon">✓</span>WMS 库存</div>
                <div class="storeflow-progress-subitem running"><span class="storeflow-progress-subicon">○</span>财务库存</div>
              </div>
            </div>
            <div class="storeflow-progress-group">
              <div class="storeflow-progress-item manual"><span class="storeflow-progress-icon">!</span><span class="storeflow-progress-name">三、归还现金款和备用金</span><span class="storeflow-progress-status">需人工确认</span></div>
            </div>
            <div class="storeflow-progress-group">
              <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">四、加盟与供应商</span><span class="storeflow-progress-status">待执行</span></div>
              <div class="storeflow-progress-substeps">
                <div class="storeflow-progress-subitem"><span class="storeflow-progress-subicon">○</span>加盟账户余额</div>
                <div class="storeflow-progress-subitem"><span class="storeflow-progress-subicon">○</span>供应商单据已结款</div>
              </div>
            </div>
            <div class="storeflow-progress-item"><span class="storeflow-progress-icon">○</span><span class="storeflow-progress-name">五、关闭相关人员权限</span><span class="storeflow-progress-status">待执行</span></div>
          </div>
          <div class="storeflow-progress-footer">
            <p>AI 正在按序执行，需人工项请线下确认后勾选</p>
            <button class="btn btn-primary" onclick="closeDataModal()">知道了</button>
          </div>
        </div>
      `;
      showDataModal('闭店申请 · AI 自动处理计划与进度', closingProgressHtml);
    }
    function storeflowRunAllChecks() {
      showToast('正在重新检测 8 项…');
      setTimeout(() => showToast('检测完成，7 项通过，1 项需人工确认', 'success'), 1200);
    }

    function showContractTemplateModal() {
      document.getElementById('contractTemplateModal').classList.add('active');
    }
    function closeContractTemplateModal() {
      document.getElementById('contractTemplateModal').classList.remove('active');
    }
    function confirmContractTemplateSelect() {
      const checked = document.querySelector('#contractTemplateTable input[name="contractTemplate"]:checked');
      const row = checked?.closest('.contract-template-row');
      if (row) {
        const name = row.dataset.name;
        document.getElementById('contractTemplateInput').value = name;
        closeContractTemplateModal();
        showToast('已选择：' + name);
      } else {
        showToast('请先选择合同模版', 'loading');
      }
    }
    document.getElementById('contractTemplateModal')?.addEventListener('click', e => {
      if (e.target.id === 'contractTemplateModal') closeContractTemplateModal();
    });
    document.getElementById('contractOptimizeModal')?.addEventListener('click', e => {
      if (e.target.id === 'contractOptimizeModal') closeContractOptimizeModal();
    });
    document.querySelectorAll('.contract-annot').forEach(annot => {
      annot.addEventListener('click', () => {
        const num = annot.dataset.rev;
        const revItem = document.querySelector('.contract-revision-item[data-rev="' + num + '"]');
        if (revItem) {
          document.querySelectorAll('.contract-revision-item.highlight').forEach(el => el.classList.remove('highlight'));
          revItem.classList.add('highlight');
          revItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    });
    const contractRiskData = {
      '采购主合同': [
        { pos: '第 7.2 条', level: 'high', type: '违约金', orig: '违约金 30%', desc: '违约金比例 30% 过高，超出法定上限', sugg: '建议调整为日万分之五或年 24% 以内' },
        { pos: '第 9.3 条', level: 'high', type: '争议解决', orig: '仲裁（未明确机构）', desc: '约定仲裁但未明确仲裁机构', sugg: '补充具体仲裁机构名称，如「重庆仲裁委员会」' },
        { pos: '第 5.1 条', level: 'high', type: '付款条款', orig: '账期 90 日', desc: '账期 90 天对供应商资金压力大', sugg: '建议缩短至 60 天或增加提前付款折扣条款' },
        { pos: '第 4.2 条', level: 'mid', type: '质量异议', orig: '异议期 3 天', desc: '异议期 3 天过短，生鲜品类易引发纠纷', sugg: '建议延长至 7 天，并明确书面异议形式' },
        { pos: '第 6.1 条', level: 'mid', type: '权利义务', orig: '「质量问题」未定义', desc: '退换货条件表述模糊，「质量问题」未定义', sugg: '补充质量问题的具体认定标准或引用国标' },
        { pos: '第 8.1 条', level: 'mid', type: '保密条款', orig: '保密期 2 年', desc: '保密期限「合同终止后 2 年」可能不足', sugg: '可考虑延长至 5 年或约定「合理必要期限」' },
        { pos: '第 3.2 条', level: 'low', type: '格式规范', orig: '条款编号引用不一致', desc: '条款编号与引用存在不一致', sugg: '统一编号格式，修正交叉引用' }
      ],
      '生鲜补充协议': [
        { pos: '第 2.1 条', level: 'high', type: '损耗责任', orig: '损耗责任未明确', desc: '损耗责任未明确划分，生鲜品类易产生争议', sugg: '补充损耗比例及责任承担方式' },
        { pos: '第 2.3 条', level: 'mid', type: '保质期', orig: '保质期「按国标」笼统', desc: '保质期表述「按国标」过于笼统', sugg: '明确具体保质期要求或引用 GB 标准条款' }
      ],
      '快消补充协议': [
        { pos: '第 1.2 条', level: 'mid', type: '临期处理', orig: '临期处理未约定', desc: '临期商品处理方式未约定', sugg: '补充临期 90/60/30 天不同处理方式及折扣比例' }
      ],
      '加盟合同': [
        { pos: '第 5.2 条', level: 'high', type: '保证金', orig: '保证金退还条件模糊', desc: '保证金退还条件表述模糊', sugg: '明确退还条件、时限及扣除情形' }
      ],
      '商品联营合同': []
    };
    function buildContractRevisionHtml(risks, revBaseIndex) {
      if (!risks || risks.length === 0) return '<div class="contract-revision-title">暂无修正项</div>';
      let html = '<div class="contract-revision-title">修订说明（共 ' + risks.length + ' 处）</div>';
      risks.forEach((r, i) => {
        const revNum = revBaseIndex !== undefined ? (revBaseIndex + i + 1) : (i + 1);
        const riskClass = r.level === 'high' ? ' risk-high' : (r.level === 'mid' ? '' : '');
        const levelText = r.level === 'high' ? '高风险' : (r.level === 'mid' ? '中风险' : '低风险');
        html += '<div class="contract-revision-item' + riskClass + '" data-rev="' + revNum + '" onclick="scrollToContractRev(' + revNum + ')">';
        html += '<div class="contract-revision-num">[' + (i + 1) + '] ' + r.pos + ' · ' + levelText + '</div>';
        html += '<div class="contract-revision-orig">' + r.orig + '</div>';
        html += '<div class="contract-revision-sugg">→ ' + r.sugg + '</div>';
        html += '</div>';
      });
      return html;
    }
    function filterContractRisksByTemplate(value) {
      const allEl = document.getElementById('contractRiskAll');
      const singleEl = document.getElementById('contractRiskSingle');
      const headerEl = document.getElementById('contractRiskSingleHeader');
      const bodyEl = document.getElementById('contractRiskSingleBody');
      if (value === 'all') {
        allEl.style.display = '';
        singleEl.style.display = 'none';
      } else {
        allEl.style.display = 'none';
        singleEl.style.display = 'block';
        const risks = contractRiskData[value] || [];
        headerEl.textContent = value + '（' + risks.length + ' 条修正）';
        if (risks.length === 0) {
          bodyEl.innerHTML = '<p class="contract-risk-empty">该模版暂无风险修正项</p>';
        } else {
          let html = '<table class="data-table data-table-actions"><tr><th>条款位置</th><th>风险等级</th><th>风险类型</th><th>风险描述</th><th>建议修改</th><th>操作</th></tr>';
          risks.forEach((r, idx) => {
            const badge = r.level === 'high' ? 'risk-high' : (r.level === 'mid' ? 'risk-mid' : 'risk-low');
            const levelText = r.level === 'high' ? '高' : (r.level === 'mid' ? '中' : '低');
            html += '<tr><td>' + r.pos + '</td><td><span class="risk-badge ' + badge + '">' + levelText + '</span></td><td>' + r.type + '</td><td>' + r.desc + '</td><td>' + r.sugg + '</td><td><button class="btn-link" onclick="openContractOptimizeModal(\'' + value + '\', ' + idx + ')">修正</button> <button class="btn-link" onclick="showToast(\'已标记为不予修改\')">不予修改</button></td></tr>';
          });
          html += '</table>';
          bodyEl.innerHTML = html;
        }
      }
    }
    document.querySelectorAll('.contract-template-row').forEach(row => {
      row.addEventListener('click', () => {
        const radio = row.querySelector('input[name="contractTemplate"]');
        if (radio) radio.checked = true;
      });
    });
    let _contractDocMainHtml = (function() {
      const el = document.getElementById('contractDocContent');
      return el ? el.innerHTML : '';
    })();
    function openContractOptimizeModal(templateName, singleRevisionIndex) {
      const name = templateName || document.getElementById('contractTemplateInput')?.value || '';
      const finalName = (name === '从系统选择合同模版' || !name) ? '采购主合同' : name;
      document.querySelector('#contractOptimizeModal .contract-optimize-header h3').textContent = '合同优化稿预览 · ' + finalName;
      const risks = contractRiskData[finalName] || [];
      let displayRisks = risks;
      if (singleRevisionIndex !== undefined && singleRevisionIndex >= 0 && risks[singleRevisionIndex]) {
        displayRisks = [risks[singleRevisionIndex]];
      }
      const sidebar = document.getElementById('contractRevisionSidebar');
      if (sidebar) sidebar.innerHTML = buildContractRevisionHtml(displayRisks, singleRevisionIndex);
      const docContent = document.getElementById('contractDocContent');
      if (docContent) {
        if (finalName === '采购主合同') {
          if (!_contractDocMainHtml) _contractDocMainHtml = docContent.innerHTML;
          docContent.innerHTML = _contractDocMainHtml;
          docContent.querySelectorAll('.contract-annot').forEach(a => {
            const revNum = parseInt(a.dataset.rev, 10);
            const show = singleRevisionIndex === undefined || revNum === singleRevisionIndex + 1;
            a.style.display = show ? '' : 'none';
          });
        } else {
          docContent.innerHTML = '<h4>' + finalName + '</h4><p style="color:var(--text-secondary); margin-bottom:16px;">合同正文（节选）</p><div class="contract-revision-mini-list">' + displayRisks.map(r => '<div class="contract-clause"><strong>' + r.pos + ' ' + r.type + '</strong><p>' + r.desc + '</p><p style="color:var(--accent);">建议：' + r.sugg + '</p></div>').join('') + '</div>';
        }
      }
      document.getElementById('contractOptimizeModal').classList.add('active');
      document.querySelectorAll('.contract-revision-item.highlight').forEach(el => el.classList.remove('highlight'));
    }
    function contractOptimize() {
      const input = document.getElementById('contractOptimizeInput');
      const text = input?.value?.trim();
      let templateName = document.getElementById('contractTemplateInput')?.value || '';
      openContractOptimizeModal(templateName);
      if (text) input.value = '';
    }
    function closeContractOptimizeModal() {
      document.getElementById('contractOptimizeModal').classList.remove('active');
    }
    function scrollToContractRev(num) {
      const annot = document.querySelector('.contract-annot[data-rev="' + num + '"]');
      const revItem = document.querySelector('.contract-revision-item[data-rev="' + num + '"]');
      if (annot) {
        annot.scrollIntoView({ behavior: 'smooth', block: 'center' });
        annot.style.animation = 'none';
        annot.offsetHeight;
        annot.style.animation = 'contract-annot-pulse 0.6s ease';
      }
      document.querySelectorAll('.contract-revision-item.highlight').forEach(el => el.classList.remove('highlight'));
      if (revItem) revItem.classList.add('highlight');
    }
    function exportContractOptimize(format) {
      const templateName = document.querySelector('#contractOptimizeModal .contract-optimize-header h3')?.textContent?.replace('合同优化稿预览 · ', '') || '采购主合同';
      const ext = format === 'word' ? 'docx' : 'pdf';
      showDataModal('导出成功', `
        <div class="report-box success" style="margin-bottom: 16px;">
          已导出至：<strong>${templateName}_优化稿_${new Date().toISOString().slice(0,10)}.${ext}</strong>
        </div>
        <p style="color: var(--text-secondary);">合同内容已包含 7 处修订批注，可在 Word 中查看修订建议。</p>
      `);
    }
    document.getElementById('reportModal')?.addEventListener('click', e => {
      if (e.target === e.currentTarget) closeReport();
      if (!e.target.closest('#reportExportDropdown')) document.getElementById('reportExportDropdown')?.classList.remove('open');
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (document.getElementById('reportModal').classList.contains('active')) closeReport();
        if (document.getElementById('marketSelectModal').classList.contains('active')) closeMarketSelectModal();
        if (document.getElementById('contractTemplateModal').classList.contains('active')) closeContractTemplateModal();
        if (document.getElementById('contractOptimizeModal').classList.contains('active')) closeContractOptimizeModal();
        if (document.getElementById('productIntroduceModal').classList.contains('active')) closeProductIntroduceModal();
      }
    });

    document.getElementById('aiInput')?.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendToAI();
    });

    /* 对话区输入框 Enter 发送 */
    document.addEventListener('keydown', e => {
      const input = e.target.closest('.chat-input-bar input');
      if (!input || e.key !== 'Enter') return;
      e.preventDefault();
      const text = input.value?.trim();
      if (text) {
        showToast('消息已发送');
        input.value = '';
      } else {
        showToast('请输入问题后再发送', 'loading');
      }
    });

    /* Toast 提示 */
    function showToast(msg, type = 'success') {
      const container = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.textContent = msg;
      container.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(-8px)';
        el.style.transition = 'all 0.25s ease';
        setTimeout(() => el.remove(), 250);
      }, 2200);
    }

    /* 数据弹窗 */
    function showDataModal(title, html) {
      document.getElementById('dataModalTitle').textContent = title;
      document.getElementById('dataModalBody').innerHTML = html;
      document.getElementById('dataModal').classList.add('active');
    }
    function showRemindModal() {
      const html = `
        <div class="report-box" style="margin-bottom: 16px;">
          <strong>设置跟进提醒</strong><br>
          选择提醒时间，系统将在指定时间提醒您查看报告执行效果。
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
          <button class="btn btn-ghost" onclick="closeDataModal(); showToast('已设置 1 天后提醒'); closeReport();">1 天后</button>
          <button class="btn btn-ghost" onclick="closeDataModal(); showToast('已设置 3 天后提醒'); closeReport();">3 天后</button>
          <button class="btn btn-primary" onclick="closeDataModal(); showToast('已设置下周同期提醒'); closeReport();">下周同期</button>
        </div>
      `;
      showDataModal('⏰ 设置下次提醒', html);
    }
    function closeDataModal() {
      document.getElementById('dataModal').classList.remove('active');
    }
    document.getElementById('dataModal')?.addEventListener('click', e => {
      if (e.target.id === 'dataModal') closeDataModal();
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && document.getElementById('dataModal')?.classList.contains('active')) closeDataModal();
    });

    /* 数据弹窗内容模板 */
    const dataModals = {
      '打开销售对账明细表': {
        title: '销售对账明细表',
        html: `
          <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;">
            <div class="kpi-card blue" style="padding: 14px;"><div class="kpi-label">本月对账笔数</div><div class="kpi-value" style="font-size: 18px;">328</div></div>
            <div class="kpi-card green" style="padding: 14px;"><div class="kpi-label">已匹配</div><div class="kpi-value" style="font-size: 18px;">312</div></div>
            <div class="kpi-card orange" style="padding: 14px;"><div class="kpi-label">待处理差异</div><div class="kpi-value" style="font-size: 18px;">2</div></div>
          </div>
          <table class="data-table">
            <tr><th>单据号</th><th>金额</th><th>金蝶金额</th><th>差异</th><th>状态</th></tr>
            <tr><td>CD-20260114</td><td>¥12,580</td><td>¥12,260</td><td style="color: var(--danger);">¥320</td><td>待核对</td></tr>
            <tr><td>CD-20260113</td><td>¥8,920</td><td>¥8,920</td><td>—</td><td style="color: var(--success);">已匹配</td></tr>
            <tr><td>CD-20260112</td><td>¥15,340</td><td>¥15,340</td><td>—</td><td style="color: var(--success);">已匹配</td></tr>
          </table>
        `
      },
      '待审批凭证列表': {
        title: '待审批凭证列表',
        html: `
          <table class="data-table">
            <tr><th>凭证号</th><th>日期</th><th>摘要</th><th>金额</th><th>操作</th></tr>
            <tr><td>PZ-20260115-008</td><td>01-15</td><td>零售应收-微信</td><td>¥1,280</td><td><button class="btn btn-primary" style="padding: 4px 10px;">审批</button></td></tr>
            <tr><td>PZ-20260115-009</td><td>01-15</td><td>加盟管理费</td><td>¥3,500</td><td><button class="btn btn-primary" style="padding: 4px 10px;">审批</button></td></tr>
            <tr><td>PZ-20260114-012</td><td>01-14</td><td>采购应付</td><td>¥8,200</td><td><button class="btn btn-primary" style="padding: 4px 10px;">审批</button></td></tr>
          </table>
          <p style="margin-top: 12px; color: var(--text-muted); font-size: 12px;">共 12 条待审批</p>
        `
      },
      '打开时段报表': {
        title: '时段销售报表 · 近7日',
        html: `
          <table class="data-table">
            <tr><th>时段</th><th>今日客流</th><th>上周同期</th><th>变化</th><th>销售额</th></tr>
            <tr><td>10:00-12:00</td><td>128</td><td>125</td><td style="color: var(--success);">+2.4%</td><td>¥4,280</td></tr>
            <tr><td>12:00-14:00</td><td>156</td><td>162</td><td style="color: var(--warning);">-3.7%</td><td>¥5,120</td></tr>
            <tr><td>14:00-16:00</td><td>89</td><td>105</td><td style="color: var(--danger);">-15.2%</td><td>¥2,890</td></tr>
            <tr><td>16:00-18:00</td><td>112</td><td>118</td><td style="color: var(--warning);">-5.1%</td><td>¥3,650</td></tr>
            <tr><td>18:00-20:00</td><td>134</td><td>132</td><td style="color: var(--success);">+1.5%</td><td>¥4,980</td></tr>
          </table>
        `
      },
      '查看竞品活动': {
        title: '周边竞品活动',
        html: `
          <table class="data-table">
            <tr><th>门店</th><th>活动</th><th>时段</th><th>主推品类</th></tr>
            <tr><td>永辉 · 菜湖店</td><td>叶菜限时 8 折</td><td>14:00-16:00</td><td>叶菜</td></tr>
            <tr><td>盒马 · 江北店</td><td>满 50 减 8</td><td>全天</td><td>全品类</td></tr>
            <tr><td>谊品 · 本店</td><td>—</td><td>—</td><td>—</td></tr>
          </table>
        `
      },
      '生成促销建议单': {
        title: '促销建议单 · 已生成',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            <strong>活动名称：</strong>下午茶买菜 · 叶菜+蛋品组合<br>
            <strong>时段：</strong>14:00-18:00 · 限时4小时<br>
            <strong>组合价：</strong>¥9.9（原价 ¥12.8）
          </div>
          <table class="data-table">
            <tr><th>商品</th><th>原价</th><th>组合价</th><th>预计销量</th></tr>
            <tr><td>小白菜+鸡蛋</td><td>¥12.8</td><td>¥9.9</td><td>80-100 份</td></tr>
            <tr><td>油麦菜+鸡蛋</td><td>¥11.5</td><td>¥8.9</td><td>50-70 份</td></tr>
          </table>
          <p style="margin-top: 12px; color: var(--accent);">预计可拉升 14:00-16:00 客流 8-12%</p>
        `
      },
      '查看竞品活动详情': {
        title: '周边竞品活动',
        html: `
          <table class="data-table">
            <tr><th>门店</th><th>活动</th><th>时段</th><th>主推品类</th></tr>
            <tr><td>永辉 · 菜湖店</td><td>叶菜限时 8 折</td><td>14:00-16:00</td><td>叶菜</td></tr>
            <tr><td>盒马 · 江北店</td><td>满 50 减 8</td><td>全天</td><td>全品类</td></tr>
            <tr><td>谊品 · 本店</td><td>—</td><td>—</td><td>—</td></tr>
          </table>
        `
      },
      '查看活动': {
        title: '蔬菜专区限时 8 折',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            <strong>活动状态：</strong>进行中<br>
            <strong>参与商品：</strong>小白菜、莴苣、油麦菜<br>
            <strong>折扣：</strong>8 折 · 已同步 POS 与小程序
          </div>
          <p style="color: var(--text-muted);">活动创建于 2026-01-30 10:15</p>
        `
      },
      '导出调配表': {
        title: '人力调配表 · 已导出',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            已导出至：<strong>运力调配_20260130.xlsx</strong>
          </div>
          <table class="data-table">
            <tr><th>区域仓</th><th>作业量变化</th><th>分拣人力</th><th>运力</th></tr>
            <tr><td>华东</td><td style="color: var(--danger);">+15%</td><td>+2 人</td><td>+1 车</td></tr>
            <tr><td>华北</td><td style="color: var(--warning);">+8%</td><td>+1 人</td><td>—</td></tr>
            <tr><td>华中</td><td style="color: var(--warning);">+6%</td><td>+1 人</td><td>—</td></tr>
          </table>
        `
      },
      '设置库容预警': {
        title: '库容预警设置',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            已设置预警线：<strong>90%</strong><br>
            当前华东仓库容：<strong>86%</strong>（接近预警）
          </div>
          <table class="data-table">
            <tr><th>区域仓</th><th>当前库容</th><th>预警线</th><th>状态</th></tr>
            <tr><td>华东</td><td>86%</td><td>90%</td><td style="color: var(--warning);">接近</td></tr>
            <tr><td>华南</td><td>62%</td><td>90%</td><td style="color: var(--success);">正常</td></tr>
            <tr><td>华北</td><td>71%</td><td>90%</td><td style="color: var(--success);">正常</td></tr>
          </table>
        `
      },
      '查看周转明细': {
        title: '周转明细 · 菜湖店',
        html: `
          <table class="data-table">
            <tr><th>品类</th><th>周转次数</th><th>动销率</th><th>较上周</th></tr>
            <tr><td>蔬菜</td><td>2.8</td><td>78%</td><td style="color: var(--success);">+0.2</td></tr>
            <tr><td>肉禽</td><td>3.2</td><td>85%</td><td style="color: var(--success);">+0.1</td></tr>
            <tr><td>水果</td><td>2.5</td><td>72%</td><td>持平</td></tr>
            <tr><td>标品</td><td>1.8</td><td>65%</td><td style="color: var(--warning);">-0.1</td></tr>
          </table>
        `
      },
      '生成竞品应对方案': {
        title: '竞品应对方案',
        html: `
          <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
            <li>14:00 前启动促销，抢占客流</li>
            <li>叶菜+蛋品组合价 ¥9.9，对标永辉 8 折</li>
            <li>入口显眼位陈列「下午茶买菜」专区</li>
          </ol>
          <div class="report-box success" style="margin-top: 16px;">
            预计可挽回 14:00-16:00 客流 8-12%
          </div>
        `
      },
      '导出计划': {
        title: '经营改进计划 · 已导出',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            已导出至：<strong>经营改进计划_20260130.pdf</strong>
          </div>
          <p>包含：下午时段促销、陈列调整、滞销处理、下周关注指标</p>
        `
      },
      '生成汰换建议单': {
        title: '汰换建议单',
        html: `
          <table class="data-table">
            <tr><th>商品</th><th>周转</th><th>建议</th></tr>
            <tr><td>西兰花</td><td>1.2 次</td><td style="color: var(--danger);">建议汰换</td></tr>
            <tr><td>油麦菜</td><td>1.8 次</td><td style="color: var(--warning);">先促销</td></tr>
            <tr><td>莴苣</td><td>1.6 次</td><td style="color: var(--warning);">先促销</td></tr>
          </table>
        `
      },
      '生成促销方案': {
        title: '促销方案 · 油麦菜/莴苣',
        html: `
          <table class="data-table">
            <tr><th>商品</th><th>方案</th><th>预计效果</th></tr>
            <tr><td>油麦菜</td><td>与蛋品组合 ¥9.9</td><td>周转提升至 2.2+</td></tr>
            <tr><td>莴苣</td><td>限时 8 折或组合装</td><td>周转提升至 2.2+</td></tr>
          </table>
          <p style="margin-top: 12px; color: var(--text-muted);">建议观察 1 周后再决定是否汰换</p>
        `
      },
      '查看引流案例': {
        title: '引流价案例',
        html: `
          <table class="data-table">
            <tr><th>门店</th><th>商品</th><th>引流价</th><th>效果</th></tr>
            <tr><td>菜湖店</td><td>鸡蛋</td><td>¥0.99/斤</td><td>客流 +15%</td></tr>
            <tr><td>江北店</td><td>小白菜</td><td>¥1.98/斤</td><td>关联销售 +22%</td></tr>
            <tr><td>南坪店</td><td>土豆</td><td>¥1.68/斤</td><td>下午时段 +18%</td></tr>
          </table>
        `
      },
      '查看历史趋势': {
        title: '排骨 · 周内销量趋势',
        html: `
          <table class="data-table">
            <tr><th>星期</th><th>日均销量</th><th>较平日</th></tr>
            <tr><td>周一至周四</td><td>8.2 kg</td><td>—</td></tr>
            <tr><td>周五</td><td>11.5 kg</td><td style="color: var(--success);">+40%</td></tr>
            <tr><td>周六</td><td>14.2 kg</td><td style="color: var(--success);">+73%</td></tr>
            <tr><td>周日</td><td>12.8 kg</td><td style="color: var(--success);">+56%</td></tr>
          </table>
        `
      },
      '生成组合促销方案': {
        title: '小白菜+排骨 组合促销方案',
        html: `
          <div class="report-box success" style="margin-bottom: 16px;">
            <strong>组合：</strong>小白菜 2 斤 + 排骨 1 斤 · ¥28.8（原价 ¥34.2）<br>
            <strong>毛利：</strong>约 22%<br>
            <strong>补货建议：</strong>小白菜 100-140 kg/周，排骨 55-75 kg/周
          </div>
          <p>建议周末重点推广，陈列「家常小炒」专区</p>
        `
      }
    };

    /* 按钮点击交互：数据弹窗 或 Toast */
    document.addEventListener('click', e => {
      const btn = e.target.closest('.btn, .btn-sm, .btn-primary, .btn-ghost, .upload-btn, .select-btn');
      if (!btn) return;
      if (btn.hasAttribute('onclick') && !btn.dataset.toast) return; /* 已有 onclick 的跳过（如 showReport） */
      const toast = btn.dataset.toast || btn.getAttribute('data-toast');
      if (toast) {
        e.preventDefault();
        showToast(toast);
        return;
      }
      const text = (btn.textContent || '').trim();
      /* 数据弹窗：展示表格/列表等数据 */
      const dataModal = dataModals[text];
      if (dataModal && dataModal.html) {
        e.preventDefault();
        showDataModal(dataModal.title, dataModal.html);
        return;
      }
      /* Toast：简单确认 */
      const actionMap = {
        '一键应用修正': '已应用修正',
        '手动修改': '已跳转至修改页',
        '一键发布活动': '活动已发布',
        '修改后再发': '已保存草稿',
        '稍后': '已稍后提醒',
        '确认订单': '订单已确认',
        '修改': '已跳转至修改页',
        '发送调度通知': '调度通知已发送',
        '同步到经营指引': '已同步至经营指引',
        '仅汰换西兰花': '已提交汰换申请',
        '同步定价': '定价已同步',
        '设置引流价': '引流价已设置',
        '同步': '已同步至补货单',
        '批量同步补货': '已批量同步',
        '按周末加量同步': '已按周末加量同步',
        '按组合量同步补货': '已按组合量同步补货',
        '审批': '已提交审批',
        '开始分析': '分析中，请稍候…',
        '上传': '请选择要上传的文件',
        '选择': '请选择日期'
      };
      const msg = actionMap[text];
      if (msg) {
        e.preventDefault();
        showToast(msg);
      }
    });

    /* 对话区发送按钮 */
    document.addEventListener('click', e => {
      const sendBtn = e.target.closest('.chat-input-bar .btn-primary, .chat-input-bar .btn');
      if (!sendBtn) return;
      const inputBar = sendBtn.closest('.chat-input-bar');
      if (!inputBar) return;
      const input = inputBar.querySelector('input');
      const text = input?.value?.trim();
      if (text) {
        showToast('消息已发送');
        input.value = '';
      } else {
        showToast('请输入问题后再发送', 'loading');
      }
    });

    /* 首页初始化（首次加载时） */
    (function() {
      const homePanel = document.getElementById('scene-home');
      if (homePanel && homePanel.classList.contains('active')) {
        if (typeof homeUpdateGreeting === 'function') homeUpdateGreeting();
        if (typeof homeUpdateDate === 'function') homeUpdateDate();
      }
      if (typeof trusteeUpdateModuleBadges === 'function') trusteeUpdateModuleBadges();
    })();
  </script>
</body>
</html>
